(function(A,F){typeof exports=="object"&&typeof module<"u"?F(exports):typeof define=="function"&&define.amd?define(["exports"],F):(A=typeof globalThis<"u"?globalThis:A||self,F(A["paella-core"]={}))})(this,function(A){"use strict";var Vl=(A,F,se)=>{if(!F.has(A))throw TypeError("Cannot "+se)};var q=(A,F,se)=>(Vl(A,F,"read from private field"),se?se.call(A):F.get(A)),ut=(A,F,se)=>{if(F.has(A))throw TypeError("Cannot add the same private member more than once");F instanceof WeakSet?F.add(A):F.set(A,se)},bt=(A,F,se,J)=>(Vl(A,F,"write to private field"),J?J.call(A,se):F.set(A,se),se);var lt,ct,ii,Ct,ye,_e,si;const F=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function se(n,e,t,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(e)||(e=[e]),e.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:t,unregisterOnUnload:i})}),t}function J(n,e,t={}){n.__eventListeners__&&n.__eventListeners__[e]&&n.__eventListeners__[e].forEach(i=>i.callback(t))}function ht(n,e,t={}){n.ready&&J(n,e,t)}function Hl(n){if(n.__eventListeners__)for(const e in n.__eventListeners__)n.__eventListeners__[e]=n.__eventListeners__[e].filter(t=>t.unregisterOnUnload==!1),n.log.debug("Unregister event: "+n.__eventListeners__[e])}function Kn(n){return new Promise((e,t)=>{fetch(n).then(i=>i.text()).then(i=>{e(i)}).catch(i=>t(i))})}function Wn(n){const e=new URLSearchParams(window.location.search);return e.has(n)?e.get(n):null}function Yn(n){const e=window.location.hash.replace("#","?"),t=new URLSearchParams(e);return t.has(n)?t.get(n):null}function Ye(n,e){const t=e||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+t),"")),s!==n.length-1&&(i=i.replace(new RegExp(t+"$"),"")),i)),n.join(t)}function zn(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function ni(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function qn(n){return n.split(".").reduce((e,t,i,s)=>i<s.length-1?e!==""?`${e}.${t}`:t:e,"")}function ji(n){const e=t=>{const i=t.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(t[0]==="/"?`/${i}`:i)+"/"};try{const t=new URL(n);return t.origin+e(t.pathname)}catch{return e(n)}}function Xi(n){return ni(n).split(".").pop()}function Je(n,e){return zn(e)?e:Ye([n.manifestUrl,e])}function jn(n){n.__hideTimerPaused__=!0}function Xn(n){n.__hideTimerPaused__=!1}function Qn(n,e="hideUiTime"){var r;n.__hideTimer__=null;const t=async()=>n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):i()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(r=n.config.ui)!=null&&r.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{t()});const i=()=>{const a=document.activeElement;return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(o=>a.tagName.toLowerCase(o))!==-1},s=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,t()||s()},n[e])};n.containerElement.addEventListener("mousemove",async a=>{s()}),se(n,F.PLAY,async()=>{s()}),se(n,F.PAUSE,async()=>{await n.showUserInterface()}),se(n,F.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{s()})}function Zn(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function wt(n){const e=Math.floor(n/60/60),t=Math.floor(n/60)-e*60,i=Math.floor(n%60);return(e>0?e.toString().padStart(2,"0")+":":"")+t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function ri(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const i=t[1]!==void 0?Number(t[1]):0,s=Number(t[2]),r=Number(t[3]);return i*3600+s*60+r}return null}function Qi(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const i=t[1]!==void 0?Number(t[1]):0,s=Number(t[2]),r=Number(t[3]),a=t[4]&&Number(t[4])||0;return i*36e5+s*6e4+r*1e3+a}return null}function dt(n,e,t=365){let i=new Date;i.setTime(i.getTime()+t*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${e};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function Jn(n,e,t,i,s=365){n.cookieConsent.getConsentForType(e)&&dt(t,i,s)}function et(n){let e=n+"=",i=decodeURIComponent(document.cookie).split(";");for(let s=0;s<i.length;++s){let r=i[s];for(;r.charAt(0)==" ";)r=r.substring(1);if(r.indexOf(e)==0)return r.substring(e.length,r.length)}return""}function Kl(n){const e=et(n),t=Number(e);return e!==""&&!isNaN(t)?t:null}function Wl(n){try{return JSON.parse(et(n))}catch{return null}}function Zi(n,e=!0){return new Promise(t=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>t(i);const s=document.getElementsByTagName("head")[0];e&&s.appendChild(i),t()})}function er(n){document.getElementsByTagName("head")[0].removeChild(n)}function Kt(n,e,t=!0){for(const i in e){const s=n[i];let r=e[i];t&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Kt(a,o,t),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Kt(s,r,t):n[i]=e[i]}}function tr(n,{excludedTags:e=null}={}){const t=document.createElement("div");t.innerHTML=n;const i=["script"];return e&&i.push(...e),i.flatMap(s=>Array.from(t.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),t.innerHTML}let ai=null;function Ji(n){if(!n)return!1;ai||(ai=document.createElement("video"));let e=ai.canPlayType(n);if(e==="maybe"||e==="probably")return!0;if(/video\/mp4/i.test(n))return e=ai.canPlayType("video/mp4"),e==="maybe"||e==="probably"}const Yl=Object.freeze(Object.defineProperty({__proto__:null,clearAutoHideTimer:Zn,getCookie:et,getFileExtension:Xi,getHashParameter:Yn,getJSONCookie:Wl,getNumericCookie:Kl,getUrlFileName:ni,getUrlParameter:Wn,isAbsoluteUrl:zn,joinPath:Ye,loadStyle:Zi,loadSvgIcon:Kn,mergeObjects:Kt,pauseAutoHideUiTimer:jn,removeExtension:qn,removeFileName:ji,resolveResourcePath:Je,resumeAutoHideUiTimer:Xn,sanitizeHTML:tr,secondsToTime:wt,setCookie:dt,setCookieIfAllowed:Jn,setupAutoHideUiTimer:Qn,supportsVideoType:Ji,timeToMilliseconds:Qi,timeToSeconds:ri,unloadStyle:er},Symbol.toStringTag,{value:"Module"}));async function ir(n,e){return e.log.debug("Using default configuration loading function."),(await fetch(n)).json()}async function sr(n,e){return e.log.debug("Using default getVideoId function"),Yn("id")||Wn("id")||n.fallbackId}async function nr(n,e,t,i){return i.log.debug("Using default getManifestUrl function"),Ye([n,e])}async function rr(n,e,t,i){return i.log.debug("Using default getManifestFileUrl function"),Ye([n,e])}async function ar(n,e,t){t.log.debug("Using default loadVideoManifest function");const i=await fetch(n);if(i.ok)return await i.json();throw new Error(t.translate("Error loading video manifest: $1 $2",[i.status,i.statusText]))}class ft{constructor(e){this._player=e}get player(){return this._player}}function es({tag:n="div",attributes:e={},children:t="",innerText:i="",parent:s=null}){const r=document.createElement(n);r.innerText=i;for(let a in e)r.setAttribute(a,e[a]);return r.innerHTML=t,s&&s.appendChild(r),r}function X(n,e=null){const t=document.createElement("div");t.innerHTML=n;const i=t.children[0];return e&&e.appendChild(i),i}class Ne extends ft{constructor(e,{tag:t="div",attributes:i=[],children:s="",parent:r=null}){super(e),this._element=es({tag:t,attributes:i,children:s,parent:r}),Object.defineProperty(this,t,{get:()=>this._element})}get element(){return this._element}get parent(){return this._element.parentElement}hide(){this.element.style.display="none"}show(e="block"){this.element.style.display=null}get isVisible(){const e=window.getComputedStyle(this.element);return e.display!=="none"&&e.display!==""}setAttribute(e,t){this._element.setAttribute(e,t)}removeFromParent(){var e;(e=this._element.parentElement)==null||e.removeChild(this._element)}setParent(e){this.removeFromParent(),e.appendChild(this._element)}}const zl=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1,0,0,1,3,-3.88857)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear1);"/>
    </g>
    <g transform="matrix(-1,1.22465e-16,-1.22465e-16,-1,258,251.914)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear2);"/>
    </g>
    <defs>
        <linearGradient id="_Linear1" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
        <linearGradient id="_Linear2" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
    </defs>
</svg>
`;class or extends Ne{constructor(e){super(e,{parent:e.containerElement}),this.element.className="loader-container"}async create(){X(`<i>${zl}</i>`,this.element)}get debug(){return!1}}const ql=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g id="Cancel" transform="matrix(5.54545,6.8353e-32,6.8353e-32,5.54545,-2567.37,-10735.5)">
        <path d="M486.05,1937C498.192,1937 508.05,1946.86 508.05,1959C508.05,1971.14 498.192,1981 486.05,1981C473.908,1981 464.05,1971.14 464.05,1959C464.05,1946.86 473.908,1937 486.05,1937ZM478.979,1950.52L477.565,1951.93L484.636,1959L477.565,1966.07L478.979,1967.49L486.05,1960.41L493.121,1967.49L494.535,1966.07L487.464,1959L494.535,1951.93L493.121,1950.52L486.05,1957.59L478.979,1950.52Z" style="fill:rgb(210,0,0);"/>
    </g>
</svg>
`;class ts extends Ne{constructor(e,t=""){super(e,{parent:e.containerElement}),this.element.className="error-container",X(`
            <div>
                <i>${ql}</i>
                <p>${t}</p>
            </div>`,this.element)}}class tt extends ft{constructor(e,t){super(e),this._name=t}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var e;return((e=this._config)==null?void 0:e.order)||0}get description(){var e;return((e=this._config)==null?void 0:e.description)||""}get name(){return this._name}async isEnabled(){var e;return(e=this.config)==null?void 0:e.enabled}async load(){}async unload(){}}class gt extends tt{get type(){return"video"}get streamType(){return"mp4"}async isCompatible(){return!1}async getVideoInstance(){return null}getCompatibleFileExtensions(){return[]}getManifestData(e){}}const oi=[];async function jl(n){await we(n,"video",e=>{oi.push(e)})}async function Xl(n){oi.slice(0)}function lr(n){if(oi.length===0)throw Error("No video plugins loaded. Note that `loadVideoPlugins()` must to be called before using `getVideoPlugins()`.");return oi}function Ql(n,e){const t=Xi(e);return lr().find(s=>s.getCompatibleFileExtensions().indexOf(t)!==-1)}async function Zl(n,e){const t=lr();let i=null;for(const s of t)if(await s.isCompatible(e)){i=s;break}return i}async function cr(){return await new Promise(e=>{const t=document.createElement("audio"),i=setTimeout(()=>e(!1),100);t.addEventListener("volumechange",s=>{clearTimeout(i),e(!0)}),t.volume=.5})}class li extends Ne{constructor(e,t,i){const s={class:"video-player"};super(t,{tag:e,attributes:s,parent:i}),this._streamProvider=null,this._streamData=null,this._ready=!1}async isVolumeApiAvailable(){return await cr()}get streamData(){return this._streamData}get ready(){return this._ready}async load(e,t){return this._streamProvider=t,this._streamData=e,await this.loadStreamData(e)}get isMainAudioPlayer(){return this._streamProvider.mainAudioPlayer===this}onVideoEnded(e){this._videoEndedCallback=e}async play(){return!1}async pause(){return!1}async duration(){return-1}get currentTimeSync(){return-1}async currentTime(){return-1}async setCurrentTime(){return!1}async volume(){return-1}async setVolume(){return!1}initVolume(e){this._initialVolume=e}async paused(){return!0}async playbackRate(){return-1}async setPlaybackRate(){return!1}async getQualities(){return null}async setQuality(){return!1}get currentQuality(){return null}async getDimensions(){return null}async supportsMultiaudio(){return!1}async getAudioTracks(){return null}async setCurrentAudioTrack(){}get currentAudioTrack(){return null}async loadStreamData(e){return!1}get isEnabled(){return this._enabled}async enable(){this._enabled=!0}async disable(){this._enabled=!1}}class Wt extends ft{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}}const Yt={name:"paella-core",exports:{".":"./src/js/index.js","./*":"./src/js/*","./paella-core.css":"./dist/paella-core.css"},version:"2.0.0",description:"Multistream HTML video player",main:"./src/js/index.js",files:["dist/paella-core.css"],module:"./src/js/index.js",type:"module",scripts:{dev:"vite",build:"vite build --emptyOutDir"},repository:{type:"git",url:"git+https://github.com/polimediaupv/paella-player.git"},keywords:["html","player","video","hls"],author:"Fernando Serrano Carpena <ferserc1@gmail.com>",license:"ECL-2.0",bugs:{url:"https://github.com/polimediaupv/paella-player/issues"},homepage:"https://github.com/polimediaupv/paella-player#readme",devDependencies:{vite:"^5.0.8"},dependencies:{"@ferserc1/input-style-unifier":"^0.0.1","hls.js":"^1.0.4"}};let is=null;class it extends Wt{static Get(){return is||(is=new it),is}get moduleName(){return"paella-core default video formats"}get moduleVersion(){return Yt.version}}function Jl(n){return new Promise((e,t)=>{const i=new Image;i.addEventListener("load",s=>{e(i)}),i.addEventListener("error",s=>{t(new Error("Could not load preview image. The preview image is required in audio only streams"))}),i.src=n})}function ec(n,e,t){return new Promise((i,s)=>{e.oncanplay=()=>i(),e.onerror=()=>s(new Error(n.translate("Error loading audio: $1",[t]))),e.src=Je(n,t),i()})}class ur extends li{constructor(e,t,i){super("audio",e,t),this.isMainAudio=i,this._ready=!1}get streamType(){return"audio"}waitForLoaded(){return new Promise(e=>{const t=()=>{this._ready?e():setTimeout(t,100)};t()})}async play(){await this.waitForLoaded(),this.audio.play()}async pause(){await this.waitForLoaded(),this.audio.pause()}async duration(){return await this.waitForLoaded(),this.audio.duration}get currentTimeSync(){var e;return((e=this.audio)==null?void 0:e.currentTime)||0}async currentTime(){return await this.waitForLoaded(),this.audio.currentTime}async setCurrentTime(e){await this.waitForLoaded(),this.audio.currentTime=e}async volume(){return await this.waitForLoaded(),this.audio.volume}async setVolume(e){await this.waitForLoaded(),this.audio.volume=e}async paused(){return await this.waitForLoaded(),this.audio.paused}async playbackRate(){return await this.waitForLoaded(),this.audio.playbackRate}async setPlaybackRate(e){await this.waitForLoaded(),this.audio.playbackRate=e}async getDimensions(){return{w:this._previewImage.width,h:this._previewImage.height}}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.audioVideoFormat: loadStreamData");const t=this.player.videoManifest.metadata.preview;if(!t||t==null)throw new Error("Invalid video manifest data: preview image is required");if(this._previewImage=await Jl(t),this._imageContainer=document.createElement("div"),this._imageContainer.className="image-container",this.parent.appendChild(this._imageContainer),this._imageContainer.appendChild(this._previewImage),this._source=e.sources.audio&&e.sources.audio[0],!this._source)throw new Error("Invalid source in audio only video stream");if(!this.isMainAudioPlayer)throw new Error("Audio only video stream must be main audio player. Check the role property at video manifest");await ec(this.player,this.audio,this._source.src);const i=()=>{const s=this.player.videoContainer.baseVideoRect.offsetWidth/this.player.videoContainer.baseVideoRect.offsetHeight,r=this._previewImage.width/this._previewImage.height;s>r?(this._previewImage.classList.add("landscape"),this._previewImage.classList.remove("portrait")):(this._previewImage.classList.add("portrait"),this._previewImage.classList.remove("landscape"))};this.player.frameList.frames.length>0&&this.audio.addEventListener("timeupdate",s=>{const r=this.player.frameList.getImage(s.target.currentTime,!0);this._previewImage.src!=r.url&&(this._previewImage.src=r.url,this._previewImage.onload=()=>i())}),window.addEventListener("resize",s=>i()),i(),this._ready=!0}}class hr extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.audioVideoFormat"}get streamType(){return"audio"}async isCompatible(e){return e.sources.audio!=null}async getVideoInstance(e,t){return new ur(this.player,e,t)}getCompatibleFileExtensions(){return["m4a","mp3"]}getManifestData(e){return{audio:e.map(t=>({src:t}))}}}class ss extends li{constructor(e,t,i,s){super("video",e,t),this._config=s||{};const r=this._config.crossOrigin??"";this.element.setAttribute("playsinline",""),r!==!1&&this.element.setAttribute("crossorigin",r),this.isMainAudio=i,this.element.setAttribute("autoplay",""),this.element.autoplay=!0,i||(this.element.muted=!0),this._videoEnabled=!0}async play(){if(this._videoEnabled)try{return await this.waitForLoaded(),this.video.play()}catch{}else this._disabledProperties.paused=!1}async pause(){if(this._videoEnabled)return await this.waitForLoaded(),this.video.pause();this._disabledProperties.paused=!0}async duration(){return this._videoEnabled?(await this.waitForLoaded(),this.video.duration):this._disabledProperties.duration}get currentTimeSync(){return this._videoEnabled?this.ready?this.video.currentTime:-1:this._disabledProperties.currentTime}async currentTime(){return this._videoEnabled?(await this.waitForLoaded(),this.currentTimeSync):this._disabledProperties.currentTime}async setCurrentTime(e){return this._videoEnabled?(await this.waitForLoaded(),this.video.currentTime=e):(this._disabledProperties.currentTime=e,e)}async volume(){return this._videoEnabled?(await this.waitForLoaded(),this.video.volume):this._disabledProperties.volume}async setVolume(e){return this._videoEnabled?(await this.waitForLoaded(),e===0?this.video.setAttribute("muted",""):this.video.removeAttribute("muted"),this.video.volume=e):(this._disabledProperties.volume=e,e)}async paused(){return this._videoEnabled?(await this.waitForLoaded(),this.video.paused):this._disabledProperties.paused}async playbackRate(){return this._videoEnabled?(await this.waitForLoaded(),await this.video.playbackRate):this._disabledProperties.playbackRate}async setPlaybackRate(e){return this._videoEnabled?(await this.waitForLoaded(),this.video.playbackRate=e):(this._disabledProperties.playbackRate=e,e)}async getQualities(){}async setQuality(){}get currentQuality(){return 0}async getDimensions(){return this._videoEnabled?(await this.waitForLoaded(),{w:this.video.videoWidth,h:this.video.videoHeight}):{w:this._disabledProperties.videoWidth,h:this._disabledProperties.videoHeight}}saveDisabledProperties(e){this._disabledProperties={duration:e.duration,volume:e.volume,videoWidth:e.videoWidth,videoHeight:e.videoHeight,playbackRate:e.playbackRate,paused:e.paused,currentTime:e.currentTime}}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.htmlVideoFormat: loadStreamData"),this._sources=e.sources.html,this._currentQuality=0,this.isMainAudioPlayer||(this.video.muted=!0),this._sources.forEach(({src:t,mimetype:i})=>{t=Je(this.player,t);const s=document.createElement("source");s.src=t,s.type=i,this.video.appendChild(s)}),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.htmlVideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}async clearStreamData(){this.video.src="",this.video.removeEventListener("ended",this._endedCallback),this.video.removeEventListener("loadeddata",this._handleLoadedCallback),this._ready=!1}get isEnabled(){return this._videoEnabled}async enable(){this._videoEnabled=!0}async disable(){return this.isMainAudio?this.player.log.debug("video.disable() - the video is not disabled because it is the main audio source."):this._videoEnabled=!1,this._videoEnabled}waitForLoaded(){return new Promise((e,t)=>{this.video.readyState>=2&&(this._ready=!0),this.ready?e():(this._handleLoadedCallback=i=>{this.video.readyState>=2&&(this.video.pause(),this._ready=!0,e())},this.video.addEventListener("loadeddata",this._handleLoadedCallback))})}}class tc extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.htmlVideoFormat"}get streamType(){return"html"}async isCompatible(e){const{html:t}=e.sources;return t&&t.some(i=>Ji(i.mimetype))}async getVideoInstance(e,t){return new ss(this.player,e,t,this.config)}getCompatibleFileExtensions(){return["m4v","mp4","ogg","webm","ogv"]}getManifestData(e){const t=i=>{switch(Xi(i)){case"mp4":case"m4v":return"video/mp4";case"webm":return"video/webm";case"ogg":case"ogv":return"video/ogg";default:return null}};return{html:e.map(i=>({src:i,mimetype:t(i)}))}}}class mt{constructor({label:e,shortLabel:t,isAuto:i=!1,index:s=0,src:r="",width:a=-1,height:o=-1,bitrate:l=-1}){this._label=e,this._shortLabel=t,this._index=s,this._src=r,this._res={w:a,h:o},this._bitrate=l,this._isAuto=i}get label(){return this._label}get shortLabel(){return this._shortLabel}get index(){return this._index}get src(){return this._src}get res(){return this._res}get bitrate(){return this._bitrate}get isAuto(){return this._isAuto}get quality(){return this._res.w!==-1&&this._res.h!==-1?this._res.w*this._res.h:this._bitrate}compare(e){return e.quality-this.quality}}class ns{constructor({id:e,name:t,groupId:i="",language:s="",selected:r=!1}){this._id=e,this._name=t,this._groupId=i,this._lang=s,this._selected=r}get id(){return this._id}get name(){return this._name}get groupId(){return this._groupId}get language(){return this._lang}get selected(){return this._selected}set selected(e){this._selected=e}}const rs={autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!0,debug:!1,defaultAudioCodec:void 0,initialLiveManifestSize:1,maxBufferLength:6,maxMaxBufferLength:6,maxBufferSize:600*1e3*1e3,maxBufferHole:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:500,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:500,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:500,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,appendErrorMaxRetry:3,enableWebVTT:!0,enableCEA708Captions:!0,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:5,abrEwmaSlowLive:9,abrEwmaFastVoD:4,abrEwmaSlowVoD:15,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,minAutoBitrate:0},dr={withCredentials:!0,requestHeaders:{"Access-Control-Allow-Headers":"Content-Type, Accept, X-Requested-With","Access-Control-Allow-Origin":"http://localhost:8000","Access-Control-Allow-Credentials":"true"}},Te={UNSUPPORTED:0,MEDIA_SOURCE_EXTENSIONS:1,NATIVE:2};let as=null;async function os(){return as||(console.debug("Loading HLS.js"),as=(await Promise.resolve().then(()=>Yg)).default),as}async function ke(n=!1){const e=await os(),t=document.createElement("video");return t.canPlayType("application/vnd.apple.mpegurl")&&n?Te.NATIVE:e.isSupported()?Te.MEDIA_SOURCE_EXTENSIONS:t.canPlayType("application/vnd.apple.mpegurl")?Te.NATIVE:Te.UNSUPPORTED}const ic=async(n,e,t,i,s)=>{var l,c;const r=await os();s.withCredentials&&(i.xhrSetup=function(u,h){u.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];u.setRequestHeader(d,g)}}),i.autoStartLoad=!0;const a=new r(i),o=((c=(l=e==null?void 0:e.sources)==null?void 0:l.hls)==null?void 0:c.length)>0&&e.sources.hls[0];return[a,new Promise((u,h)=>{let d=!1;a.on(r.Events.LEVEL_SWITCHED,(y,v)=>{n.log.debug(`HLS: quality level switched to ${v.level}`),d||(a.currentLevel=-1,d=!0),J(n,F.VIDEO_QUALITY_CHANGED,{})}),a.on(r.Events.ERROR,(y,v)=>{if(v.fatal)switch(v.type){case r.ErrorTypes.NETWORK_ERROR:v.details===r.ErrorDetails.MANIFEST_LOAD_ERROR?h(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),a.startLoad());break;case r.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),a.recoverMediaError();break;default:a.destroy(),h(Error("hlsVideoFormat: Fatal error. Can not recover"))}else n.log.warn("HLS: error"),n.log.warn(v.details)}),a.on(r.Events.LEVEL_SWITCHING,()=>{n.log.debug("HLS media attached")}),a.on(r.Events.MEDIA_ATTACHED,()=>{n.log.debug("HLS media attached")}),a.on(r.Events.MEDIA_DETACHING,()=>{n.log.debug("HLS media detaching")}),a.on(r.Events.MEDIA_DETACHED,()=>{n.log.debug("HLS media detached")}),a.on(r.Events.MANIFEST_PARSED,()=>{n.log.debug("HLS manifest parsed"),a.startLoad(-1)});const g=Math.floor(Math.random()*1e11),f=o.src+(i.enableCache?/\?/.test(o.src)?`&cache=${g}`:`?cache=${g}`:"");a.loadSource(f),a.attachMedia(t);let m=!1;a._videoEventListener=()=>{m=!0,u()},t.addEventListener("canplay",a._videoEventListener),setTimeout(()=>{m||t.play()},1e3)})]};class ls extends ss{constructor(e,t,i,s){super(e,t,s,i),this._config=this._config||{audioTrackLabel:i.audioTrackLabel||"name",enableCache:i.enableCache||!1};for(const r in rs)this._config[r]=rs[r];for(const r in i.hlsConfig)this._config[r]=i.hlsConfig[r];this._cors={};for(const r in dr)this._cors[r]=dr[r];for(const r in i.corsConfig)this._cors[r]=i.corsConfig[r];this._ready=!1,this._autoQuality=!0,this._forceNative=i.forceNative||!1}get autoQuality(){return this._autoQuality}get forceNative(){return this._forceNative}async loadStreamData(e){var i,s;if(await ke(this.forceNative)===Te.NATIVE){e.sources.mp4=e.sources.hls;const r=await super.loadStreamData(e),a=await this.getAudioTracks();return this._currentAudioTrack=a.find(o=>o.selected),this._autoQuality=new mt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality,this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback),r}else{this.player.log.debug("Loading HLS stream");const r=((s=(i=e==null?void 0:e.sources)==null?void 0:i.hls)==null?void 0:s.length)&&e.sources.hls[0];this._config.audioTrackLabel=(r==null?void 0:r.audioLabel)||this._config.audioTrackLabel;const[a,o]=await ic(this.player,e,this.video,this._config,this._cors);this._hls=a,await o,this.video.pause(),this._autoQuality=new mt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const l=await this.getAudioTracks();this._currentAudioTrack=l.find(c=>c.selected),this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback)}}async duration(){var e;if(this._videoEnabled){await this.waitForLoaded();let t=this.video.duration;return t===1/0&&(t=((e=this._hls)==null?void 0:e.liveSyncPosition)||0),t}else return this._disabledProperties.duration}async waitForLoaded(){if(await ke(this.forceNative)===Te.NATIVE)return super.waitForLoaded();await new Promise((t,i)=>{const s=()=>{this.video.readyState>=2?(this._ready=!0,t()):setTimeout(()=>s(),200)};s()})}async getQualities(){const e=[];return e.push(this._autoQuality),await ke(this.forceNative)===Te.MEDIA_SOURCE_EXTENSIONS&&(this._hls.levels.forEach((i,s)=>{e.push(new mt({index:s,label:`${i.width}x${i.height}`,shortLabel:`${i.height}p`,width:i.width,height:i.height}))}),e.sort((i,s)=>i.res.h-s.res.h)),e}async setQuality(e){const t=await ke(this.forceNative);if(this._videoEnabled){if(!(e instanceof mt))throw Error("Invalid parameter setting video quality. VideoQualityItem object expected.");t===Te.MEDIA_SOURCE_EXTENSIONS?(this._currentQuality=e,this._hls.currentLevel=e.index):this.player.log.warn("Could not set video quality of HLS stream, because the HLS support of this browser is native.")}}get currentQuality(){return this._currentQuality}async supportsMultiaudio(){var t;await this.waitForLoaded();const e=await ke(this.forceNative);return e===Te.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.length>1:e===Te.NATIVE?((t=this.video.audioTracks)==null?void 0:t.length)>1:!1}async getAudioTracks(){await this.waitForLoaded();const e=this._config.audioTrackLabel||"name",t=await ke(this.forceNative);return t===Te.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.map(s=>new ns({id:s.id,name:s[e],language:s.lang,selected:this._hls.audioTrack===s.id})):t===Te.NATIVE?Array.from(this.video.audioTracks).map(s=>new ns({id:s.id,name:s.label,language:s.language,selected:s.enabled})):null}async setCurrentAudioTrack(e){await this.waitForLoaded();const i=(await this.getAudioTracks()).find(r=>r.id===e.id),s=await ke(this.forceNative);return s===Te.MEDIA_SOURCE_EXTENSIONS&&i?this._hls.audioTrack=i.id:s===Te.NATIVE&&i&&Array.from(this.video.audioTracks).forEach(r=>{r.id===i.id?r.enabled=!0:r.enabled=!1}),this._currentAudioTrack=i,i}get currentAudioTrack(){return this._currentAudioTrack}async clearStreamData(){this.video.removeEventListener("canplay",this._hls._videoEventListener),this.video.src="",this._hls.destroy(),this._ready=!1}}class fr extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.hlsVideoFormat"}get streamType(){return"hls"}async isCompatible(e){const{hls:t}=e.sources;return t&&await ke()}async getVideoInstance(e,t){return new ls(this.player,e,this.config,t)}getCompatibleFileExtensions(){return["m3u8"]}getManifestData(e){return{hls:e.map(t=>({src:t,mimetype:"video/mp4"}))}}}const sc=async(n,e,t,i,s)=>{var l,c;const r=await os();s.withCredentials&&(i.xhrSetup=function(u,h){u.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];u.setRequestHeader(d,g)}});const a=new r(i),o=((c=(l=e==null?void 0:e.sources)==null?void 0:l.hlsLive)==null?void 0:c.length)>0&&e.sources.hlsLive[0];return i.initialQualityLevel!==void 0&&i.initialQualityLevel,[a,new Promise((u,h)=>{let d=!1;a.on(r.Events.LEVEL_SWITCHED,(m,y)=>{(void 0).player.log.debug(`HLS: quality level switched to ${y.level}`),d||(a.currentLevel=-1,d=!0),J(n,F.VIDEO_QUALITY_CHANGED,{})}),a.on(r.Events.ERROR,(m,y)=>{if(y.fatal)switch(y.type){case r.ErrorTypes.NETWORK_ERROR:y.details===r.ErrorDetails.MANIFEST_LOAD_ERROR?h(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),a.startLoad());break;case r.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),a.recoverMediaError();break;default:a.destroy(),h(Error("hlsVideoFormat: Fatal error. Can not recover"))}}),a.on(r.Events.MANIFEST_PARSED,()=>{i.autoStartLoad||a.autoStartLoad()});const g=Math.floor(Math.random()*1e11),f=o.src+(i.enableCache?/\?/.test(o.src)?`&cache=${g}`:`?cache=${g}`:"");a.loadSource(f),a.attachMedia(t),a._videoEventListener=()=>{u()},t.addEventListener("canplay",a._videoEventListener)})]};class nc extends ls{async loadStreamData(e){if(await ke()===Te.NATIVE)return e.sources.hls=e.sources.hlsLive,super.loadStreamData(e);{this.player.log.debug("Loading HLS stream");const[i,s]=await sc(this.player,e,this.video,this._config,this._cors);this._hls=i,await s,this._autoQuality=new mt({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const r=await this.getAudioTracks();this._currentAudioTrack=r.find(a=>a.selected),this.saveDisabledProperties(this.video)}}}class rc extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.hlsLiveVideoFormat"}get streamType(){return"hlsLive"}async isCompatible(e){const t=await ke(),{hlsLive:i}=e.sources;return i&&t}async getVideoInstance(e,t){return new nc(this.player,e,this.config,t)}}function gr(n){let e=this._currentSource.frames[0];this._currentSource.frames.some(t=>{if(t.time<=this._currentTime)e=t;else return!0}),this.img.src=e.src}function ac(){this._startTimestamp=Date.now();const n=()=>{this._timer=setTimeout(n,250);const e=Date.now(),t=e-this._startTimestamp;this._currentTime+=t/1e3,this._startTimestamp=e,gr.apply(this,[this._currentTime])};n()}function oc(){this._timer&&(clearTimeout(this._timer),this._timer=null)}class mr extends li{constructor(e,t){super("img",e,t),this._currentTime=0,this._startTimesamp=0,this._playbackRate=1,this._timer=null,this.video=this.domElement}async play(){ac.apply(this)}async pause(){oc.apply(this)}async duration(){return this._currentSource.duration}get currentTimeSync(){return this._currentTime}async currentTime(){return this._currentTime}async setCurrentTime(e){this._currentTime=e,gr.apply(this,[e])}async volume(){return 0}async setVolume(e){}async paused(){return this._timer===null}async playbackRate(){return this._playbackRate}async setPlaybackRate(e){this._playbackRate=e}async getQualities(){return this._qualities}async setQuality(){}get currentQuality(){return this._currentQuality}async getDimensions(){return this._currentSource.res}async loadStreamData(e){return this._sources=e.sources.image,this._qualities=this._sources.map(t=>new mt({src:t.frames[0].src,label:`${t.res.w}x${t.res.h}`,shortLabel:`${t.res.h}p`,width:t.res.w,height:t.res.h})),this._currentQuality=this._qualities.length-1,this._qualities.forEach((t,i)=>{this._qualities[this._currentQuality].compare(t)>0&&(this._currentQuality=i)}),this._currentSource=this._sources[this._currentQuality],this._sources.forEach(t=>{t.frames.sort((i,s)=>i.time-s.time)}),!0}}class pr extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.imageVideoFormat"}get streamType(){return"image"}async isCompatible(e){return e.sources.image!=null}async getVideoInstance(e,t){return new mr(this.player,e,this.config,t)}}class yr extends ss{constructor(e,t,i,s){super(e,t,i,s)}async loadStreamData(e=null){this._streamData=this._streamData||e,this.player.log.debug("es.upv.paella.mp4VideoFormat: loadStreamData"),this._currentSource||(this._sources=null,this._currentQuality=0,this._sources=e.sources.mp4,this._sources.sort((t,i)=>Number(t.res.w)-Number(i.res.w)),this._currentQuality=this._sources.length-1,this._currentSource=this._sources[this._currentQuality]),this.isMainAudioPlayer||(this.video.muted=!0),this._initialVolume&&(this.video.volume=this._initialVolume,this._initialVolume===0&&(this.video.muted=!0)),this.video.src=Je(this.player,this._currentSource.src),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.mp4VideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}}class vr extends gt{getPluginModuleInstance(){return it.Get()}get name(){return super.name||"es.upv.paella.mp4VideoFormat"}get streamType(){return"mp4"}isCompatible(e){var i;const{mp4:t}=e.sources;return t&&Ji((i=t[0])==null?void 0:i.mimetype)}async getVideoInstance(e,t){return new yr(this.player,e,t,this.config)}getCompatibleFileExtensions(){return["m4v","mp4"]}getManifestData(e){return{mp4:e.map(t=>({src:t,mimetype:"video/mp4"}))}}}const ci=n=>{var e,t,i;return`alt:${((e=n.keyModifiers)==null?void 0:e.altKey)||!1}, ctrl:${((t=n.keyModifiers)==null?void 0:t.ctrlKey)||!1}, shift:${((i=n.keyModifiers)==null?void 0:i.shiftKey)||!1}`},lc=n=>`${n.keyCode}_${ci(n)}`,cc=n=>{n.keyModifiers=n.keyModifiers||{},n.keyModifiers.altKey=n.keyModifiers.altKey||!1,n.keyModifiers.shiftKey=n.keyModifiers.shiftKey||!1,n.keyModifiers.ctrlKey=n.keyModifiers.ctrlKey||!1},Er=n=>{const e=[];for(const t in n.__shortcuts__)n.__shortcuts__[t].forEach(s=>{s.disabled||e.push(s)});return e};async function uc(n){if(n.__shortcuts__=n.__shortcuts__||{},!window.__paella_shortcuts_player__)window.__paella_shortcuts_player__=n;else{n.log.warn("Warning: more than one paella player instance with enabled shortcut plugins."),n.log.warn("Check your code to ensure that only one instance of paella player registers keyboard shortcut plugins.");return}await we(n,"keyshortcut",async e=>{(await e.getKeys()).forEach(s=>{n.__shortcuts__[s.keyCode]=n.__shortcuts__[s.keyCode]||[],s.plugin=e,n.__shortcuts__[s.keyCode].push(s)});const i=await e.getDictionaries();for(const s in i){const r=i[s];n.addDictionary(s,r)}for(const s in n.__shortcuts__){const r=n.__shortcuts__[s],a={};r.length>0&&r.forEach(o=>{const l=lc(o);if(cc(o),!a[l])a[l]=o;else{n.log.warn(`Collision detected in shortcut for key code ${s}`);const c=a[l];n.log.warn("Enabled shortcut:"),n.log.warn(`plugin: ${c.plugin.name}, keyCode: ${c.keyCode}, modifiers: ${ci(c)}, description: ${c.description}`),n.log.warn("Collision shortcut (disabled):"),n.log.warn(`plugin: ${o.plugin.name}, keyCode: ${o.keyCode}, modifiers: ${ci(o)}, description: ${o.description}`),o.disabled=!0}})}}),n.__paella_key_event_listener__=async e=>{var a,o;const t=()=>document.activeElement&&document.activeElement!==document.body&&!/video/i.test(document.activeElement.tagName);if(!n.containerElement.contains(document.activeElement)&&document.activeElement!==document.body)return;const i=document.activeElement;if(/input/i.test(i.tagName)&&/range/i.test(i.type)&&/Arrow/i.test(e.code)||(((a=n.config.accessibility)==null?void 0:a.clickWithSpacebar)!==void 0?(o=n.config.accessibility)==null?void 0:o.clickWithSpacebar:!0)&&e.code==="Space"&&t())return;const r=n.__shortcuts__[e.code];r&&await r.forEach(async l=>{var d,g,f,m,y,v;const c=!((d=l.keyModifiers)!=null&&d.altKey)||((g=l.keyModifiers)==null?void 0:g.altKey)&&e.altKey,u=!((f=l.keyModifiers)!=null&&f.ctrlKey)||((m=l.keyModifiers)==null?void 0:m.ctrlKey)&&e.ctrlKey,h=!((y=l.keyModifiers)!=null&&y.shiftKey)||((v=l.keyModifiers)==null?void 0:v.shiftKey)&&e.shiftKey;c&&u&&h&&!l.disabled?await l.action(e):c&&u&&h&&l.disabled&&(n.log.warn("Shortcut not triggered due to collision:"),n.log.warn(`plugin: ${l.plugin.name}, keyCode: ${l.keyCode}, modifiers: ${ci(l)}, description: ${l.description}`))})},window.addEventListener("keyup",n.__paella_key_event_listener__)}async function hc(n){delete n.__shortcuts__,n==window.__paella_shortcuts_player__&&(window.removeEventListener("keyup",n.__paella_key_event_listener__),delete window.__paella_key_event_listener__,delete window.__paella_shortcuts_player__)}const Le={Digit1:"Digit1",Digit2:"Digit2",Digit3:"Digit3",Digit4:"Digit4",Digit5:"Digit5",Digit6:"Digit6",Digit7:"Digit7",Digit8:"Digit8",Digit9:"Digit9",Digit0:"Digit0",KeyA:"KeyA",KeyB:"KeyB",KeyC:"KeyC",KeyD:"KeyD",KeyE:"KeyE",KeyF:"KeyF",KeyG:"KeyG",KeyH:"KeyH",KeyI:"KeyI",KeyJ:"KeyJ",KeyK:"KeyK",KeyL:"KeyL",KeyM:"KeyM",KeyN:"KeyN",KeyO:"KeyO",KeyP:"KeyP",KeyQ:"KeyQ",KeyR:"KeyR",KeyS:"KeyS",KeyT:"KeyT",KeyU:"KeyU",KeyV:"KeyV",KeyW:"KeyW",KeyX:"KeyX",KeyY:"KeyY",KeyZ:"KeyZ",Comma:"Comma",Period:"Period",Semicolon:"Semicolon",Quote:"Quote",BracketLeft:"BracketLeft",BracketRight:"BracketRight",Backquote:"Backquote",Backslash:"Backslash",Minus:"Minus",Equal:"Equal",AltLeft:"AltLeft",AltRight:"AltRight",CapsLock:"CapsLock",ControlLeft:"ControlLeft",ControlRight:"ControlRight",OSLeft:"OSLeft",OSRight:"OSRight",ShiftLeft:"ShiftLeft",ShiftRight:"ShiftRight",ContextMenu:"ContextMenu",Enter:"Enter",Space:"Space",Tab:"Tab",Delete:"Delete",End:"End",Help:"Help",Home:"Home",Insert:"Insert",PageDown:"PageDown",PageUp:"PageUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",ArrowUp:"ArrowUp",Escape:"Escape",PrintScreen:"PrintScreen",ScrollLock:"ScrollLock",Pause:"Pause"};class Tr extends tt{get type(){return"keyshortcut"}async getKeys(){return[]}async getDictionaries(){return{}}}const Ee=Object.freeze({TOP_LEFT:"topLeft",TOP_MIDDLE:"topMiddle",TOP_RIGHT:"topRight",CENTER_LEFT:"centerLeft",CENTER_MIDDLE:"centerMiddle",CENTER_RIGHT:"centerRight",BOTTOM_LEFT:"bottomLeft",BOTTOM_MIDDLE:"bottomMiddle",BOTTOM_RIGHT:"bottomRight"}),ze=(n,e,t,i,s)=>{i=i||"",t=t||1e3;const r=X(`
        <div class="message-content ${i}">
            ${n?`<i class="icon">${n}</i>`:""}
            ${e?`<p class="text">${e}</p>`:""}
        </div>
    `);return s.innerHTML="",s.appendChild(r),s.timer&&(clearTimeout(s.timer),s.timer=null),s.timer=setTimeout(()=>{s.removeChild(r)},t),r};class dc extends Ne{constructor(e,t){const i={class:"video-container-message"};super(e,{attributes:i,parent:t}),this._topLeftContainer=X('<div class="container top-left"></div>',this.element),this._topMiddleContainer=X('<div class="container top-middle"></div>',this.element),this._topRightContainer=X('<div class="container top-right"></div>',this.element),this._centerLeftContainer=X('<div class="container center-left"></div>',this.element),this._centerMiddleContainer=X('<div class="container center-middle"></div>',this.element),this._centerRightContainer=X('<div class="container center-right"></div>',this.element),this._bottomLeftContainer=X('<div class="container bottom-left"></div>',this.element),this._bottomMiddleContainer=X('<div class="container bottom-middle"></div>',this.element),this._bottomRightContainer=X('<div class="container bottom-right"></div>',this.element)}show({icon:e=null,text:t="",timeout:i=1e3,position:s=Ee.CENTER_MIDDLE,cssClass:r=""}){switch(s){case Ee.TOP_LEFT:ze.apply(this,[e,t,i,r,this._topLeftContainer]);break;case Ee.TOP_MIDDLE:ze.apply(this,[e,t,i,r,this._topMiddleContainer]);break;case Ee.TOP_RIGHT:ze.apply(this,[e,t,i,r,this._topRightContainer]);break;case Ee.CENTER_LEFT:ze.apply(this,[e,t,i,r,this._centerLeftContainer]);break;case Ee.CENTER_MIDDLE:ze.apply(this,[e,t,i,r,this._centerMiddleContainer]);break;case Ee.CENTER_RIGHT:ze.apply(this,[e,t,i,r,this._centerRightContainer]);break;case Ee.BOTTOM_LEFT:ze.apply(this,[e,t,i,r,this._bottomLeftContainer]);break;case Ee.BOTTOM_MIDDLE:ze.apply(this,[e,t,i,r,this._bottomMiddleContainer]);break;case Ee.BOTTOM_RIGHT:ze.apply(this,[e,t,i,r,this._bottomRightContainer]);break}}}const fc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mute" serif:id="volume mute" transform="matrix(1,0,0,1,-123,-4.71142)">
        <path d="M142,28.522L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L127.478,14L142,28.522ZM151.228,34.983L123,6.756L125.044,4.711L132.848,12.516L139.68,5C140.961,5 142,6.039 142,7.32L142,21.667L153.272,32.939L151.228,34.983Z"/>
    </g>
</svg>
`,gc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-low" serif:id="volume low" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
</svg>
`,mc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mid" serif:id="volume mid" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1.79727,0,0,1.79727,-145.137,-17.5434)">
                <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
</svg>
`,pc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 34 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g transform="matrix(1,0,0,1,-164.25,-6)">
        <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(1.79727,0,0,1.79727,-310.137,-22.5434)">
        <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(2.44245,0,0,2.44245,-427.303,-35.9308)">
        <path d="M184.199,14.815C184.625,14.866 186.828,16.03 187.775,17.801C189.443,20.92 187.935,25.329 184.388,26.637C184.388,26.637 183.459,26.646 183.677,26.009C183.808,25.624 184.344,25.578 184.77,25.344C187.184,24.016 188.202,20.604 186.8,18.153C186.181,17.07 185.166,16.228 183.988,15.807C183.988,15.807 183.242,14.787 184.199,14.815Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(1,0,0,1,-125,-5)">
        <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
    </g>
</svg>
`,z=Object.freeze({UNLOADED:0,LOADING_MANIFEST:1,MANIFEST:2,LOADING_PLAYER:3,LOADED:4,UNLOADING_MANIFEST:5,UNLOADING_PLAYER:6,ERROR:7});let cs=null;class pt extends Wt{static Get(){return cs||(cs=new pt),cs}get moduleName(){return"paella-core default plugins"}get moduleVersion(){return Yt.version}}class Sr extends Tr{getPluginModuleInstance(){return pt.Get()}get name(){return super.name||"es.upv.paella.defaultShortcuts"}getVolumeIcon(e){return e===0?this.player.getCustomPluginIcon(this.name,"volumeMuteIcon")||fc:e<.3?this.player.getCustomPluginIcon(this.name,"volumeLowIcon")||gc:e<.6?this.player.getCustomPluginIcon(this.name,"volumeMidIcon")||mc:this.player.getCustomPluginIcon(this.name,"volumeHighIcon")||pc}toggleCaptions(){var e,t,i;if(((i=(t=(e=this.player)==null?void 0:e.captionsCanvas)==null?void 0:t.captions)==null?void 0:i.length)>0)if(this.player.captionsCanvas.isVisible)this.player.captionsCanvas.disableCaptions();else{let s=null;navigator.languages.some(r=>this.player.captionsCanvas.captions.some((a,o)=>r==a.language?(s=o,!0):!1)),this.player.captionsCanvas.enableCaptions({index:s||0})}}async togglePlayPause(){await this.player.paused()?await this.player.play():await this.player.pause()}async toggleFullscreen(){this.player.isFullscreen?await this.player.exitFullscreen():await this.player.enterFullscreen()}async seek(e){const t=await this.player.videoContainer.streamProvider.currentTime();await this.player.videoContainer.streamProvider.setCurrentTime(t+e),e<0?this.player.videoContainer.message.show({text:`<< ${Math.abs(e)}s`,position:Ee.CENTER_LEFT,timeout:500}):this.player.videoContainer.message.show({text:`${e}s >>`,position:Ee.CENTER_RIGHT,timeout:500})}async incrementVolume(e){const t=await this.player.videoContainer.streamProvider.volume(),i=Math.min(Math.max(0,t+e*.01),1);await this.player.videoContainer.setVolume(i);const s=this.getVolumeIcon(i);this.player.videoContainer.message.show({text:`${Math.round(i*100)}%`,position:Ee.CENTER_MIDDLE,icon:s})}closePopUp(){}async decreaseSpeed(){const e=await this.player.videoContainer.playbackRate();let t=0;this._validPlaybackRates.some(i=>{if(t===0&&(t=i),i<e)t=i;else return!0}),await this.player.videoContainer.setPlaybackRate(t),this.player.videoContainer.message.show({text:`${t}X`,position:Ee.CENTER_MIDDLE})}async increaseSpeed(){const e=await this.player.videoContainer.playbackRate();let t=0;this._validPlaybackRates.some(i=>{if(i>e)return t=i,!0}),t===0&&(t=this._validPlaybackRates[this._validPlaybackRates.length-1]),await this.player.videoContainer.setPlaybackRate(t),this.player.videoContainer.message.show({text:`${t}X`,position:Ee.CENTER_MIDDLE})}async toggleVolume(){const e=await this.player.videoContainer.volume();let t=0;e>0?(this._lastVolume=e,t=0):t=this._lastVolume||1,await this.player.videoContainer.setVolume(t);const i=this.getVolumeIcon(t);this.player.videoContainer.message.show({text:`volume: ${Math.round(t*100)}%`,position:Ee.CENTER_MIDDLE,icon:i})}async load(){this._validPlaybackRates=this.config.validPlaybackRates||[.75,1,1.5,2],this._validPlaybackRates.sort((e,t)=>e-t)}async getKeys(){const e=this.player,t=this.config.skipBackwards||30,i=this.config.skipForward||30,s=()=>e.state===z.LOADED;return[{keyCode:Le.KeyM,description:"Toggle audio mute",keyModifiers:{ctrlKey:!1},action:async()=>{s()&&await this.toggleVolume()}},{keyCode:Le.KeyK,description:"Toggle play/pause",action:async()=>{await this.togglePlayPause()}},{keyCode:Le.KeyJ,get description(){return e.translate("Rewind $1 seconds",[t])},action:async()=>{s()&&await this.seek(-t)}},{keyCode:Le.KeyL,get description(){return e.translate("Forward $1 seconds",[i])},action:async()=>{s()&&await this.seek(i)}},{keyCode:Le.Space,description:"Toggle play/pause",action:async()=>{s()&&await this.togglePlayPause()}},{keyCode:Le.KeyF,description:"Toggle fullscreen",action:async()=>{s()&&await this.toggleFullscreen()}},{keyCode:Le.KeyC,description:"Toggle captions",action:async()=>{s()&&this.toggleCaptions()}},{keyCode:Le.ArrowLeft,get description(){return e.translate("Rewind $1 seconds",[t])},action:async()=>{s()&&await this.seek(-t)}},{keyCode:Le.ArrowRight,get description(){return e.translate("Forward $1 seconds",[i])},action:async()=>{s()&&await this.seek(i)}},{keyCode:Le.ArrowUp,description:"Volume up 10%",action:async()=>{s()&&this.incrementVolume(10)}},{keyCode:Le.ArrowDown,description:"Volume down 10%",action:async()=>{s()&&this.incrementVolume(-10)}},{keyCode:Le.Escape,description:"Close pop-up",action:async()=>{s()&&this.closePopUp()}},{keyCode:Le.KeyU,description:"Decrease playback speed",action:async()=>{s()&&await this.decreaseSpeed()}},{keyCode:Le.KeyO,description:"Increase playback speed",action:async()=>{s()&&this.increaseSpeed()}}]}}async function yc(n){const e=[];await we(n,"captions",async t=>{e.push(t)});for(let t in e){const s=await e[t].getCaptions(),r=n.captionsCanvas;s.forEach(a=>r.addCaptions(a))}}class us extends tt{get type(){return"captions"}async load(){this.player.log.debug("load captions plugin")}async getCaptions(){return this.player.log.warn(`CaptionsPlugin ${this.name}: getCaptions() is not implemented.`),[]}}class hs{get cues(){return this._cues}get label(){return this._label}get language(){return this._lang}set label(e){this._label=e}set language(e){this._lang=e}constructor(e="",t=""){this._cues=[],this._label=e,this._lang=t}addCue({label:e="",start:t,end:i,captions:s}){const r={label:e};if(typeof s=="string")r.captions=[s];else if(Array.isArray(s))r.captions=s;else throw Error("Invalid cue caption format: must be an array of strings or a string");if(typeof t=="string")r.start=ri(t),r.startString=t;else if(typeof t=="number")r.start=t,r.startString=wt(t);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");if(typeof i=="string")r.end=ri(i),r.endString=i;else if(typeof i=="number")r.end=i,r.endString=wt(i);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");return this._cues.push(r),r}getCue(e){if(typeof e=="string")e=ri(e);else if(typeof e!="number")throw Error("Invalid time instant format getting cue");let t=null;return this._cues.some(i=>{if(e>=i.start&&e<=i.end)return t=i,!0}),t}}function ds(n,e){const t={},s=new DOMParser().parseFromString(e,"text/xml");return Array.from(s.getElementsByTagName("div")).forEach(r=>{const a=r.getAttribute("xml:lang")||"unknonw";t[a]=t[a]||new hs(n.translate(a),a),Array.from(r.getElementsByTagName("p")).forEach(o=>{const l=Qi(o.getAttribute("begin"));t[a].addCue({label:`caption_${o.getAttribute("xml:id")||l}`,start:l/1e3,end:Qi(o.getAttribute("end"))/1e3,captions:o.innerHTML})})}),t}class Lr{constructor(e,t=""){this.player=e,this._text=t,this._captions=ds(this.player,t)}get text(){return this._text}set text(e){this._text=e,this._captions=ds(e)}get captions(){return this._captions}}class xr extends us{getPluginModuleInstance(){return pt.Get()}get name(){return super.name||"es.upv.paella.dfxpManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const e=[],t=[];return this.player.videoManifest.captions.forEach(i=>{t.push(new Promise(async(s,r)=>{if(/dfxp/i.test(i.format)){const a=Je(this.player,i.url),o=await fetch(a);if(o.ok){let l=await o.text();l=l.replace(/[^\x09\x0A\x0D\x20-\xFF\x85\xA0-\uD7FF\uE000-\uFDCF\uFDE0-\uFFFD]/gm,""),l=l.replace(/&\w+;/gmi,""),l=l.replaceAll("<br>","");const c=new Lr(this.player,l);Object.entries(c.captions).forEach(([u,h])=>{e.push(h)}),s()}else r()}else r()}))}),await Promise.allSettled(t),e}}class ui extends tt{constructor(e,t,i){super(e,t,i),this.__uiPlugin=!0}async getDictionaries(){return null}}let fs="en",_r="";const At={};function gs(n){const e=At[fs]||{},t=At[_r]||{};return e[n]||t[n]||n}function ms(n){fs=n}function ps(){return fs}function ys(n,e){At[n]=At[n]||{};for(const t in e){const i=e[t];At[n][t]=i}}function vs(){return At}function Es(n){return n.config.defaultLanguage||navigator.language}let Cr=gs,br=ms,wr=ps,Ar=ys,Rr=vs,Ir=Es;function Rt(n,e=null){const t=Cr(n);if(Array.isArray(e)){let i=t;return e.forEach((s,r)=>{const a=`$${r+1}`;i=i.replace(a,s)}),i}else return t}function Ts(n){br(n)}function Dr(){return wr()}function It(n,e){Ar(n,e)}function Pr(){return Rr()}function Ss(n){return Ir(n)}function vc(n){Cr=n}function Ec(n){br=n}function Tc(n){wr=n}function Sc(n){Ar=n}function Lc(n){Rr=n}function xc(n){Ir=n}function _c(n){_r=Ss(n)}function Ls(n){return n.__tabIndex=n.__tabIndex||0,++n.__tabIndex,n.__tabIndex}function Cc(n){return n.__tabIndex||0}async function hi(n,e){var c,u;const t=X("<li></li>",e);t.plugin=n;const i=n.tabIndex,s=Rt(n.ariaLabel),r=Rt(n.description),a=n.dynamicWidth?"dynamic-width":"fixed-width",o=n.id?`id="${n.id}" `:"",l=n.buttonName?`name="${n.buttonName}" `:"";if(n.interactive){const h=X(`
			<button type="button" ${o}${l}class="${a}" tabindex="${i}" aria-label="${s}" title="${r}">
			</button>
		`,t);n.className!==""&&h.classList.add(n.className),n._button=h,n._container=t,h._pluginData=n,t._pluginData=n,h.addEventListener("click",v=>{const E=h._pluginData;J(E.player,F.BUTTON_PRESS,{plugin:E}),E.action(v,null),v.stopPropagation(),v.pageX!==0&&v.pageY!==0&&document.activeElement.blur()});let d=null;const g=()=>{d&&(clearTimeout(d),d=null)},f=()=>{g(),d=setTimeout(()=>{n.leftSideContainerPresent&&n.leftSideContainer.classList.add("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.add("hidden"),d=null},300)},m=()=>{g(),n.leftSideContainerPresent&&n.leftSideContainer.classList.remove("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.remove("hidden")};h.addEventListener("focus",m),h.addEventListener("mouseover",m),h.addEventListener("mouseout",f),h.addEventListener("blur",f),(((c=n.player.config.accessibility)==null?void 0:c.clickWithSpacebar)!==void 0?(u=n.player.config.accessibility)==null?void 0:u.clickWithSpacebar:!0)||(h.addEventListener("keyup",v=>{v.keyCode==32&&v.preventDefault()}),h.addEventListener("keydown",v=>{v.keyCode==32&&v.preventDefault()})),n.className!==""&&h.classList.add(n.className)}else{const h=X(`
			<div ${o}${l} class="non-interactive ${a}" title="${r}">
			</div>
		`,t);n._button=h,n._container=t,h._pluginData=n,t._pluginData=n,n.className!==""&&h.classList.add(n.className)}}const kr=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};class bc{onIconChanged(e,t,i){}onTitleChanged(e,t,i){}onStateChanged(e,t,i,s,r){}}class di extends ui{constructor(){super(...arguments);ut(this,lt,null);ut(this,ct,null);ut(this,ii,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return Ls(this.player)}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof bc)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){var i;if(typeof t=="string"&&(t=tr(t)),this._icon=t,t&&this._button instanceof HTMLElement){const s=this._button.querySelector("i")||X("<i></i>",this._button);s.innerHTML=t}else if(this._button instanceof HTMLElement){const s=this._button.querySelector("i");s&&this._button.removeChild(s)}(i=this._observer)!=null&&i.onIconChanged&&this._observer.onIconChanged(this,this._icon,t)}get title(){return this._title||""}set title(t){var i;if(this._title=t,t&&this._button instanceof HTMLElement){const s=this._button.querySelector("span")||X(`<span class="button-title-${this.titleSize}"></span>`,this._button);s.innerHTML=t}else if(this._button instanceof HTMLElement){const s=this._button.querySelector("span");s&&this._button.removeChild(s)}(i=this._observer)!=null&&i.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var i;return((i=this.config)==null?void 0:i.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var i;return((i=this.config)==null?void 0:i.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return q(this,lt)||(bt(this,lt,kr()),this.container.appendChild(q(this,lt))),q(this,lt)}get leftSideContainerPresent(){return q(this,lt)!==null}get rightSideContainer(){return q(this,ct)||(bt(this,ct,kr()),this.container.appendChild(q(this,ct))),q(this,ct)}get rightSideContainerPresent(){return q(this,ct)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:i=null}={}){var a,o;const s=this._statusText,r=this._statusIcon;this._statusText=t,this._statusIcon=i,q(this,ii).forEach(l=>l(this)),this._statusIcon&&(this.icon=this._statusIcon),this._statusText&&(this.title=this._statusText),(o=(a=this._observer)==null?void 0:a.onStateChanged)==null||o.call(a,this,s,t,r,i)}onStateChange(t){typeof t=="function"?q(this,ii).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,i=null){this.player.log.warn(`Action not implemented in button plugin ${this.name}`)}onResize({width:t,height:i}){t<this.minContainerSize?this.hide():this.show()}}lt=new WeakMap,ct=new WeakMap,ii=new WeakMap;const wc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 23 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="play" transform="matrix(1.36051e-16,0.480277,-0.550439,1.55927e-16,74.9184,-144.269)">
        <path d="M325.373,94.327L350.358,136.107L300.387,136.107L325.373,94.327Z"/>
    </g>
</svg>
`,Ac=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 24 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="pause" transform="matrix(1,0,0,0.956522,-48,-7.65217)">
        <path d="M64,8L72,8L72,31L64,31L64,8ZM48,8L56,8L56,31L48,31L48,8Z"/>
    </g>
</svg>
`,Rc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 42" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1.94013e-16,0.689169,-0.784942,2.23746e-16,110.436,-203.562)">
        <g id="play">
            <path d="M304.588,115.214C304.588,105.205 313.901,97.079 325.373,97.079C336.844,97.079 346.157,105.205 346.157,115.214C346.157,125.223 336.844,133.349 325.373,133.349L325.373,128.287C333.642,128.287 340.356,122.43 340.356,115.214C340.356,107.999 333.642,102.141 325.373,102.141C317.103,102.141 310.39,107.999 310.39,115.214L304.588,115.214Z"/>
            <g transform="matrix(-2.33361,-6.00363e-16,1.21708e-15,-2.59724,320.246,134.358)">
                <path d="M5.454,3.35L9.398,7.505L1.511,7.505L5.454,3.35Z"/>
            </g>
        </g>
    </g>
</svg>
`;class Fr extends di{getPluginModuleInstance(){return pt.Get()}get name(){return super.name||"es.upv.paella.playPauseButton"}async load(){const e=this.player.getCustomPluginIcon(this.name,"play")||wc,t=this.player.getCustomPluginIcon(this.name,"pause")||Ac,i=this.player.getCustomPluginIcon(this.name,"replay")||Rc;this.icon=e,se(this.player,F.PLAY,()=>{this.icon=t}),se(this.player,F.PAUSE,()=>{this.icon=e}),se(this.player,F.ENDED,()=>{this.icon=i}),se(this.player,F.STOP,()=>{this.icon=e})}async action(){await this.player.paused()?await this.player.videoContainer.play():await this.player.videoContainer.pause()}}const Mr="(?:\\d*:){1,2}\\d*(?:\\.\\d+)?",Ic=`(${Mr})\\s*\\-\\->\\s*(${Mr})`,Dc={cueTiming:new RegExp(Ic)},Pc=(n,e,t,i)=>{const s=Dc.cueTiming.exec(e);if(s){const r=i[t-1],a=[];for(let o=1;t+o<i.length&&i[t+o]!=="";++o)a.push(i[t+o]);n.addCue({label:r,start:s[1],end:s[2],captions:a})}};function xs(n){const e=new hs;return n!==""&&(n=n.replace(/\r\n/gm,`
`),n=n.replace(/\r/gm,`
`),n.split(/\n/).forEach((t,i,s)=>{Pc(e,t,i,s)})),e}class Or{constructor(e=""){this._text=e,this._captions=xs(e)}get text(){return this._text}set text(e){this._text=e,this._captions=xs(e)}get captions(){return this._captions}}class Nr extends us{getPluginModuleInstance(){return pt.Get()}get name(){return super.name||"es.upv.paella.vttManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const e=[],t=[];return this.player.videoManifest.captions.forEach(i=>{t.push(new Promise(async(s,r)=>{if(/vtt/i.test(i.format)){const a=Je(this.player,i.url),o=await fetch(a);if(o.ok){const l=await o.text(),c=new Or(l);c.captions.label=i.text,c.captions.language=i.lang,e.push(c.captions),s()}else r()}else r()}))}),await Promise.allSettled(t),e}}class Ur extends di{getPluginModuleInstance(){return pt.Get()}get name(){return"es.upv.paella.currentTimeLabel"}async load(){this.title=wt(0);const e=async()=>{const t=await this.player.videoContainer.currentTime();let i=wt(t);if(this.config.showTotalTime){const s=await this.player.videoContainer.duration();i+=`/${wt(s)}`}this.title=i};this.player.bindEvent(F.TIMEUPDATE,()=>e()),this.player.bindEvent(F.TRIMMING_CHANGED,()=>e()),this.player.bindEvent(F.SEEK,()=>e())}get interactive(){return!1}get dynamicWidth(){return!0}}function fi(n,e){return Us(n,"layout").filter(i=>i.config&&i.config.enabled&&i.canApply(e))}function Br(n,e){const t=fi(n,e),i=[];return t.forEach(s=>{i.push(...s.getValidContentIds(e))}),i}function kc(n,e){const t=[];return Us(n,"layout").filter(i=>{var s,r;if((s=i.config)!=null&&s.enabled&&((r=i.config)!=null&&r.validContent))return i.config.validContent.every(a=>a.content.length===e)}).forEach(i=>i.config.validContent.forEach(s=>t.push(s.content))),t}function $r(n,e,t){const i=fi(n,e);let s=null;return i.some(r=>{if(r.getValidContentIds(e).indexOf(t)!==-1)return s=r,!0}),s}function Fc(n,e){const t=fi(n,e),i=Br(n,e);let s=[];return t.forEach(r=>{s=[...s,...r.config.validContent]}),s.filter(r=>i.indexOf(r.id)!==-1)}function Gr(n,e,t,i=null){const s=$r(n,e,t);if(s){const r=s.getLayoutStructure(e,t,i);return r.plugin=s,r}return null}class yt extends ui{get type(){return"layout"}get layoutType(){return"static"}getTabIndexStart(){return 10}get tabIndexStart(){var e;return((e=this.config)==null?void 0:e.tabIndexStart)||this.getTabIndexStart()}get identifier(){return"default"}get icon(){return"icon.png"}get validContent(){var e;return((e=this.config)==null?void 0:e.validContent)||[]}get validContentIds(){const e=[];return this.validContent.forEach(t=>e.push(t.id)),e}getValidContentIds(e){const t=[];return this.validContent.forEach(i=>{i.content.every(s=>e.some(r=>s===r.content))&&t.push(i.id)}),t}getValidStreams(e){const t=[];return this.validContent.forEach(i=>{let s=[];i.content.every(r=>e.some(a=>{if(r===a.content)return s.push(a),!0}))&&t.push(s)}),t}canApply(e){return this.getValidStreams(e).length>0}getLayoutStructure(){return{}}getVideoCanvasButtons(e,t,i){return[]}}function Mc(n){return{icon:n.icon,position:n.position,title:n.description,ariaLabel:n.ariaLabel,name:n.buttonName,click:async e=>{const t=n.player.videoContainer.streamProvider.streams[e];await n.action(e,t==null?void 0:t.player,t==null?void 0:t.canvas,t==null?void 0:t.canvasPlugin)}}}async function Oc(n,e){const t=[];return await we(n,"canvasButton",async i=>{n.log.debug(` Canvas button plugin: ${i.name}`),t.push(i)}),t.filter(i=>i.content.indexOf(e.content)!==-1).map(i=>Mc(i))}class Nc extends ui{get type(){return"canvasButton"}get content(){return this._config.content||["presenter"]}get ariaLabel(){return this._config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return Ls(this.player)}get description(){return this.config.description||this.getDescription()}getDescription(){return""}get icon(){return this._icon}set icon(e){this._icon=e}get side(){var e;return((e=this.config)==null?void 0:e.side)||"left"}get buttonName(){return this.name}get position(){switch(this.side){case"left":return re.LEFT;case"center":return re.CENTER;case"right":return re.RIGHT;default:throw new Error(`Invalid CanvasButtonPlugin side set: ${this.side}`)}}async action(e){this.player.log.warn(`Action not implemented in canvas button plugin ${this.name}`)}}const _s=[];async function Uc(n){await we(n,"canvas",e=>{_s.push(e)})}async function Bc(n){}function $c(n,e){if(_s.length===0)throw Error("No canvas plugins loaded. Note that `loadCanvasPlugins()` must to be called before use `getCanvasPlugins()`");let t=null;return _s.some(i=>{if(i.isCompatible(e))return t=i,!0}),t}const re=Object.freeze({LEFT:"left",CENTER:"center",RIGHT:"right"}),Gc=function({icon:n,tabIndex:e,ariaLabel:t,title:i,className:s,position:r=re.CENTER,click:a,content:o,name:l}){if(!n)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'icon' attribute.");if(!a)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'click' function.");let c=`class="align-${r}${s?" "+s:""}"`;t&&(c+=` aria-label="${t}"`),i&&(c+=` title="${i}"`),e!==void 0&&(c+=` tabindex="${e}"`),l!==void 0&&(c+=` name="${l}"`);const u=X(`
        <button ${c}><i class="button-icon" style="pointer-events: none">${n}</i></button>
    `);return this.buttonsArea.appendChild(u),u.addEventListener("click",async h=>(await a(o),h.stopPropagation(),!1)),u},Cs=async(n,e,t,i,s)=>{const r=e.plugin;let a=r.tabIndexStart;const o=await Oc(n,i),l=[];return[...o,...r.getVideoCanvasButtons(e,i.content,i,t)].forEach(u=>{u.tabIndex=a++,u.content=s;const h=Gc.apply(t,[u]);l.push(h)}),l},bs=(n,e,t)=>{let{tabIndexStart:i}=e.plugin;t.sort((s,r)=>{const a=s.getBoundingClientRect().left,o=r.getBoundingClientRect().left;return a-o}).forEach(s=>{s.setAttribute("tabindex",i++)})};class ws extends Ne{constructor(e,t,i){super(t,{tag:e,parent:i}),this.element.className="video-canvas",this._userArea=null,this._buttonsArea=X(`
        <div class="button-area">
        </div>
        `,this.element)}async loadCanvas(e){throw Error(`${this.name}: loadCanvas() not implemented`)}get userArea(){return this._userArea||(this._userArea=document.createElement("div"),this._userArea.className="user-area",this.element.appendChild(this._userArea)),this._userArea}get buttonsArea(){return this._buttonsArea}showButtons(){this.buttonsArea.style.display=null}hideButtons(){this.buttonsArea.style.display="none"}}class As extends tt{get type(){return"canvas"}get canvasType(){return""}isCompatible(e){return Array.isArray(e==null?void 0:e.canvas)?e.canvas.indexOf(this.canvasType)!==-1:e.canvas===this.canvasType}getCanvasInstance(e){throw Error(`${this.name} canvas plugin: getCanvasInstance() not implemented`)}}let Rs=null;class st extends Wt{static Get(){return Rs||(Rs=new st),Rs}get moduleName(){return"paella-core default video layouts"}get moduleVersion(){return Yt.version}}const Is=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.920758,0,0,0.920758,2.50561,1.21236)">
        <path d="M11.937,17.699L11.937,21.044C11.937,21.656 11.573,22.209 11.012,22.451C10.45,22.693 9.798,22.578 9.354,22.158L1.874,15.1C1.568,14.811 1.394,14.408 1.394,13.986C1.394,13.564 1.568,13.161 1.874,12.872L9.354,5.814C9.798,5.394 10.45,5.279 11.012,5.521C11.573,5.763 11.937,6.316 11.937,6.928L11.937,10.272L22.937,10.272C23.783,10.272 24.469,10.958 24.469,11.804L24.469,16.168C24.469,17.014 23.783,17.699 22.937,17.699L11.937,17.699ZM26.063,23.11L26.063,19.765C26.063,19.153 26.427,18.6 26.988,18.358C27.55,18.116 28.201,18.231 28.646,18.651L36.126,25.709C36.432,25.999 36.606,26.402 36.606,26.823C36.606,27.245 36.432,27.648 36.126,27.937L28.646,34.996C28.201,35.415 27.55,35.53 26.988,35.288C26.427,35.046 26.063,34.493 26.063,33.882L26.063,30.537L15.063,30.537C14.217,30.537 13.531,29.851 13.531,29.005L13.531,24.641C13.531,23.795 14.217,23.11 15.063,23.11L26.063,23.11Z"/>
    </g>
</svg>
`,gi=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <path d="M-20.625,8.591C-20.625,6.174 -17.975,4.215 -14.704,4.215L31.492,4.215C34.763,4.215 37.413,6.174 37.413,8.591L37.413,35.582C37.413,37.998 34.763,39.957 31.492,39.957L-14.704,39.957C-17.975,39.957 -20.625,37.998 -20.625,35.582L-20.625,8.591ZM1.285,12.825L8.1,7.789L-15.786,7.789L-15.786,25.442L-8.972,20.406L6.737,32.016L16.994,24.435L1.285,12.825Z" />
    </g>
</svg>
`,zt=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.707107,0.707107,-0.707107,0.707107,20,-8.28427)">
        <path d="M23,17L23,4.998C23,4.203 22.684,3.44 22.122,2.878C21.56,2.316 20.797,2 20.002,2C20.001,2 19.999,2 19.998,2C19.203,2 18.44,2.316 17.878,2.878C17.316,3.44 17,4.203 17,4.998C17,9.375 17,17 17,17L4.998,17C4.203,17 3.44,17.316 2.878,17.878C2.316,18.44 2,19.203 2,19.998C2,19.999 2,20.001 2,20.002C2,20.797 2.316,21.56 2.878,22.122C3.44,22.684 4.203,23 4.998,23C9.375,23 17,23 17,23L17,35.002C17,35.797 17.316,36.56 17.878,37.122C18.44,37.684 19.203,38 19.998,38C19.999,38 20.001,38 20.002,38C20.797,38 21.56,37.684 22.122,37.122C22.684,36.56 23,35.797 23,35.002C23,30.625 23,23 23,23L35.002,23C35.797,23 36.56,22.684 37.122,22.122C37.684,21.56 38,20.797 38,20.002C38,20.001 38,19.999 38,19.998C38,19.203 37.684,18.44 37.122,17.878C36.56,17.316 35.797,17 35.002,17C30.625,17 23,17 23,17Z"/>
    </g>
</svg>`,qt=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g>
        <path d="M18,13.029L18,26.971C18,27.509 17.786,28.025 17.406,28.406C17.025,28.786 16.509,29 15.971,29L3.029,29C2.491,29 1.975,28.786 1.594,28.406C1.214,28.025 1,27.509 1,26.971L1,13.029C1,12.491 1.214,11.975 1.594,11.594C1.975,11.214 2.491,11 3.029,11L15.971,11C16.509,11 17.025,11.214 17.406,11.594C17.786,11.975 18,12.491 18,13.029ZM39,13.029L39,26.971C39,27.509 38.786,28.025 38.406,28.406C38.025,28.786 37.509,29 36.971,29L24.029,29C23.491,29 22.975,28.786 22.594,28.406C22.214,28.025 22,27.509 22,26.971L22,13.029C22,12.491 22.214,11.975 22.594,11.594C22.975,11.214 23.491,11 24.029,11L36.971,11C37.509,11 38.025,11.214 38.406,11.594C38.786,11.975 39,12.491 39,13.029ZM21,7L21,33L19,33L19,7L21,7Z"/>
    </g>
</svg>
`,Vc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.19142,40.6376,-0.550686)">
            <path d="M38.001,14.89L16.256,14.89C15.767,14.89 15.297,15.084 14.951,15.43C14.605,15.776 14.41,16.246 14.41,16.735C14.41,21.528 14.41,33.999 14.41,33.999L5.673,33.999C3.644,33.999 2,32.355 2,30.327L2,7.673C2,5.644 3.644,4 5.673,4L34.329,4C36.358,4 38.001,5.644 38.001,7.673L38.001,14.89Z"/>
        </g>
        <g transform="matrix(-1.62701,0,0,1.19712,41.1319,-0.602464)">
            <path d="M39.174,17.858C39.174,17.501 39.032,17.158 38.781,16.906C38.529,16.653 38.188,16.511 37.833,16.511C33.587,16.511 20.516,16.511 17.043,16.511C16.816,16.511 16.598,16.602 16.438,16.763C16.278,16.924 16.188,17.142 16.188,17.37C16.188,20.366 16.188,30.369 16.188,34.019C16.188,34.376 16.329,34.719 16.581,34.971C16.832,35.224 17.173,35.366 17.529,35.366C21.597,35.366 33.765,35.366 37.833,35.366C38.188,35.366 38.529,35.224 38.781,34.971C39.032,34.719 39.174,34.376 39.174,34.019C39.174,30.548 39.174,21.329 39.174,17.858Z"/>
        </g>
    </g>
</svg>
`;class Ds extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.pipContentIds=this.config.pipContentIds||[],this.allowSwitchSide=this.config.allowSwitchSide!==void 0?this.config.allowSwitchSide:!0}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconMaximize")||gi,a=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||qt,o=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Is,l=this.player.getCustomPluginIcon(this.name,"iconClose")||zt,c=this.player.getCustomPluginIcon(this.name,"iconPiP")||Vc,u=()=>this._currentContent.find(f=>f.id===t),h=()=>u().size===25,d=()=>u().size>50,g=[];return h()||d()?g.push({icon:a,position:re.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{this._currentContent.forEach(f=>{f.size=50}),await this.player.videoContainer.updateLayout()}}):g.push({icon:r,position:re.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this._currentContent.forEach(f=>{f.size=f.id===t?75:25}),await this.player.videoContainer.updateLayout()}}),this.allowSwitchSide&&g.push({icon:o,position:re.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{const f=this._currentContent[0].id,m=this._currentContent[1].id,y=this._currentContent[0].size,v=this._currentContent[1].size;this._currentContent[0].id=m,this._currentContent[0].size=v,this._currentContent[1].id=f,this._currentContent[1].size=y,await this.player.videoContainer.updateLayout()}}),g.push({icon:l,position:re.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const m=this.player.videoContainer.validContentIds.filter(y=>y.indexOf("-")===-1).find(y=>y!=t);await this.player.videoContainer.setLayout(m)}}),this.pipContentIds.length>0&&g.push({icon:c,position:re.LEFT,title:this.player.translate("Picture-in-picture"),ariaLabel:this.player.translate("Picture-in-picture"),name:this.name+":iconPiP",click:async()=>{const f=this.player.videoContainer.validContentIds.find(m=>this.pipContentIds.indexOf(m)!==-1);await this.player.videoContainer.setLayout(f,t)}}),g}getLayoutStructure(e,t,i){if(!this._currentContent){const{content:s}=this.validContent.find(r=>r.id===t);this._currentContent=s.map(r=>({id:r,size:50}))}return{id:"dual-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size},{content:this._currentContent[1].id,visible:!0,size:this._currentContent[1].size}]}}}const Vr=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.50139,0,0,1.10483,39.8625,1.72153)">
            <path d="M22.034,28.802C22.58,28.752 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.04,34.063 22.034,34.123L22.034,40.015L13,31.5L22.034,23.015L22.034,28.802Z" />
        </g>
        <g transform="matrix(1.50139,1.35303e-16,1.83867e-16,-1.10483,-24.8768,44.5033)">
            <path d="M22.161,28.786C22.706,28.736 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.167,34.048 22.161,34.107L22.161,40L13,31.5L22.161,23L22.161,28.786Z" />
        </g>
    </g>
</svg>
`,Hc=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.25099,40.6376,0.938594)">
            <path d="M26,18.498C26,16.566 24.356,15 22.327,15C17.811,15 10.189,15 5.673,15C3.644,15 2,16.566 2,18.498C2,22.151 2,27.849 2,31.502C2,33.434 3.644,35 5.673,35C10.189,35 17.811,35 22.327,35C24.356,35 26,33.434 26,31.502C26,27.849 26,22.151 26,18.498Z" />
        </g>
        <path d="M-2.889,42.341L-16.002,42.341C-17.664,42.341 -19.01,41.345 -19.01,40.117L-19.01,11.346L-15.787,13.728L-15.787,36.879C-15.787,37.695 -15.348,38.478 -14.567,39.056C-13.785,39.633 -12.726,39.958 -11.621,39.958L-2.889,39.958L-2.889,42.341ZM30.962,18.512L30.962,8.485C30.962,7.669 30.523,6.886 29.741,6.308C28.96,5.731 27.9,5.406 26.795,5.406L-4.721,5.406L-7.945,3.024L31.181,3.024C32.842,3.024 34.189,4.019 34.189,5.247L34.189,18.512L30.962,18.512Z" />
        <g transform="matrix(-0.595969,-0.440448,-1.13993,0.842464,17.4661,11.4472)">
            <path d="M18.389,14.006L18.389,18L5,11L18.389,4L18.389,7.994L36,7.994L36,14.006L18.389,14.006Z" />
        </g>
    </g>
</svg>
`;let Ue=0;const Ps=[{id:"side-by-side",videos:[{content:null,rect:[{aspectRatio:"16/9",width:560,height:315,top:218,left:712},{aspectRatio:"16/10",width:560,height:350,top:206,left:712},{aspectRatio:"4/3",width:560,height:420,top:173,left:712},{aspectRatio:"5/3",width:560,height:336,top:206,left:712},{aspectRatio:"5/4",width:560,height:448,top:160,left:712}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",width:688,height:387,top:166,left:10},{aspectRatio:"16/10",width:688,height:430,top:148,left:10},{aspectRatio:"4/3",width:688,height:516,top:111,left:10},{aspectRatio:"5/3",width:690,height:414,top:154,left:10},{aspectRatio:"5/4",width:690,height:552,top:96,left:10}],visible:!0,layer:"1"}],buttons:[]},{id:"pip-left",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]},{id:"pip-right",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]}];function Kc(n){return Ue=(Ue+1)%Ps.length,ks(n)}function jt(n,e){return Ue=e<Ps.length?e:Ue,ks(n)}function ks(n){let e=JSON.parse(JSON.stringify(Ps[Ue]));return e.videos[0].content=n[0],e.videos[1].content=n[1],e}class Hr extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideo"}get identifier(){return"dual-video"}async load(){let e=et("dualVideoLayoutIndex");e!==""&&(Ue=Number(e)),this.player.log.debug("Dual video layout loaded")}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===2)}switchContent(){const e=this._currentContent[0],t=this._currentContent[1];this._currentContent[0]=t,this._currentContent[1]=e,this.player.videoContainer.updateLayout()}async switchMinimized(){Kc(this._currentContent),await this.player.videoContainer.updateLayout()}async minimizeVideo(e){let t=!0;if(e===this._currentContent[0]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,t=!1}Ue===1&&t?jt(this._currentContent,2):jt(this._currentContent,1),await this.player.videoContainer.updateLayout()}async maximizeVideo(e){let t=!0;if(e===this._currentContent[1]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,t=!1}Ue===1&&t?jt(this._currentContent,2):jt(this._currentContent,1),await this.player.videoContainer.updateLayout()}async setSideBySide(){jt(this._currentContent,0),await this.player.videoContainer.updateLayout()}get minimizedContent(){return Ue===0?"":this._currentContent[1]}async closeVideo(e){const i=this.player.videoContainer.validContentIds.filter(s=>s.indexOf("-")===-1).find(s=>s!=e);await this.player.videoContainer.setLayout(i)}getVideoCanvasButtons(e,t,i,s){if(e.id==="side-by-side")return[{icon:this.player.getCustomPluginIcon(this.name,"iconRotate")||Vr,position:re.LEFT,title:this.player.translate("Swap position of the videos"),ariaLabel:this.player.translate("Swap position of the videos"),name:this.name+":iconRotate",click:async()=>{await this.switchContent()}},{icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||gi,position:re.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.maximizeVideo(t)}},{icon:this.player.getCustomPluginIcon(this.name,"iconClose")||zt,position:re.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}}];{const r=[];return t===this.minimizedContent?(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||gi,position:re.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Is,position:re.LEFT,title:this.player.translate("Place the video on the other side of the screen"),ariaLabel:this.player.translate("Place the video on the other side of the screen"),name:this.name+":iconSwitchSide",click:async()=>{await this.minimizeVideo(t)}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||zt,position:re.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}})):(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMinimize")||Hc,position:re.LEFT,title:this.player.translate("Minimize video"),ariaLabel:this.player.translate("Minimize video"),name:this.name+":iconMinimize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||qt,position:re.LEFT,title:this.player.translate("Put the videos side by side"),ariaLabel:this.player.translate("Put the videos side by side"),name:this.name+":iconSideBySide",click:async()=>{await this.setSideBySide()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||zt,position:re.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(t)}})),r}}getLayoutStructure(e,t){if(!this._currentContent||this._currentContentId!==t){const{content:r}=this.validContent.find(l=>l.id===t);this._currentContent=r,this._currentContentId=t;const a=et("dualVideoLayoutContent0"),o=et("dualVideoLayoutContent1");a!==""&&o!==""&&this._currentContent.indexOf(a)!==-1&&this._currentContent.indexOf(o)!==-1&&(this._currentContent[0]=a,this._currentContent[1]=o)}const i=ks(this._currentContent),s={id:i.id,player:this.player,name:{es:"Dos streams con posicin dinmica"},hidden:!1,videos:i.videos,buttons:[]};return dt("dualVideoLayoutIndex",Ue),dt("dualVideoLayoutContent0",this._currentContent[0]),dt("dualVideoLayoutContent1",this._currentContent[1]),s}}const Kr={id:"pip-left",name:{es:"Dos streams imagen dentro de imagen"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:617,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262},{aspectRatio:"9/16",left:224,top:301,width:224,height:400}],visible:!0,layer:2}],buttons:[]},Wc={id:"pip-right",name:{es:"Dos streams imagen dentro de imagen a la derecha"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:242,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262},{aspectRatio:"9/16",left:887,top:304,width:224,height:400}],visible:!0,layer:2}],buttons:[]};class Yc extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.dualVideoPiP"}get identifier(){return"dual-video-pip"}async load(){this._currentLayout=Kr,this.dualVideoContentIds=this.config.dualVideoContentIds||[]}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===2)}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconClose")||zt,a=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Is,o=this.player.getCustomPluginIcon(this.name,"iconMaximize")||gi,l=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||qt,c=[{icon:r,position:re.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const h=this.player.videoContainer.validContentIds.filter(d=>d.indexOf("-")===-1).find(d=>d!==t);await this.player.videoContainer.setLayout(h)}}];return t===this._pipVideo?(c.push({icon:a,position:re.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{this.switchSide(),await this.player.videoContainer.updateLayout(this._fullVideo)}}),c.push({icon:o,position:re.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this.switchSources(),await this.player.videoContainer.updateLayout(this._fullVideo)}})):this.dualVideoContentIds.length>0&&c.push({icon:l,position:re.LEFT,title:this.player.translate("Set side by side"),ariaLabel:this.player.translate("Set side by side"),name:this.name+":iconSideBySide",click:async()=>{const u=this.player.videoContainer.validContentIds,h=this.dualVideoContentIds.find(d=>u.indexOf(d)!==-1);h&&this.player.videoContainer.setLayout(h)}}),c}switchSide(){this._currentLayout.id==="pip-left"?this._currentLayout=Wc:this._currentLayout=Kr}switchSources(){const e=this._pipVideo;this._pipVideo=this._fullVideo,this._fullVideo=e}getLayoutStructure(e,t,i){const{content:s}=this.validContent.find(a=>a.id===t);i&&s.find(a=>a===i)?(this._fullVideo=i,this._pipVideo=s.find(a=>a!==i)):(!this._pipVideo||!this._fullVideo)&&(this._pipVideo=s[0],this._fullVideo=s[1]);const r=JSON.parse(JSON.stringify(this._currentLayout));return r.player=this.player,r.videos[0].content=this._fullVideo,r.videos[1].content=this._pipVideo,r}}class Wr extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.singleVideo"}get identifier(){return"single-video"}async load(){this.player.log.debug("Single video layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===1)}getVideoCanvasButtons(e,t,i,s){return this._multiStream?[{icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||qt,position:re.LEFT,title:this.player.translate("Two videos 50%"),ariaLabel:this.player.translate("Two videos 50%"),name:this.name+":iconSideBySide",click:()=>{const r=this.player.videoContainer.validContentIds,a=this.dualVideoContentIds.find(o=>r.indexOf(o)!==-1);a&&this.player.videoContainer.setLayout(a)}}]:[]}getLayoutStructure(e,t){const i=this.validContent.find(r=>r.id===t),s={player:this.player,name:{es:"One stream"},hidden:!1,videos:[{content:i.content[0],rect:[{aspectRatio:"1/1",left:280,top:0,width:720,height:720},{aspectRatio:"6/5",left:208,top:0,width:864,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"11/8",left:145,top:0,width:990,height:720},{aspectRatio:"1.41/1",left:132,top:0,width:1015,height:720},{aspectRatio:"1.43/1",left:125,top:0,width:1029,height:720},{aspectRatio:"3/2",left:100,top:0,width:1080,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"1.85/1",left:0,top:14,width:1280,height:692},{aspectRatio:"2.35/1",left:0,top:87,width:1280,height:544},{aspectRatio:"2.41/1",left:0,top:94,width:1280,height:531},{aspectRatio:"2.76/1",left:0,top:128,width:1280,height:463}],visible:!0,layer:1}],background:{content:"slide_professor_paella.jpg",zIndex:5,rect:{left:0,top:0,width:1280,height:720},visible:!0,layer:0},logos:[{content:"paella_logo.png",zIndex:5,rect:{top:10,left:10,width:49,height:42}}],buttons:[],onApply:function(){}};return e.length>1&&(this._multiStream=!0),s}}class zc extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.singleVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.player.log.debug("Single video dynamic layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getVideoCanvasButtons(e,t,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||qt,a=[];return this._multiStream&&a.push({icon:r,position:re.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{const o=this.player.videoContainer.validContentIds,l=this.dualVideoContentIds.find(c=>o.indexOf(c)!==-1);l&&this.player.videoContainer.setLayout(l)}}),a}getLayoutStructure(e,t,i){e.length>1&&(this._multiStream=!0);const{content:s}=this.validContent.find(r=>r.id===t);return this._currentContent=s.map(r=>({id:r,size:50})),{id:"single-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size}]}}}const qc={videos:[{content:{},rect:[{aspectRatio:"16/9",left:239,top:17,width:803,height:451}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:44,top:482,width:389,height:218}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:847,top:482,width:389,height:218}],visible:!0,layer:1}],buttons:[{rect:{left:618,top:495,width:45,height:45},onClick:function(n){this.rotate()},label:"Rotate",icon:"icon_rotate.svg",layer:2}]};function jc(n){let e=JSON.parse(JSON.stringify(qc));return e.videos[0].content=n[0],e.videos[1].content=n[1],e.videos[2].content=n[2],e}class Yr extends yt{getPluginModuleInstance(){return st.Get()}get name(){return super.name||"es.upv.paella.tripleVideo"}get identifier(){return"triple-video"}async load(){this.player.log.debug("Triple video layout loaded")}getValidStreams(e){return super.getValidStreams(e).filter(t=>t.length===3)}switchContent(){const e=this._currentContent[0],t=this._currentContent[1],i=this._currentContent[2];this._currentContent[0]=i,this._currentContent[1]=e,this._currentContent[2]=t,this.player.videoContainer.updateLayout()}getLayoutStructure(e,t){if(!this._currentContent||this._currentContentId!==t){this._currentContentId=t;const{content:r}=this.validContent.find(a=>a.id===t);this._currentContent=r}const i=jc(this._currentContent);return{player:this.player,name:{es:"Three streams with dynamic position"},hidden:!1,videos:i.videos,buttons:[{rect:i.buttons[0].rect,onClick:()=>{this.switchContent()},label:"Switch",icon:Vr,layer:2,ariaLabel:"Swap the position of the videos",title:"Swap the position of the videos"}]}}}class Xc extends ws{constructor(e,t){super("div",e,t),this.element.classList.add("image-canvas")}async loadCanvas(e){e.element.style.width="100%",e.element.style.height="100%"}}class Qc extends As{get name(){return super.name||"es.upv.paella.audioCanvas"}get canvasType(){return"audio"}getCanvasInstance(e){return new Xc(this.player,e)}}class zr extends ws{constructor(e,t){super("div",e,t)}async loadCanvas(e){e.element.style.width="100%",e.element.style.height="100%"}}class qr extends As{get name(){return super.name||"es.upv.paella.videoCanvas"}get canvasType(){return"video"}async isCompatible(e){return!Array.isArray(e.canvas)||e.canvas.length===0?!0:await super.isCompatible(e)}getCanvasInstance(e){return new zr(this.player,e)}}class Fs extends tt{get type(){return"data"}get context(){return this.config.context||[]}async read(){throw Error(`DataPlugin.read() not implemented in data plugin '${this.name}'`)}async write(){throw Error(`DataPlugin.write() not implemented in data plugin '${this.name}'`)}async remove(){throw Error(`DataPlugin.remove() not implemented in data plugin '${this.name}'`)}}class jr extends ft{constructor(e){super(e),this._dataPlugins={},we(this.player,"data",async t=>{var i;(i=t.context)==null||i.forEach(s=>{this._dataPlugins[s]=this._dataPlugins[s]||[],this._dataPlugins[s].push(t)})})}getDataPlugin(e){let t=this._dataPlugins[e]&&this._dataPlugins[e].length>0&&this._dataPlugins[e][0];if(t||(t=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default[0]),!t)throw Error(`No data plugin found for context '${e}'`);return t}getDataPlugins(e){let t=this._dataPlugins[e]&&this._dataPlugins[e].length>0&&this._dataPlugins[e];if(t||(t=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default),!t)throw Error(`No data plugin found for context '${e}'`);return t}async read(e,t){return await this.getDataPlugin(e).read(e,t)}async write(e,t,i){const s=this.getDataPlugins(e);if(Array.isArray(s)){let r=null;for(let a=0;a<s.length;++a)r=await s[a].write(e,t,i);return r}else{if(s)return await s.write(e,t,i);this.player.log.warn(`No such data plugin found for context '${e}'`)}}async remove(e,t){const i=this.getDataPlugins(e);if(i.length>1){let s=null;for(let r=0;r<i.length;++r)s=await i[r].remove(e,t);return s}else return await i.remove(e,t)}}let Ms=null;class mi extends Wt{static Get(){return Ms||(Ms=new mi),Ms}get moduleName(){return"paella-core default data plugins"}get moduleVersion(){return Yt.version}}class Zc extends Fs{getPluginModuleInstance(){return mi.Get()}get name(){return super.name||"es.upv.paella.cookieDataPlugin"}serializeKey(e,t){return typeof t=="object"&&(t=JSON.stringify(t)),`${e}|${t}`}async read(e,t){const i=this.serializeKey(e,t);let s=et(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`CookieDataPlugin.read: ${i}`),s}async write(e,t,i){const s=this.serializeKey(e,t);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`CookieDataPlugin.write: ${s}: invalid data object.`),i=""}dt(s,i),this.player.log.debug(`CookieDataPlugin.write: ${s}`)}async remove(e,t){const i=this.serializeKey(e,t);dt(i,""),this.player.log.debug(`CookieDataPlugin.remove: ${i}`)}}class Jc extends Fs{getPluginModuleInstance(){return mi.Get()}get name(){return super.name||"es.upv.paella.localStorageDataPlugin"}serializeKey(e,t){return typeof t=="object"&&(t=JSON.stringify(t)),`${e}|${t}`}async read(e,t){const i=this.serializeKey(e,t);let s=localStorage.getItem(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`LocalStorageDataPlugin.read: ${i}`),s}async write(e,t,i){const s=this.serializeKey(e,t);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`LocalStorageDataPlugin.write: ${s}: invalid data object.`),i=""}localStorage.setItem(s,i),this.player.log.debug(`LocalStorageDataPlugin.write: ${s}`)}async remove(e,t){const i=this.serializeKey(e,t);localStorage.setItem(i,""),this.player.log.debug(`LocalStorageDataPlugin.remove: ${i}`)}}const eu=[{plugin:hr,config:{enabled:!1}},{plugin:fr,config:{enabled:!1}},{plugin:rc,config:{enabled:!1}},{plugin:tc,config:{enabled:!1}},{plugin:pr,config:{enabled:!1}},{plugin:vr,config:{enabled:!1}},{plugin:Sr,config:{enabled:!1}},{plugin:xr,config:{enabled:!1}},{plugin:Fr,config:{enabled:!1}},{plugin:Nr,config:{enabled:!1}},{plugin:Ur,config:{enabled:!1}},{plugin:Ds,config:{enabled:!1}},{plugin:Hr,config:{enabled:!1}},{plugin:Yc,config:{enabled:!1}},{plugin:Wr,config:{enabled:!1}},{plugin:zc,config:{enabled:!1}},{plugin:Ds,config:{enabled:!1}},{plugin:Yr,config:{enabled:!1}},{plugin:Qc,config:{enabled:!1}},{plugin:qr,config:{enabled:!1}},{plugin:Zc,config:{enabled:!1,context:["default"]}},{plugin:Jc,config:{enable:!0,context:["default"]}}];class Xr extends di{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(e){this._refreshContent=e}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(e,t){this.parentPopUp=t,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(e){this._parentPopUp=e}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var i,s;const e=((i=this.config.closeActions)==null?void 0:i.clickOutside)??!0,t=((s=this.config.closeActions)==null?void 0:s.closeButton)??!1;return{clickOutside:e,closeButton:t}}get currentContent(){return this._currentContent}async getContent(){return X("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const e=await this.getContent();this._currentContent.innerHTML="",Array.from(e.children).forEach(i=>this._currentContent.appendChild(i))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){const e=this.player.playbackBar.popUp;if(e.isHidden||this._contentId!==e.currentContentId){const t=await this.getContent();this._currentContent=t,this._contentId=e.show({title:this.menuTitle||this.description,content:t,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else e.hide()}}const Qr=n=>n?`<span class="menu-title">${n}</span>`:"",Zr=n=>n?`<i class="menu-icon">${n}</i>`:"",Jr=n=>n?`aria-label="${n}"`:"",tu=n=>n?`<span class="state-text">${n}</span>`:"",iu=n=>n?`<i class="state-icon">${n}</i>`:"",su=(n,e)=>n||e?`<span class="button-state">${tu(n)}${iu(e)}</span>`:"",nu={button({id:n=0,title:e=null,icon:t=null,showTitle:i=!0,stateText:s=null,stateIcon:r=null,allItems:a,plugin:o}){const l=X(`
			<button class="menu-button-item" ${Jr(e)} data-id="${n}">
				${Zr(t)}
				${i?Qr(e):""}
				${s||r?su(s,r):""}
			</button>
		`);return l.addEventListener("click",async c=>{const u=a.find(h=>h.id===n);o.itemSelected(u,a),await o.checkRefreshContent(),c.stopPropagation(),o.closeOnSelect&&o.closeMenu()}),l},input({type:n,id:e=0,title:t=null,icon:i=null,showTitle:s=!0,plugin:r,onItemSelected:a,selectedItems:o,menuName:l}){const c=o[e]??!1,u=X(`
			<label class="menu-button-item">
				<input type="${n}" ${c?"checked":""} value="${e}" ${Jr(t)} name="${l}" data-id="${e}">
				${Zr(i)}
				${s?Qr(t):""}
			</label>
		`);return u.querySelector("input").addEventListener("click",h=>h.stopPropagation()),u.querySelector("input").addEventListener("change",h=>{a(h.target),r.checkRefreshContent(),r.closeOnSelect&&r.closeMenu()}),u},check({plugin:n,id:e=0,title:t=null,icon:i=null,showTitle:s=!0,allItems:r,selectedItems:a}){return this.input({type:"checkbox",id:e,title:t,icon:i,showTitle:s,allItems:r,selectedItems:a,onItemSelected:o=>{const l=r.find(c=>c.id===e);a[e]=o.checked,n.itemSelected(l,r)}})},radio({plugin:n,id:e=0,title:t=null,icon:i=null,showTitle:s=!0,allItems:r,selectedItems:a,menuName:o}){return this.input({plugin:n,type:"radio",id:e,title:t,icon:i,showTitle:s,allItems:r,selectedItems:a,menuName:o,onItemSelected:l=>{let c=null;a[e]=!0,r.forEach(u=>{u.id===e?c=u:a[u.id]=!1}),n.itemSelected(c,r)}})}};function ru(n,e,t,i,s,r){const a=nu[e]({...n,menuName:s,plugin:this,allItems:i,selectedItems:r});return t.appendChild(a),a}class ea extends Xr{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}setSelected(e,t){this._selectedItems&&(this._selectedItems[e]=t)}async getContent(){const e=X('<fieldset class="menu-button-content"></fieldset>');this._content=e;const t=await this.getMenu();this._menuItems=t;let i=null;this._selectedItems||(this._selectedItems={},this._menuItems.forEach(a=>{a.selected!==void 0&&a.selected!==null&&(this._selectedItems[a.id]=a.selected)}));const s=self.crypto.randomUUID();return i=t.map(a=>ru.apply(this,[a,this.buttonType,e,t,s,this._selectedItems]))[0],setTimeout(()=>{i&&i.focus()},50),e}get menuTitle(){return this.config.menuTitle||null}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}get buttonType(){return"radio"}itemSelected(e,t){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.player.playbackBar.popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp()}}class ta extends ea{get closeOnSelect(){return this.config.closeOnSelect??!1}async load(){this._iconPath&&(this.icon=await Kn(this._iconPath))}async getContent(){return this._buttonPlugins||(this._buttonPlugins=[],await we(this.player,"button",async e=>{this.player.log.debug(`Load button plugins into "${this.groupName}" container`),this._buttonPlugins.push(e),e.setObserver(this)},async e=>e.parentContainer===this.groupName?await e.isEnabled():!1)),await super.getContent()}onIconChanged(e,t,i){}onTitleChanged(e,t,i){}onStateChanged(e,t,i,s,r){}get groupName(){var e;return((e=this.config)==null?void 0:e.groupName)||"buttonGroup"}get popUpType(){return"no-modal"}getClosePopUps(){return!1}buttonType(){return"button"}async getMenu(){return this._buttonPlugins.map(e=>({id:e.name,title:e.title||e.description,icon:e.icon}))}itemSelected(e,t){const i=this._buttonPlugins.find(s=>s.name===e.id);if(i){const s=new Event("menuitemselected");i.action(s,this.currentContent)}}async showPopUp(){var e;await super.showPopUp(),setTimeout(()=>{this._firstItem&&this._firstItem.focus()},50),(e=this.buttons)==null||e.forEach(t=>{t.style.display==="none"?this.hideButtonContainer(t):this.showButtonContainer(t)})}get buttons(){return this._content&&Array.from(this._content.getElementsByClassName("button-plugin"))}hideButtonContainer(e){var i;const t=(i=e.parentNode)==null?void 0:i.parentNode;t&&(t.style.display="none")}showButtonContainer(e){var i;const t=(i=e.parentNode)==null?void 0:i.parentNode;t&&(t.style.display=null)}}const Os=(n,e,t,i={})=>{const s=new n(e,t);return t=s.name||t,t?(e.config.plugins&&e.config.plugins[t]&&Kt(i,e.config.plugins[t],!1),s._config=i,s):(e.log.warn(`The instance of the ${n.name} plugin cannot be created because it is being loaded explicitly and does not have the name property implemented.`),null)};function Ns(n,e,t,i,s=!1){const r=t.type;let a=-1;if(n.__pluginData__.pluginInstances[r]&&n.__pluginData__.pluginInstances[r].find((l,c)=>{if(l.name===t.name)return a=c,!0})&&!s){n.log.info(`Plugin ${t.name} of type ${r} already registered.`);return}n.__pluginData__.pluginClasses[e]=i,n.__pluginData__.pluginInstances[r]=n.__pluginData__.pluginInstances[r]||[],a!==-1&&n.__pluginData__.pluginInstances[r].splice(a,1),n.__pluginData__.pluginInstances[r].push(t),n.__pluginModules=n.__pluginModules||[];const o=t.getPluginModuleInstance();if(o&&(o._player=o._player||n,!n.__pluginModules.find(l=>l.constructor.name===o.constructor.name))){const l=o.moduleName,c=o.moduleVersion;n.log.debug(`Plugin module imported: ${l}: v${c}`),n.__pluginModules.push(o)}}function au(n,e){let t=null,i={enabled:!0};if(typeof e=="function"?t=e:typeof e=="object"&&typeof e.plugin=="function"&&(t=e.plugin,i=e.config),!t)n.log.warn("Error importing plugin with explicit import API. Check the 'plugins' array at init params");else{const s=Os(t,n,null,i);if(!s)n.log.warn(`Unable to create an instance of the plugin ${t.name}`);else{const r=s.constructor.name;Ns(n,r,s,t,!0)}}}function ou(n,e){const t=n.config;e.keys().forEach(i=>{const s=e(i),r=i.substring(2,i.length-3);if(t.plugins[r]){const a=s.default,o=Os(a,n,r,{});Ns(n,i,o,a,!1)}else if(/^[a-z0-9]+$/i.test(r)){n.__pluginModules=n.__pluginModules||[];const a=s.default,o=new a(n);if(!n.__pluginModules.find(l=>l.constructor.name===o.constructor.name)){const l=o.moduleName,c=o.moduleVersion;n.log.debug(`Plugin module imported: ${l}: v${c}`),n.__pluginModules.push(o)}}})}function lu(n){const e=n.config;if(n.__pluginData__=n.__pluginData__||{pluginClasses:[],pluginInstances:{}},n.__pluginData__.pluginClasses.length!==0)return;[...eu,...n.initParams.plugins].forEach(i=>{au(n,i)});const{buttonGroups:t}=e;t&&t.forEach((i,s)=>{const r=`button_group_${s}`,a=Os(ta,n,r,i);a._iconPath=Ye([n.configResourcesUrl,i.icon]),Ns(n,a.type,a,`ButtonGroupPlugin${s}`,!1)}),n.log.debug("Plugins have been registered:")}function cu(n){delete n.__pluginData__}function Us(n,e){var t;return((t=n.__pluginData__)==null?void 0:t.pluginInstances[e])||[]}async function we(n,e,t=null,i=null){if(!n.__pluginData__.pluginInstances[e]){n.log.info(`There are no defined plugins of type '${e}'`);return}n.__pluginData__.pluginInstances[e].sort((s,r)=>s.order-r.order),n.__pluginData__.pluginInstances[e].forEach(s=>n.log.debug(`type: ${e}, name: ${s.name}`)),typeof i!="function"&&(i=async function(s){return await s.isEnabled()});for(const s in n.__pluginData__.pluginInstances[e]){const r=n.__pluginData__.pluginInstances[e][s];if(await i(r)){if(r.__uiPlugin){const o=await r.getDictionaries();if(typeof o=="object")for(const l in o){const c=o[l];n.addDictionary(l,c)}}typeof t=="function"&&await t(r),await r.load()}}}async function ia(n,e){var t;(t=n.__pluginData__.pluginInstances[e])==null||t.forEach(async i=>{await i.unload()})}function sa(n){var t;const e=(i,s)=>{if(!i)throw new Error(`Invalid video manifest: ${s}`)};e(n.streams,"missing 'streams' object."),e(n.streams.length>0,"the 'streams' array is empty."),e((t=n.metadata)==null?void 0:t.preview,"the 'metadata.preview' field is required.")}class uu extends ft{constructor(e,t){super(e,t),this._videoContainer=t,this._streamData=null,this._streams=null,this._players=[],this._mainAudioPlayer=null,this._streamSyncTimer=null,this._trimming={enabled:!1,start:100,end:200}}async load(e){this._streamData=e,this._streams={};let t=this.player.config.defaultAudioStream||"presenter";this._streamData.length===1&&(t=this._streamData[0].content),e.some(s=>{if(s.role==="mainAudio")return t=s.content,!0}),this.player.log.debug("Finding compatible video plugins"),await Uc(this.player);for(const s of this._streamData){const r=$c(this.player,s);if(!r)throw Error(`Canvas plugin not found: ${s.canvas}`);const a=s.content===t,o=await Zl(this.player,s);if(!o)throw Error(`Incompatible stream type: ${s.content}`);this._streams[s.content]={stream:s,isMainAudio:a,videoPlugin:o,canvasPlugin:r}}let i=null;for(const s in this._streams){const r=this._streams[s];r.canvas=await r.canvasPlugin.getCanvasInstance(this._videoContainer),r.player=await r.videoPlugin.getVideoInstance(r.canvas.element,r.isMainAudio),t===s?(this._mainAudioPlayer=r.player,r.player.initVolume(1)):r.player.initVolume(0),await r.player.load(r.stream,this),await r.canvas.loadCanvas(r.player),r.player.onVideoEnded(()=>{i===null&&(ht(this.player,F.ENDED),i=setTimeout(()=>{i=null},2e3))}),this._players.push(r.player)}if(this.mainAudioPlayer===null)throw this.player.log.error("The video stream containing the audio track could not be identified. The `role` attribute must be specified in the main video stream, or the `defaultAudioStream` attribute must be set correctly in the player configuration."),new Error("The video stream containing the audio track could not be identified.")}async unload(){this.stopStreamSync(),await Bc(this.player)}get players(){return this._players}get streamData(){return this._streamData}get streams(){return this._streams}get mainAudioPlayer(){return this._mainAudioPlayer}get isTrimEnabled(){var e,t,i;return((e=this._trimming)==null?void 0:e.enabled)&&((t=this._trimming)==null?void 0:t.end)>((i=this._trimming)==null?void 0:i.start)}get trimStart(){var e;return(e=this._trimming)==null?void 0:e.start}get trimEnd(){var e;return(e=this._trimming)==null?void 0:e.end}async setTrimming({enabled:e,start:t,end:i}){if(t>=i)throw Error(`Error setting trimming: start time (${t}) must be lower than end time ${i}`);this._trimming={enabled:e,start:t,end:i};const s=await this.currentTime();ht(this.player,F.TIMEUPDATE,{currentTime:e?t+s:s})}startStreamSync(){this._timeSync=!0;const e=async()=>{if(!this._players.length){this.player.log.warn("Player not yet loaded. Waiting for video sync.");return}let t=this.mainAudioPlayer.currentTimeSync;const i=.2;if(this.players.length>1)for(let s=0;s<this.players.length;++s){const r=this.players[s];if(r!==this.mainAudioPlayer){const a=r.currentTimeSync;Math.abs(t-a)>i&&(this.player.log.debug("Video synchronization triggered"),r.setCurrentTime(t))}}if(this.isTrimEnabled){let s=t-this.trimStart;if(this.trimEnd<=t){await this.executeAction("pause"),await this.setCurrentTime(0),this.stopStreamSync(),t=0,ht(this.player,F.ENDED,{});return}else t<this.trimStart&&(await this.setCurrentTime(0),t=this.trimStart,s=0);ht(this.player,F.TIMEUPDATE,{currentTime:s}),this._timeupdateTimer=setTimeout(()=>{this._timeSync&&e()},250)}else this._timeSync&&(ht(this.player,F.TIMEUPDATE,{currentTime:t}),this._timeupdateTimer=setTimeout(()=>{e()},250))};e()}stopStreamSync(){this._timeSync=!1,this._timeupdateTimer&&clearTimeout(this._timeupdateTimer)}executeAction(e,t=[]){return Array.isArray(t)||(t=[t]),new Promise(i=>{let s=[],r=[];this.players.forEach(a=>{r.push(new Promise(o=>{a[e](...t).then(l=>{s.push(l),o()})}))}),Promise.allSettled(r).then(()=>i(s))})}get isLiveStream(){return this._streamData.some(e=>Array.from(Object.keys(e.sources)).indexOf("hlsLive")!==-1)}async play(){return this.startStreamSync(),await this.executeAction("play")}async pause(){return this.stopStreamSync(),await this.executeAction("pause")}async stop(){this.stopStreamSync(),await this.executeAction("pause"),await this.executeAction("setCurrentTime",0)}async paused(){return(await this.executeAction("paused"))[0]}async setCurrentTime(e){const t=await this.duration();e<0?e=0:e>t&&(e=t);const i=(await this.executeAction("currentTime"))[0];let s=null;if(this.isTrimEnabled){e=e+this.trimStart,e=e>=this.trimEnd?this.trimEnd:e;const a=(await this.executeAction("setCurrentTime",[e]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i-this.trimStart,newTime:o-this.trimStart}}else{const a=(await this.executeAction("setCurrentTime",[e]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i,newTime:o}}const r=await this.currentTime();return ht(this.player,F.TIMEUPDATE,{currentTime:r}),s}async currentTime(){const e=await this.mainAudioPlayer.currentTime();return this.isTrimEnabled?e-this.trimStart:e}async currentTimeIgnoringTrimming(){return await this.mainAudioPlayer.currentTime()}async volume(){return this.mainAudioPlayer?await this.mainAudioPlayer.volume():(await this.executeAction("volume"))[0]}async setVolume(e){return this.mainAudioPlayer?await this.mainAudioPlayer.setVolume(e):(await this.executeAction("setVolume",[e]))[0]}async duration(){return this.isTrimEnabled?this.trimEnd-this.trimStart:(await this.executeAction("duration"))[0]}async durationIgnoringTrimming(){return(await this.executeAction("duration"))[0]}async playbackRate(){return(await this.executeAction("playbackRate"))[0]}async setPlaybackRate(e){return(await this.executeAction("setPlaybackRate",[e]))[0]}async getQualityReferencePlayer(){let e=null,t=[];if(Object.keys(this.streams).length>0)for(const i in this.streams){const s=this.streams[i],r=await s.player.getQualities()||[];!e&&r.length>t.length&&(t=r,e=s.player)}return e||this.mainAudioPlayer}async getCurrentQuality(){return(await this.getQualityReferencePlayer()).currentQuality}async getQualities(){return await(await this.getQualityReferencePlayer()).getQualities()}async setQuality(e){const i=await(await this.getQualityReferencePlayer()).getQualities(),s=i.length;let r=-1;if(i.some((a,o)=>(e.index===a.index&&(r=o),r!==-1)),r>=0){const a=r/s;for(const o in this.streams){const l=this.streams[o],c=await l.player.getQualities()||[];if(this.player.log.debug(c),c.length>1){const u=Math.round(c.length*a),h=c[u];await l.player.setQuality(h)}}}}async supportsMultiaudio(){return this.mainAudioPlayer.supportsMultiaudio()}async getAudioTracks(){return this.mainAudioPlayer.getAudioTracks()}async setCurrentAudioTrack(e){return this.mainAudioPlayer.setCurrentAudioTrack(e)}get currentAudioTrack(){return this.mainAudioPlayer.currentAudioTrack}}function hu(n,e){return Array.isArray[e]||(e=[e]),Ql(n,e).getManifestData(e)}async function du(n){return{w:1280,h:720}}async function na(n){var e;for(const t in this.streamProvider.streams){const i=((e=n==null?void 0:n.videos)==null?void 0:e.find(r=>r.content===t))!=null,s=this.streamProvider.streams[t];i&&!s.player.isEnabled?await s.player.enable():!i&&s.player.isEnabled&&await s.player.disable()}}function ra(){for(const n in this.streamProvider.streams){const e=this.streamProvider.streams[n];e.canvas.element.style.display="none",this._hiddenVideos.appendChild(e.canvas.element)}}async function fu(){var c,u;const n=Gr(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await na.apply(this,[n]),ra.apply(this);const e=await du(this.player),t=this.elementSize,i=100/e.w,s=100/e.h,r=t.w/t.h,a=e.w/e.h,o=r>a?{w:t.h*a,h:t.h}:{w:t.w,h:t.w/a};if(this.baseVideoRect.style.width=o.w+"px",this.baseVideoRect.style.height=o.h+"px",this.baseVideoRect.classList.remove("dynamic"),(c=n==null?void 0:n.videos)!=null&&c.length){const h=[];for(const d of n.videos){const g=this.streamProvider.streams[d.content],{stream:f,player:m,canvas:y}=g,v=await m.getDimensions(),E=v.w/v.h;let T=Number.MAX_VALUE,_=null;y.buttonsArea.innerHTML="",h.push(await Cs(this.player,n,y,d,d.content)),d.rect.forEach(S=>{const w=/^(\d+.?\d*)\/(\d+.?\d*)$/.exec(S.aspectRatio),b=w?Number(w[1])/Number(w[2]):1,D=Math.abs(E-b);D<T&&(_=S,T=D)}),y.element.style.display="block",y.element.style.position="absolute",y.element.style.left=`${(_==null?void 0:_.left)*i}%`,y.element.style.top=`${(_==null?void 0:_.top)*s}%`,y.element.style.width=`${(_==null?void 0:_.width)*i}%`,y.element.style.height=`${(_==null?void 0:_.height)*s}%`,y.element.style.zIndex=d.layer,this.baseVideoRect.appendChild(y.element)}setTimeout(()=>{bs(this.player,n,h.flat())},100)}const l=this.baseVideoRect.getElementsByClassName("video-layout-button");return Array.from(l).forEach(h=>this.baseVideoRect.removeChild(h)),(u=n==null?void 0:n.buttons)==null||u.forEach(h=>{const d=es({tag:"button",attributes:{class:"video-layout-button","aria-label":Rt(h.ariaLabel),title:Rt(h.title),style:`
                    left: ${h.rect.left*i}%;
                    top: ${h.rect.top*s}%;
                    width: ${h.rect.width*i}%;
                    height: ${h.rect.height*s}%;
                    z-index: ${h.layer};
                `},parent:this.baseVideoRect,children:h.icon});d.layout=n,d.buttonAction=h.onClick,d.addEventListener("click",async g=>{J(this.player,F.BUTTON_PRESS,{plugin:n.plugin,layoutStructure:n}),await g.target.buttonAction.apply(g.target.layout),g.stopPropagation()}),this._layoutButtons.push(d)}),!0}async function gu(){var a,o,l,c,u,h;const n=Gr(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await na.apply(this,[n]),ra.apply(this),this.baseVideoRect.style.width="",this.baseVideoRect.style.height="",this.baseVideoRect.style.display="flex",this.baseVideoRect.classList.add("dynamic"),this.baseVideoRect.innerHTML="";const e=this.element.clientWidth,t=this.element.clientHeight,i=e>t;if(this.baseVideoRect.classList.remove("align-center"),this.baseVideoRect.classList.remove("align-top"),this.baseVideoRect.classList.remove("align-bottom"),this.baseVideoRect.classList.remove("align-left"),this.baseVideoRect.classList.remove("align-right"),i){const d=((o=(a=this.player.config.videoContainer)==null?void 0:a.dynamicLayout)==null?void 0:o.landscapeVerticalAlignment)||"align-center";this.baseVideoRect.classList.remove("portrait"),this.baseVideoRect.classList.add("landscape"),this.baseVideoRect.classList.add(d)}else{const d=((c=(l=this.player.config.videoContainer)==null?void 0:l.dynamicLayout)==null?void 0:c.portraitHorizontalAlignment)||"align-center";this.baseVideoRect.classList.add("portrait"),this.baseVideoRect.classList.remove("landscape"),this.baseVideoRect.classList.add(d)}const s=this.baseVideoRect.clientWidth,r=this.element.clientHeight;if(((u=n==null?void 0:n.videos)==null?void 0:u.length)===1){const d=[],g=[],f=n.videos[0],m=this.streamProvider.streams[f.content],{player:y,canvas:v}=m;v.buttonsArea.innerHTML="",g.push(await Cs(this.player,n,v,f,f.content)),v.element.style={},v.element.style.display="block",v.element.style.width="100%",v.element.style.height="100%",v.element.style.overflow="hidden",v.element.style.position="relative",d.push(v.element),v.element.sortIndex=0,d.forEach(E=>this.baseVideoRect.appendChild(E)),setTimeout(()=>{bs(this.player,n,g.flat())},100)}else if((h=n==null?void 0:n.videos)!=null&&h.length){let d=0;const g=[],f=[];for(const m of n.videos){const y=this.streamProvider.streams[m.content],{player:v,canvas:E}=y,T=await v.getDimensions(),_=T.w/T.h,S=s,w=r,b=(i?S:w)*m.size/100;let D=Math.round(i?b:b*_),k=Math.round(i?b/_:b);D>S&&(D=S,k=Math.round(D/_)),k>w&&(k=w,D=Math.round(k*_)),E.buttonsArea.innerHTML="",f.push(await Cs(this.player,n,E,m,m.content)),E.element.style={},E.element.style.display="block",E.element.style.width=`${D}px`,E.element.style.height=`${k}px`,E.element.style.overflow="hidden",E.element.style.position="relative",E.element.sortIndex=d++,g.push(E.element)}if(i){const m=X('<div class="landscape-container"></div>',this.baseVideoRect);g.forEach(y=>m.appendChild(y))}else g.forEach(m=>this.baseVideoRect.appendChild(m));setTimeout(()=>{bs(this.player,n,f.flat())},100)}return!0}class mu extends Ne{constructor(e,t){var a;const i="base-video-rect",s={class:"video-container"};(a=e.config.videoContainer)!=null&&a.overPlaybackBar&&(s.class+=" over-playback-bar");const r=`
            <div class="${i}"></div>
            <div class="hidden-videos-container" style="display: none"></div>
        `;super(e,{attributes:s,children:r,parent:t}),this._hiddenVideos=this.element.getElementsByClassName("hidden-videos-container")[0],this._baseVideoRect=this.element.getElementsByClassName(i)[0],this.element.addEventListener("click",async()=>{await this.paused()?await this.play():await this.pause()}),this._ready=!1,this._players=[],this._streamProvider=new uu(this.player,this.baseVideoRect)}get layoutId(){return this._layoutId}get mainLayoutContent(){return this._mainLayoutContent}async setLayout(e,t=null){var i,s;if(this.validContentIds.indexOf(e)===-1)return!1;{const r=(s=(i=this.player.config.videoContainer)==null?void 0:i.restoreVideoLayout)==null?void 0:s.global;await this.player.preferences.set("videoLayout",e,{global:r}),await this.player.preferences.set("videoLayoutMainContent",t,{global:r});const a=this._layoutId;this._layoutId=e,this._mainLayoutContent=t,await this.updateLayout(),a!==e&&J(this.player,F.LAYOUT_CHANGED,{prevLayout:a,layoutId:e})}}get validContentIds(){return this._validContentIds}get validContentSettings(){return this._validContentSettings}get validLayouts(){return fi(this.player,this.streamData)}get streamData(){return this._streamData}get baseVideoRect(){return this._baseVideoRect}get streamProvider(){return this._streamProvider}async create(){this._baseVideoRect.style.display="none",await we(this.player,"layout"),await jl(this.player)}async load(e){var o,l,c,u,h,d,g,f,m,y;if(this._streamData=e,(l=(o=this.player.config.videoContainer)==null?void 0:o.restoreVideoLayout)!=null&&l.enabled){const v=(u=(c=this.player.config.videoContainer)==null?void 0:c.restoreVideoLayout)==null?void 0:u.global;this._layoutId=await this.player.preferences.get("videoLayout",{global:v})||this.player.config.defaultLayout,this._mainLayoutContent=await this.player.preferences.get("videoLayoutMainContent",{global:v})||null}else this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null;await this.streamProvider.load(e),this._validContentIds=Br(this.player,e),this._validContentSettings=Fc(this.player,e),await this.updateLayout(null,!0);const t=X('<div class="button-plugins left-side"></div>',this.element),i=X('<div class="button-plugins right-side"></div>',this.element);this._buttonPlugins=[t,i],this.player.log.debug("Loading videoContainer button plugins"),await we(this.player,"button",async v=>{this.player.log.debug(` Button plugin: ${v.name}`),v.side==="left"?await hi(v,t):v.side==="right"&&await hi(v,i)},async v=>v.parentContainer==="videoContainer"?await v.isEnabled():!1),this._baseVideoRect.style.display="";const s=await this.player.preferences.get("volume",{global:!0}),r=await this.player.preferences.get("playbackRate",{global:!0}),a=await this.player.preferences.get("lastKnownTime",{global:!1});if((h=this.player.config.videoContainer)!=null&&h.restoreVolume&&s!==null&&s!==void 0&&await this.streamProvider.setVolume(s),(d=this.player.config.videoContainer)!=null&&d.restorePlaybackRate&&r!==null&&r!==void 0&&await this.streamProvider.setPlaybackRate(r),this.player.videoManifest.trimming&&await this.player.videoContainer.setTrimming(this.player.videoManifest.trimming),(f=(g=this.player.config.videoContainer)==null?void 0:g.restoreLastTime)!=null&&f.enabled&&!this.streamProvider.isLiveStream){const v=async()=>{if(!await this.paused()){const T=await this.currentTime();await this.player.preferences.set("lastKnownTime",T,{global:!1})}setTimeout(v,1e3)};if(a){const E=await this.player.preferences.get("lastKnownTime",{global:!1}),T=await this.duration(),_=(y=(m=this.player.config.videoContainer)==null?void 0:m.restoreLastTime)==null?void 0:y.remainingSeconds;T-E>_&&await this.setCurrentTime(E)}v()}this._messageContainer=new dc(this.player,this.element),this._ready=!0}async unload(){this.removeFromParent(),await ia(this.player,"layout"),await Xl(this.player),await this.streamProvider.unload()}async updateLayout(e=null){const t=arguments[1];if(e&&(this._mainLayoutContent=e),!t&&this.player.state!==z.LOADED)return;if(this._updateInProgress)return this.player.log.warn("Recursive update layout detected"),!1;this._updateInProgress=!0;let i=!0;this._layoutButtons=[],(!this._layoutId||this._validContentIds.indexOf(this._layoutId)===-1)&&(this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null,this._validContentIds.indexOf(this._layoutId)===-1&&(this._layoutId=this._validContentIds[0]),i=!1);const s=$r(this.player,this.streamProvider.streamData,this._layoutId);return s.layoutType==="static"?i=fu.apply(this):s.layoutType==="dynamic"&&(i=gu.apply(this)),this._updateInProgress=!1,i}hideUserInterface(){if(this._layoutButtons&&this._buttonPlugins){this.player.log.debug("Hide video container user interface");const e=t=>{t._prevDisplay=t.style.display,t.style.display="none"};this._layoutButtons.forEach(e),this._buttonPlugins.forEach(e);for(const t in this.streamProvider.streams)this.streamProvider.streams[t].canvas.hideButtons()}}showUserInterface(){if(this._layoutButtons&&this._buttonPlugins){const e=t=>t.style.display=t._prevDisplay||"block";this._layoutButtons.forEach(e),this._buttonPlugins.forEach(e);for(const t in this.streamProvider.streams)this.streamProvider.streams[t].canvas.showButtons()}}get message(){return this._messageContainer}get elementSize(){return{w:this.element.offsetWidth,h:this.element.offsetHeight}}get ready(){return this._ready}get isLiveStream(){return this.streamProvider.isLiveStream}async play(){const e=await this.streamProvider.play();return J(this.player,F.PLAY),e}async pause(){const e=await this.streamProvider.pause();return J(this.player,F.PAUSE),e}async stop(){this.streamProvider.stop(),J(this.player,F.STOP)}async paused(){return this.streamProvider.paused()}async setCurrentTime(e){const t=await this.streamProvider.setCurrentTime(e);return J(this.player,F.SEEK,{prevTime:t.prevTime,newTime:t.newTime}),t.result}async currentTime(){return this.streamProvider.currentTime()}async volume(){return this.streamProvider.volume()}async setVolume(e){const t=await this.streamProvider.setVolume(e);return J(this.player,F.VOLUME_CHANGED,{volume:e}),await this.player.preferences.set("volume",e,{global:!0}),t}async duration(){return await this.streamProvider.duration()}async playbackRate(){return await this.streamProvider.playbackRate()}async setPlaybackRate(e){const t=await this.streamProvider.setPlaybackRate(e);return J(this.player,F.PLAYBACK_RATE_CHANGED,{newPlaybackRate:e}),await this.player.preferences.set("playbackRate",e,{global:!0}),t}get isTrimEnabled(){return this.streamProvider.isTrimEnabled}get trimStart(){return this.streamProvider.trimStart}get trimEnd(){return this.streamProvider.trimEnd}async setTrimming({enabled:e,start:t,end:i}){const s=await this.streamProvider.setTrimming({enabled:e,start:t,end:i});return J(this.player,F.TRIMMING_CHANGED,{enabled:e,start:t,end:i}),s}getVideoRect(e=null){var i;let t=this.baseVideoRect;return typeof e=="string"&&(t=(i=this.streamProvider.streams[e])==null?void 0:i.canvas.element),{x:t==null?void 0:t.offsetLeft,y:t==null?void 0:t.offsetTop,width:t==null?void 0:t.offsetWidth,height:t==null?void 0:t.offsetHeight,element:t}}appendChild(e,t=null,i=1){if(t){const{width:s,height:r}=this.getVideoRect();t.x=t.x*100/s,t.width=t.width*100/s,t.y=t.y*100/r,t.height=t.height*100/r,e.style.position="absolute",e.style.left=`${t.x}%`,e.style.top=`${t.y}%`,e.style.width=`${t.width}%`,e.style.height=`${t.height}%`,i!==null&&(e.style.zIndex=i)}return this.baseVideoRect.appendChild(e),e}removeChild(e){this.baseVideoRect.removeChild(e)}}const pu=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 300 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <rect id="Play" x="0" y="0" width="300" height="300" style="fill:none;"/>
    <g id="Play1" serif:id="Play">
        <g transform="matrix(1.21457,0,0,1.21457,-55.8704,-35.2227)">
            <circle cx="169.5" cy="152.5" r="123.5" style="fill:rgb(128,128,128);"/>
            <path d="M169.5,29C237.662,29 293,84.338 293,152.5C293,220.662 237.662,276 169.5,276C101.338,276 46,220.662 46,152.5C46,84.338 101.338,29 169.5,29ZM169.5,37.233C233.117,37.233 284.767,88.883 284.767,152.5C284.767,216.117 233.117,267.767 169.5,267.767C105.883,267.767 54.233,216.117 54.233,152.5C54.233,88.883 105.883,37.233 169.5,37.233Z" style="fill:rgb(235,235,235);"/>
        </g>
        <g transform="matrix(6.12323e-17,1,-1,6.12323e-17,347,-59)">
            <path d="M209,82L317,253L101,253L209,82Z" style="fill:rgb(235,235,235);"/>
        </g>
    </g>
</svg>
`,yu=`
    background-color: #e4e4e4;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: absolute;
    top: 50%;
    transform: translateY(-50%); 
`,Bs=`
    width: 100%;
`,vu=`
    position: absolute; 
    top: 0px; 
    left: 0px; 
    right: 0px; 
    bottom: 0px; 
    display: flex;
    align-content: center;
    justify-content: center;
    align-items: center;
`,Eu=`
    pointer-events: none;
    width: 20%;
    max-width: 400px;
    min-width: 100px;
    opacity: 0.6;
`,Tu=`
    display: block;
    width: 20%;
    background: none;
    border: none;
    cursor: pointer;
`;class Su extends Ne{constructor(e,t,i,s){const r={class:"preview-container",style:yu,role:"button","aria-label":"Play video"};super(e,{attributes:r,parent:t}),this._img=X(`
        <div style="${Bs}">
            ${i?`<img style="${Bs}" src="${i}" class="preview-image-landscape" alt=""/>`:""}
            ${s?`<img style="${Bs}" src="${s}" class="preview-image-portrait" alt=""/>`:""}
            <div style="${vu}">
                <button style="${Tu}" role="button" aria-label="Play video">
                    <i class="preview-play-icon" style="${Eu}">${pu}</i>
                </button>
            </div>
        </div>
        `,this.element),this.element.setAttribute("id","playerContainerClickArea"),this.element.addEventListener("click",l=>{e.play()});const a=i&&s,o=()=>{if(a){const l=this.element.clientWidth/this.element.clientHeight,c=Array.from(this.element.getElementsByClassName("preview-image-landscape")),u=Array.from(this.element.getElementsByClassName("preview-image-portrait"));l>=1?(c.forEach(h=>h.style.display=""),u.forEach(h=>h.style.display="none")):(c.forEach(h=>h.style.display="none"),u.forEach(h=>h.style.display=""))}};window.addEventListener("resize",()=>{o()}),o()}loadBackgroundImage(e){this._img.setAttribute("src",e)}}function aa({container:n,duration:e=1e3,currentTime:t=0,precision:i=100}){n.classList.add("progress-indicator"),n.innerHTML=`
        <div class="range-container">
            <div class="elapsed"></div>
            <div class="remaining"></div>
            <ul class="markers-container"></ul>
            <input type="range" min="0" max="${e*i}" value="${t*i}" class="slider">
        </div>
    `;const s=n.querySelector(".elapsed"),r=n.querySelector(".remaining"),a=n.querySelector(".slider");let o=!1,l=null;const c={elapsed:s,remaining:r,range:a,markersContainer:n.querySelector(".markers-container"),addMarker({time:u,duration:h}){const d=document.createElement("li");d.style.left=`${u/h*100}%`,this.markersContainer.appendChild(d)},updateRemaining(){const u=this.range.value/this.range.max*100;this.elapsed.style.width=`${u}%`,this.remaining.style.width=`${100-u}%`},setDuration(u){o||(this.range.max=u*i,this.updateRemaining())},setCurrentTime(u){o||(this.range.value=u*i,this.updateRemaining())},onChange(u){l=u}};return a.addEventListener("pointerdown",()=>{o=!0}),a.addEventListener("pointerup",()=>{o=!1,typeof l=="function"&&l(a.value/i)}),a.addEventListener("input",()=>{c.updateRemaining()}),c.updateRemaining(),c}const Lu=n=>{const e=document.createElement("section");return e.classList.add("pop-up"),e.innerHTML=`
        <header class="pop-up-title">
            <button class="action-back">
                <svg width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M15 6l-6 6l6 6" />
                </svg>
            </button>
            <h2>title</h2>
        </header>
        <article class="pop-up-content">
        </article>
    `,n.appendChild(e),e.setTitle=t=>{e.querySelector("header.pop-up-title h2").textContent=t},e.popButton=()=>e.querySelector("header.pop-up-title button"),e.onPopClicked=t=>{e._clickCallback&&e.popButton().removeEventListener("click",e._clickCallback),e._clickCallback=t,e.popButton().addEventListener("click",t)},e.hidePopButton=()=>e.popButton().style.display="none",e.showPopButton=()=>e.popButton().style.display="",e.setContent=t=>{e.querySelector("article.pop-up-content").innerHTML="",e.querySelector("article.pop-up-content").appendChild(t)},e};let xu=0;function _u(){return++xu}class Cu{constructor(e){ut(this,Ct,null);ut(this,ye,null);ut(this,_e,[]);ut(this,si,"");bt(this,Ct,e),bt(this,ye,document.createElement("aside")),q(this,ye).className="pop-up-wrapper",e.element.prepend(q(this,ye)),q(this,ye).classList.add("hidden"),q(this,ye).addEventListener("click",t=>t.stopPropagation()),q(this,Ct).element.addEventListener("click",t=>{t.stopPropagation(),this.hide()})}get title(){return q(this,si)}set title(e){bt(this,si,e)}get currentContent(){return q(this,_e).length&&q(this,_e)[q(this,_e).length-1]}get currentContentId(){var e;return((e=this.currentContent)==null?void 0:e.dataContentId)??-1}show({content:e,title:t="",parent:i=null,attachLeft:s=!1,attachRight:r=!1}){if(!e)throw new Error("PlaybackBarPopUp.show(): No content provided.");e.setAttribute("data-pop-up-content-id",_u()),e.dataContentId=e.getAttribute("data-pop-up-content-id");const a=q(this,_e).length&&q(this,_e)[q(this,_e).length-1],o=i&&i.getAttribute("data-pop-up-content-id");a&&a.getAttribute("data-pop-up-content-id")!==o?(q(this,ye).innerHTML="",bt(this,_e,[])):a&&a.container.classList.add("out"),q(this,_e).push(e),q(this,Ct).element.classList.add("pop-up-active"),q(this,ye).classList.remove("hidden");const l=Lu(q(this,ye));return l.setTitle(t),e.container=l,s===!0?q(this,ye).classList.add("left"):q(this,ye).classList.remove("left"),r===!0?q(this,ye).classList.add("right"):q(this,ye).classList.remove("right"),l.setContent(e),q(this,_e).length>1?l.onPopClicked(()=>{q(this,_e).pop(),q(this,_e)[q(this,_e).length-1].container.classList.remove("out"),q(this,ye).removeChild(l)}):l.hidePopButton(),this.title=t,e.dataContentId}hide(){q(this,Ct).element.classList.remove("pop-up-active"),q(this,ye).classList.add("hidden")}get isHidden(){return q(this,ye).classList.contains("hidden")}}Ct=new WeakMap,ye=new WeakMap,_e=new WeakMap,si=new WeakMap;class bu extends Ne{constructor(e,t){var r;const i=((r=e.config.progressIndicator)==null?void 0:r.inlineMode)??!1,s={class:"playback-bar-container"};super(e,{attributes:s,parent:t}),this._popUp=new Cu(this),this.element.addEventListener("mouseenter",()=>jn(e)),this.element.addEventListener("mouseleave",()=>Xn(e)),this._playbackBarContainer=X('<section class="playback-bar"></section>',this.element),this._topContainer=X("<div></div>"),this._navContainer=X("<nav></nav>"),this._buttonPluginsLeft=X("<ul></ul>",this._navContainer),this._centerContainer=X("<div></div>",this._navContainer),this._buttonPluginsRight=X("<ul></ul>",this._navContainer),i?this._progressIndicator=aa({container:this._centerContainer}):(this._playbackBarContainer.appendChild(this._topContainer),this._progressIndicator=aa({container:this._topContainer})),this._progressIndicator.onChange(async a=>{await e.videoContainer.setCurrentTime(a)}),this._playbackBarContainer.appendChild(this._navContainer),this._enabled=!0}get popUp(){return this._popUp}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._enabled?this.showUserInterface():this.hide()}async load(){this._enabledPlugins=[],this.player.log.debug("Loading button plugins"),await we(this.player,"button",async t=>{this.player.log.debug(` Button plugin: ${t.name}`),this._enabledPlugins.push(t),t.side==="left"?await hi(t,this.buttonPluginsLeft):t.side==="right"&&await hi(t,this.buttonPluginsRight)},async t=>t.parentContainer==="playbackBar"?await t.isEnabled():!1);const e=await this.player.videoContainer.duration();this._progressIndicator.setDuration(e),this.player.frameList.frames.forEach(t=>{this._progressIndicator.addMarker({time:t.time,duration:e})}),this.player.bindEvent([this.player.Events.TIMEUPDATE,this.player.Events.SEEK],t=>{this._progressIndicator.setCurrentTime(t.newTime??t.currentTime)}),this.player.bindEvent(this.player.Events.TRIMMING_CHANGED,async t=>{const i=t.end-t.start;this._progressIndicator.setDuration(i);const s=await this.player.videoContainer.currentTime();this._progressIndicator.setCurrentTime(s)}),this.onResize()}async unload(){this.removeFromParent(),await ia(this.player,"button"),this._buttonPluginsLeft.innerHTML="",this._buttonPluginsRight.innerHTML=""}hideUserInterface(){this.player.log.debug("Hide playback bar user interface"),this.hide()}showUserInterface(){var e;if(this._enabled){const i=((e=this.player.config.progressIndicator)==null?void 0:e.inlineMode)??!1?"flex":"block";this.show(i),this.onResize()}}get buttonPluginsRight(){return this._buttonPluginsRight}get buttonPluginsLeft(){return this._buttonPluginsLeft}get timerContainer(){return this._timerContainer}get progressIndicator(){return this._progressIndicator}get containerSize(){const e=this.element.clientWidth,t=this.element.clientHeight;return{width:e,height:t}}onResize(){const{containerSize:e}=this;this._enabledPlugins.forEach(t=>t.onResize(e))}}const oa=[{maxWidth:400,className:"size-s"},{maxWidth:600,className:"size-m"},{maxWidth:900,className:"size-l"},{maxWidth:1100,className:"size-xl"},{className:"size-xxl"}],wu=n=>oa.find(e=>e.maxWidth&&e.maxWidth>=n||e.maxWidth===void 0).className;class Au extends Ne{constructor(e,t){const i={class:"captions-canvas visible-ui"};super(e,{tag:"div",attributes:i,parent:t}),this._captionsContainer=X(`
            <div class="text-container">
            </div>
        `,this.element),this._captions=[],this.hide(),this._currentCaptions=null;const s=async r=>{const o=(e.videoContainer.isTrimEnabled?e.videoContainer.trimStart:0)+(r.currentTime||r.newTime||0);if(this._currentCaptions){const l=this._currentCaptions.getCue(o);this._captionsContainer.innerHTML="",l&&l.captions.forEach(c=>{this._captionsContainer.innerHTML+=c,this._captionsContainer.innerHTML+="<br/>"}),l?this._captionsContainer.style.display=null:this._captionsContainer.style.display="none",this.resize()}};se(this.player,F.TIMEUPDATE,s),se(this.player,F.SEEK,s),se(this.player,F.RESIZE,()=>this.resize()),se(this.player,F.SHOW_UI,()=>this.element.classList.add("visible-ui")),se(this.player,F.HIDE_UI,()=>this.element.classList.remove("visible-ui"))}async load(){await yc(this.player)}unload(){}resize(){const e=wu(this._captionsContainer.clientWidth);oa.forEach(t=>this.element.classList.remove(t.className)),this.element.classList.add(e)}addCaptions(e){this._captions.push(e),J(this.player,F.CAPTIONS_CHANGED,{captions:this._captions})}get captions(){return this._captions}get currentCaptions(){return this._currentCaptions}getCaptions({label:e,index:t,lang:i}){if(e===void 0&&t===void 0&&i===void 0)throw Error("Could not find captions: you must specify the label, the index or the language");return t!==void 0?this._captions[t]:this._captions.find(s=>{if(e!==void 0)return s.label===e;if(i!==void 0)return s.language===i})}enableCaptions(e){const t=this.getCaptions(e);if(t!==this._currentCaptions&&(this._currentCaptions=t,this.currentCaptions)){const{language:i,label:s}=this.currentCaptions;J(this.player,F.CAPTIONS_ENABLED,{language:i,label:s})}this.show()}disableCaptions(){this.currentCaptions&&J(this.player,F.CAPTIONS_DISABLED),this._currentCaptions=null,this.hide()}}async function Ru(n){await we(n,"eventLog",async e=>{e.events.forEach(t=>{se(n,t,async i=>{await e.onEvent(t,i)})})})}async function Iu(n){}class Du extends tt{get type(){return"eventLog"}get events(){return[]}async onEvent(e,t){this.player.log.warn(`${this.name}: onEvent() function is not overwritten.`)}}const $s=n=>!1,Gs=n=>n.description;class Pu{constructor(e,t){this._player=e,this._cookieConsentData=e.config.cookieConsent||[],this._getConsentCallback=t.getConsent||$s,this._getDescriptionCallback=t.getDescription||Gs,this._cookieConsentData.forEach(i=>{i.description=this._getDescriptionCallback(i)}),this.updateConsentData()}updateConsentData(){this._cookieConsentData.forEach(e=>{e.value=this._getConsentCallback(e.type)||e.required}),J(this._player,F.COOKIE_CONSENT_CHANGED,{cookieConsent:this})}getConsentForType(e){const t=this._cookieConsentData.find(i=>i.type===e);return(t==null?void 0:t.value)||!1}}const ue=Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5});let la=ue.INFO;const ca=(n,e=null)=>{const t=typeof n=="string"?ue[n.toUpperCase()]:n;if(t<ue.DISABLED||t>ue.VERBOSE)throw Error(`setLogLevel: invalid log level ${t}`);e?(e.__logSettings=e.__logSettings||{},e.__logSettings.logLevel=t):la=t},ua=(n=null)=>n?n.__logSettings.logLevel:la,Xt=({msg:n,level:e=ue.INFO,player:t=null,context:i="paella-core"})=>{t&&!t.__logSettings&&ca(t,ue.INFO);const s=ua(t);if(e<ue.DISABLED)throw Error(`printMessage: invalid log level ${e}`);if(t&&J(t,F.LOG,{severity:e,context:i,message:n,currentLogLevel:s}),e<=s)switch(e){case ue.ERROR:console.error(`${i} - Error: ${n}`);break;case ue.WARN:console.warn(`${i} - Warning: ${n}`);break;case ue.INFO:console.info(`${i} - Info: ${n}`);break;case ue.DEBUG:console.debug(`${i} - Debug: ${n}`);break;case ue.VERBOSE:console.log(`${i} - Verbose: ${n}`);break}},nt={setLevel:(n,e=null)=>{ca(n,e)},currentLevel:(n=null)=>ua(n),error:(n,e=null,t="paella-core")=>{Xt({msg:n,level:ue.ERROR,player:e,context:t})},warn:(n,e=null,t="paella-core")=>{Xt({msg:n,level:ue.WARN,player:e,context:t})},info:(n,e=null,t="paella-core")=>{Xt({msg:n,level:ue.INFO,player:e,context:t})},debug:(n,e=null,t="paella-core")=>{Xt({msg:n,level:ue.DEBUG,player:e,context:t})},verbose:(n,e=null,t="paella-core")=>{Xt({msg:n,level:ue.VERBOSE,player:e,context:t})}};class ha{constructor(e,t="paella-core"){this._player=e,this._context=t}get context(){return this._context}get player(){return this._player}setLevel(e){nt.setLevel(e,this._player)}currentLevel(){return nt.currentLevel(this._player)}error(e,t=null){nt.error(e,this._player,t||this._context)}warn(e,t=null){nt.warn(e,this._player,t||this._context)}info(e,t=null){nt.info(e,this._player,t||this._context)}debug(e,t=null){nt.debug(e,this._player,t||this._context)}verbose(e,t=null){nt.verbose(e,this._player,t||this._context)}}const da={},Vs='{ "global": {}, "videos": {} }';async function fa(){switch(this.source.name){case"cookie":try{return JSON.parse(et("preferences"))}catch{return JSON.parse(Vs)}case"dataPlugin":try{return await this.player.data.read(this.source.context,{})||JSON.parse(Vs)}catch{return JSON.parse(Vs)}}}async function ku(n){switch(this.source.name){case"cookie":Jn(this.player,this.source.consentType,"preferences",JSON.stringify(n));break;case"dataPlugin":await this.player.data.write(this.source.context,{},n);break}}class Fu extends ft{constructor(e){super(e);const{currentSource:t,sources:i}=e.config.preferences||{currentSource:"cookie",sources:{cookie:{consentType:"necessary"}}};if(this.source=i[t],this.source.name=t,this._loaded=!1,!this.source)throw Error("Invalid configuration in preferences. Check the configuration file.")}async set(e,t,{global:i=!1}={}){const s=await fa.apply(this);i?s.global[e]=t:(s.videos[this.player.videoId]=s.videos[this.player.videoId]||{},s.videos[this.player.videoId][e]=t),await ku.apply(this,[s])}async get(e,{global:t=!1}={}){const i=await fa.apply(this);return t?i.global[e]:i.videos[this.player.videoId]&&i.videos[this.player.videoId][e]||void 0}}function Mu(n){var e;(e=this._skinData)!=null&&e.configOverrides&&Kt(n,this._skinData.configOverrides)}async function Ou(){var n;if((n=this._skinData)!=null&&n.styleSheets){const e=[];this._skinData.styleSheets.forEach(t=>{if(!/\{.*/.test(t))if(this._externalResourcesAllowed){const i=Ye([this._skinUrl,t]);e.push(new Promise(async s=>{await Zi(i,!1),s()}))}else throw new Error("No external resources allowed loading skin object")}),await Promise.allSettled(e)}}async function Nu(){var n;if(this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],(n=this._skinData)!=null&&n.styleSheets){const e=[];this._skinData.styleSheets.forEach(t=>{if(/\{.*/.test(t))e.push(new Promise(i=>{const s=document.createElement("style");s.innerHTML=t,this.player.__skinStyleSheets__.push(s),document.head.appendChild(s),i()}));else{const i=Ye([this._skinUrl,t]);e.push(new Promise(async s=>{const r=await Zi(i);this.player.__skinStyleSheets__.push(r),s()}))}}),await Promise.allSettled(e)}}function ga(){this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],this.player.__skinStyleSheets__.forEach(n=>{er(n)}),this.player.__skinStyleSheets__=[]}async function Uu(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:e,identifier:t,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")s();else if(this._externalResourcesAllowed){const o=Ye([this._skinUrl,i]);(await fetch(o)).ok?s():r(new Error(`Skin icon not found at URL '${o}'`))}else throw new Error("No external resources allowed loading skin object")})))}async function Bu(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:e,identifier:t,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")this.player.addCustomPluginIcon(e,t,i),s();else{const o=Ye([this._skinUrl,i]),l=await fetch(o);if(l.ok){const c=await l.text();this.player.addCustomPluginIcon(e,t,c),s()}else r(new Error(`Skin icon not found at URL '${o}'`))}})))}class $u{constructor(e){this._player=e}get player(){return this._player}async loadSkin(e){if(typeof e=="string"){this._skinUrl=ji(e),this._externalResourcesAllowed=!0;const t=await fetch(e);if(!t.ok)throw new Error(`Error loading skin from URL ${e}`);this._skinData=await t.json()}else typeof e=="object"&&(this._skinUrl="",this._externalResourcesAllowed=!1,this._skinData=e);try{await Ou.apply(this),await Uu.apply(this),(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&await this._player.reload()}catch(t){throw this._skinUrl="",this._externalResourcesAllowed=!0,this._skinData={},t}}unloadSkin(){var e,t;Array.isArray((e=this._skinData)==null?void 0:e.icons)&&((t=this._skinData)==null||t.icons.forEach(({plugin:i,identifier:s})=>{this.player.removeCustomPluginIcon(i,s)})),this._skinUrl=null,this._skinData={},(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&this._player.reload()}}class ma{constructor(e,t){this._player=t,this._videoManifest=JSON.parse(JSON.stringify(e)),this._metadata=this._videoManifest.metadata||{},this._streams={},this._frameList={},this._trimming=this._videoManifest.trimming,this._captions=this._videoManifest.captions,this._visibleTimeLine=this._videoManifest.visibleTimeLine;function i(){if(this.streams.length!==1)return null;if(this.isAudioOnly)return this.audioOnlySource.src;const s=this.streams[0];if(!(s.sources.mp4||s.sources.hls||s.sources.hlsLive))return null;const a=document.createElement("video");if(s.sources.mp4&&s.sources.mp4.length&&a.canPlayType(s.sources.mp4[0].mimetype||"video/mp4")==="probably")return s.sources.mp4[0].src;const o=s.sources.hls||s.sources.hlsLive;return o&&o.length&&a.canPlayType(o[0].mimetype||"application/vnd.apple.mpegurl")!==""&&/safari/i.test(navigator.userAgent)?o[0].src:null}this._streams={streams:this._videoManifest.streams,get contents(){return this.streams.map(s=>s.content)},getStream(s){return this.streams.find(r=>r.content===s)},getSourceTypes(s){const r=this.getStream(s);return r&&Object.keys(r.sources)||null},getCanvasTypes(s){const r=this.getStream(s);return r?r.canvas||["video"]:null},get isAudioOnly(){const s=this.contents.length===1&&this.contents[0],r=s&&this.getCanvasTypes(s)||[],a=this.getStream(s);return r.length===1&&r[0]==="audio"&&a.sources.audio&&a.sources.audio.length>0},get audioOnlySource(){return this.isAudioOnly?this.getStream(this.contents[0]).sources.audio[0]:null},get isNativelyPlayable(){return i.apply(this)!==null},get nativeSource(){return i.apply(this)},get nativeType(){return this.isNativelyPlayable?this.isAudioOnly?"audio":"video":null},get nativePlayer(){const s=this.nativeType;if(s){const r=document.createElement(s);return r.src=this.nativeSource,r}else return null}},this._videoManifest.frameList&&!Array.isArray(this._videoManifest.frameList)&&typeof this._videoManifest.frameList=="object"&&typeof this._videoManifest.frameList.targetContent=="string"&&Array.isArray(this._videoManifest.frameList.frames)?this._frameList=this._videoManifest.frameList:Array.isArray(this._videoManifest.frameList)&&(this._frameList={targetContent:null,frames:this._videoManifest.frameList}),this._frameList.getImage=(s,r=!1)=>{var a,o;return(a=this._player)!=null&&a.videoContainer&&this._player._videoContainer.isTrimEnabled&&!r?s+=this._player.videoContainer.trimStart:!((o=this._player)!=null&&o._videoContainer)&&!r&&console.warn("frameList.getImage(): player instance is null. The trimming information will be ignored."),[...this._frameList.frames].sort((l,c)=>c.time-l.time).find(l=>l.time<s)},Object.defineProperty(this._frameList,"isEmpty",{get(){return Array.isArray(e.frameList)&&e.frameList.length===0||!e.frameList}}),Object.freeze(this._metadata),Object.freeze(this._streams),Object.freeze(this._trimming),Object.freeze(this._captions)}get metadata(){return this._metadata}get streams(){return this._streams}get frameList(){return this._frameList}get captions(){return this._captions}get trimming(){return this._trimming}get visibleTimeLine(){return this._visibleTimeLine}}const Fe=Object.freeze(["UNLOADED","LOADING_MANIFEST","MANIFEST","LOADING_PLAYER","LOADED","UNLOADING_MANIFEST","UNLOADING_PLAYER","ERROR"]);function pa(){var t,i,s,r,a,o,l,c;const n=((i=(t=this.videoManifest)==null?void 0:t.metadata)==null?void 0:i.preview)&&Je(this,(r=(s=this.videoManifest)==null?void 0:s.metadata)==null?void 0:r.preview)||this.defaultVideoPreview,e=((o=(a=this.videoManifest)==null?void 0:a.metadata)==null?void 0:o.previewPortrait)&&Je(this,(c=(l=this.videoManifest)==null?void 0:l.metadata)==null?void 0:c.previewPortrait)||this.defaultVideoPreviewPortrait;this._previewContainer=new Su(this,this._containerElement,n,e)}async function ya(){this._playerState=z.LOADING_MANIFEST,this._manifestLoaded=!0,this.log.debug("Loading paella player"),this._config=await this.initParams.loadConfig(this.configUrl,this),Mu.apply(this.skin,[this._config]),_c(this),this._defaultVideoPreview=this._config.defaultVideoPreview||this._initParams.defaultVideoPreview||"",this._defaultVideoPreviewPortrait=this._config.defaultVideoPreviewPortrait||this._initParams.defaultVideoPreviewPortrait||"",this._cookieConsent=new Pu(this,{getConsent:this._initParams.getCookieConsentFunction,getDescription:this._initParams.getCookieDescriptionFunction}),this._preferences=new Fu(this);const n=new URLSearchParams(window.location.search),e=new URLSearchParams;for(const[s,r]of n)e.append(s.toLowerCase(),r);const t=e.get("loglevel"),i=t&&Array.from(Object.keys(ue)).indexOf(t.toUpperCase())!==-1?t:this._config.logLevel||"INFO";this._log.setLevel(i),await this._initParams.loadDictionaries(this),lu(this),await Ru(this),await uc(this),this._videoContainer=new mu(this,this._containerElement),await this.videoContainer.create();for(const s of this.pluginModules){const r=s.getDictionaries&&await s.getDictionaries();if(r)for(const a in r)It(a,r[a])}}async function va(){var n,e;this.log.debug("Video manifest loaded:"),this.log.debug(this.videoManifest),this._data=new jr(this);for(const t in da){const i=da[t];It(t,i)}if(this._playerState=z.MANIFEST,J(this,F.MANIFEST_LOADED),(e=(n=this.videoManifest)==null?void 0:n.metadata)!=null&&e.preview)pa.apply(this);else throw new Error("No preview image found in video manifest, and no default preview image defined.");sa(this._videoManifest),__paella_instances__.length===1&&(this._loadKeypressHandler=this._loadKeypressHandler||(async t=>{/space/i.test(t.code)&&await this.play()}),window.addEventListener("keypress",this._loadKeypressHandler,!0))}class Gu{constructor(e,t={}){this._log=new ha(this),this._packageData=Yt,this._log.setLevel(ue.VERBOSE),window.__paella_instances__=window.__paella_instances__||[],window.__paella_instances__.push(this),this.log.debug("New paella player instance"),typeof e=="string"&&(e=document.getElementById(e)),e.classList.add("player-container"),this.log.debug("Loading skin manager"),this._skin=new $u(this),this._containerElement=e,this._initParams=t,this._initParams.manifestFileName=this._initParams.manifestFileName||"data.json",this._initParams.loadConfig=this._initParams.loadConfig||ir,this._initParams.getVideoId=this._initParams.getVideoId||sr,this._initParams.getManifestUrl=this._initParams.getManifestUrl||nr,this._initParams.getManifestFileUrl=this._initParams.getManifestFileUrl||rr,this._initParams.loadVideoManifest=this._initParams.loadVideoManifest||ar,this._initParams.customPluginContext=this._initParams.customPluginContext||[],this._initParams.translateFunction=this._initParams.translateFunction||gs,this._initParams.getLanguageFunction=this._initParams.getLanguageFunction||ps,this._initParams.setLanguageFunction=this._initParams.setLanguageFunction||ms,this._initParams.addDictionaryFunction=this._initParams.addDictionaryFunction||ys,this._initParams.getDictionariesFunction=this._initParams.getDictionariesFunction||vs,this._initParams.getDefaultLanguageFunction=this._initParams.getDefaultLanguageFunction||Es,this._initParams.Loader=this._initParams.customLoader||or,this._initParams.getCookieConsentFunction=this._initParams.getCookieConsentFunction||$s,this._initParams.getCookieDescriptionFunction=this._initParams.getCookieDescriptionFunction||Gs,this._initParams.loadDictionaries=this._initParams.loadDictionaries||async function(r){It("en",{Hello:"Hello",World:"World"}),It("es",{Hello:"Hola",World:"Mundo"}),Ts(navigator.language.substring(0,2))};const i=this._initParams.plugins||[];this._initParams.plugins=[...i],vc(this._initParams.translateFunction),Ec(this._initParams.setLanguageFunction),Tc(this._initParams.getLanguageFunction),Sc(this._initParams.addDictionaryFunction),Lc(this._initParams.getDictionariesFunction),xc(this._initParams.getDefaultLanguageFunction),this._config=null,this._defaultVideoPreview="",this._defaultVideoPreviewPortrait="",this._videoId=null,this._manifestUrl=null,this._manifestFileUrl=null,this._manifestData=null,this._videoManifest=null,this._playerLoaded=!1;const s=()=>{this.resize()};window.addEventListener("resize",s),this.containerElement.addEventListener("fullscreenchange",()=>{J(this,F.FULLSCREEN_CHANGED,{status:this.isFullscreen}),this.isFullscreen?J(this,F.ENTER_FULLSCREEN):J(this,F.EXIT_FULLSCREEN)}),this._playerState=z.UNLOADED,this._customPluginIcons={}}get version(){return this._packageData.version}get pluginModules(){return this.__pluginModules||[]}get log(){return this._log}get ready(){return this._playerState===z.LOADED}get state(){return this._playerState}get stateText(){return Fe[this.state]}get Events(){return F}get preferences(){return this._preferences}get skin(){return this._skin}translate(e,t=null){return Rt(e,t)}setLanguage(e){Ts(e)}getLanguage(){return Dr()}addDictionary(e,t){It(e,t)}getDictionaries(){return Pr()}getDefaultLanguage(){return Ss(this)}bindEvent(e,t,i=!0){se(this,e,s=>t(s),i)}getShortcuts(){return Er(this)}getPlugin(e,t=null){if(t){const i=this.__pluginData__.pluginInstances[t];if(i)return i.find(s=>{if(s.name===e)return s})}else{const i={};for(const s in this.__pluginData__.pluginInstances){const a=this.__pluginData__.pluginInstances[s].find(o=>{if(o.name===e)return o});a&&(i[s]=a)}return i}}get hideUiTime(){return this._hideUiTime}set hideUiTime(e){this._hideUiTime=e}get containerSize(){return{w:this._containerElement.offsetWidth,h:this._containerElement.offsetHeight}}get containerElement(){return this._containerElement}get initParams(){return this._initParams}get cookieConsent(){return this._cookieConsent}get configLoaded(){return this.configUrl!==null}get videoManifestLoaded(){return this.videoManifest!==null}get videoLoaded(){var e;return((e=this.videoContainer)==null?void 0:e.ready)||!1}get playerLoaded(){return this._playerLoaded}get configResourcesUrl(){var e;return((e=this._initParams)==null?void 0:e.configResourcesUrl)||"config/"}get configUrl(){var e;return((e=this._initParams)==null?void 0:e.configUrl)||"config/config.json"}get config(){return this._config}get defaultVideoPreview(){return this._defaultVideoPreview}get defaultVideoPreviewPortrait(){return this._defaultVideoPreviewPortrait}get videoId(){return this._videoId}get repositoryUrl(){var e,t;return((e=this._initParams)==null?void 0:e.repositoryUrl)||((t=this.config)==null?void 0:t.repositoryUrl)||""}get manifestUrl(){return this._manifestUrl}get manifestFileName(){var e,t;return((e=this.config)==null?void 0:e.manifestFileName)||((t=this._initParams)==null?void 0:t.manifestFileName)||""}get manifestFileUrl(){return this._manifestFileUrl}get videoManifest(){return this._videoManifest}get previewContainer(){return this._previewContainer}get videoContainer(){return this._videoContainer}get playbackBar(){return this._playbackBar}get captionsCanvas(){return this._captionsCanvas}get data(){return this._data}get PlayerState(){return z}get PlayerStateNames(){return Fe}get metadata(){var e;return((e=this._manifestParser)==null?void 0:e.metadata)||{}}get streams(){var e;return((e=this._manifestParser)==null?void 0:e.streams)||[]}get frameList(){var e;return((e=this._manifestParser)==null?void 0:e.frameList)||{}}get captions(){var e;return((e=this._manifestParser)==null?void 0:e.captions)||[]}get trimming(){var e;return((e=this._manifestParser)==null?void 0:e.trimming)||{}}get visibleTimeLine(){var e;return((e=this._manifestParser)==null?void 0:e.visibleTimeLine)||!0}waitState(e){return new Promise((t,i)=>{const s=()=>{this.state===e?t():setTimeout(s,50)};typeof e=="string"&&(e=z[e]),(e<0||e>Object.values(z).length)&&i(Error(`Invalid player state '${e}'`)),s()})}async loadUrl(e,{title:t,duration:i,preview:s,previewPortrait:r}={}){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[Fe[this._playerState]]));if(this._manifestLoaded)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[Fe[this._playerState]]));if(!e)throw new Error(this.translate("loadUrl(): No URL specified."));Array.isArray(e)||(e=[e]),t||(t=ni(e[0]),this.log.warn("Paella.loadUrl(): no title specified. Using URL file name as video name."));try{if(await ya.apply(this),!s&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!==""))s=this.defaultVideoPreview,r=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.");else if(!s&&!r)throw new Error("Paella.loadUrl(): no preview image specified and no default preview image configured.");this._videoId=qn(ni(e[0])),this._manifestUrl=ji(e[0]),this._manifestFileUrl=e[0],this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`);const a=kc(this,e.length)[0];this._videoManifest={metadata:{duration:i,title:t,preview:s,previewPortrait:r},streams:e.map((o,l)=>({sources:hu(this,o),content:a[l],role:l===0?"mainAudio":null}))},await va.apply(this)}catch(a){throw this._playerState=z.ERROR,this.log.error(a),this._errorContainer=new ts(this,this.translate(a.message)),a}}async loadManifest(){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));if(!this._manifestLoaded)try{if(await ya.apply(this),this._videoId=await this.initParams.getVideoId(this._config,this),this.videoId===null)throw new Error("No video identifier specified");this._manifestUrl=await this.initParams.getManifestUrl(this.repositoryUrl,this.videoId,this._config,this),this._manifestFileUrl=await this.initParams.getManifestFileUrl(this._manifestUrl,this.manifestFileName,this._config,this),this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`),this._videoManifest=await this.initParams.loadVideoManifest(this.manifestFileUrl,this._config,this),this._videoManifest.metadata=this._videoManifest.metadata||{},!this._videoManifest.metadata.preview&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!=="")&&(this._videoManifest.metadata.preview=this.defaultVideoPreview,this._videoManifest.metadata.previewPortrait=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.")),this._manifestParser=new ma(this.videoManifest,this),ga.apply(this.skin),await Bu.apply(this.skin),await Nu.apply(this.skin),await va.apply(this)}catch(e){throw this._playerState=z.ERROR,this.log.error(e),this._errorContainer=new ts(this,this.translate(e.message)),e}}async loadPlayer(){var e,t,i;try{if(this._captionsCanvas=new Au(this,this._containerElement),this._playerState!==z.MANIFEST)throw new Error(this.translate("loadPlayer(): Invalid current player state: $1",[Fe[this._playerState]]));this._playerState=z.LOADING_PLAYER,(e=this._previewContainer)==null||e.removeFromParent(),this._loader=new this.initParams.Loader(this),await this._loader.create(),await this.videoContainer.load((t=this.videoManifest)==null?void 0:t.streams),J(this,F.STREAM_LOADED),this._playbackBar=new bu(this,this.containerElement),await this._playbackBar.load(),this._hideUiTime=((i=this.config.ui)==null?void 0:i.hideUITimer)??5e3,Qn(this),this._captionsCanvas.load(),this._playerState=z.LOADED,J(this,F.PLAYER_LOADED),!(this.videoManifest.metadata.visibleTimeLine??!0)&&this.playbackBar.progressIndicator.hideTimeLine(),this._loader.debug||(this._loader.removeFromParent(),this._loader=null)}catch(s){throw this._playerState=z.ERROR,this._loader&&(this._loader.removeFromParent(),this._loader=null),this._errorContainer=new ts(this,s.message),s}}async load(){switch(this.state){case z.UNLOADED:await this.loadManifest(),await this.loadPlayer();break;case z.MANIFEST:await this.loadPlayer();break;case z.LOADED:break;default:throw new Error(this.translate("Could not load player: state transition in progress: $1",[Fe[this.state]]))}}async unload(){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:case z.ERROR:await this.unloadPlayer(),await this.unloadManifest();break;default:throw new Error(this.translate("Could not unload player: state transition in progress: $1",[Fe[this.state]]))}}async unloadManifest(){var e;if(this._playerState!==z.MANIFEST&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_MANIFEST,this.log.debug("Unloading paella player"),await Iu(),await hc(this),await cu(this),this._manifestLoaded=!1,(e=this._previewContainer)==null||e.removeFromParent(),this._preferences=null,this._playerState=z.UNLOADED,ga.apply(this.skin)}async unloadPlayer(){var e,t,i,s,r;if(this._playerState!==z.LOADED&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[Fe[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_PLAYER,await((e=this._videoContainer)==null?void 0:e.unload()),this._videoContainer=null,await((t=this._playbackBar)==null?void 0:t.unload()),this._playbackBar=null,(i=this._captionsCanvas)==null||i.unload(),this._captionsCanvas=null,Zn(this),J(this,F.PLAYER_UNLOADED),(r=(s=this.videoManifest)==null?void 0:s.metadata)!=null&&r.preview&&pa.apply(this),Hl(this),this._playerState=z.MANIFEST}async reload(e=null){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:await this.unload();break}typeof e=="function"&&await e(),await this.load()}async resize(){var e,t;if((e=this.videoContainer)==null||e.updateLayout(),(t=this.playbackBar)==null||t.onResize(),this.videoContainer){const i=()=>({w:this.videoContainer.element.offsetWidth,h:this.videoContainer.element.offsetHeight});J(this,F.RESIZE,{size:i()}),this._resizeEndTimer&&clearTimeout(this._resizeEndTimer),this._resizeEndTimer=setTimeout(()=>{J(this,F.RESIZE_END,{size:i()})},1e3)}}async hideUserInterface(){var e,t,i;await((e=this.videoContainer)==null?void 0:e.paused())||(this._uiHidden=!0,(t=this.videoContainer)==null||t.hideUserInterface(),(i=this.playbackBar)==null||i.hideUserInterface(),J(this,F.HIDE_UI))}async showUserInterface(){var e,t;(e=this.videoContainer)==null||e.showUserInterface(),(t=this.playbackBar)==null||t.showUserInterface(),this._uiHidden&&J(this,F.SHOW_UI),this._uiHidden=!1}async play(){this._loadKeypressHandler&&(window.removeEventListener("keypress",this._loadKeypressHandler,!0),this._loadKeypressHandler=null),this.videoContainer.ready||await this.loadPlayer(),await this.videoContainer.play()}async pause(){var e;await((e=this.videoContainer)==null?void 0:e.pause())}async paused(){return this.videoContainer?this.videoContainer.paused():!0}async stop(){var e;await((e=this.videoContainer)==null?void 0:e.stop())}isFullScreenSupported(){return this.containerElement.requestFullscreen||this.containerElement.webkitRequestFullScreen}async enterFullscreen(){let e=null;return this.containerElement.requestFullscreen?e=this.containerElement.requestFullscreen():this.containerElement.webkitRequestFullScreen&&(this.log.debug("Safari enter fullscreen"),e=this.containerElement.webkitRequestFullScreen()),setTimeout(()=>this.resize(),500),e}async exitFullscreen(){if(document.exitFullscreen&&this.isFullscreen)return document.exitFullscreen();if(document.webkitCancelFullScreen&&this.isFullscreen)return this.log.debug("Safari exit fullscreen"),document.webkitCancelFullScreen()}get isFullscreen(){return document.fullscreenElement===this.containerElement||document.webkitFullscreenElement===this.containerElement}addCustomPluginIcon(e,t,i){this._customPluginIcons[`${e}-${t}`]=i}removeCustomPluginIcon(e,t){this._customPluginIcons[`${e}-${t}`]=null}getCustomPluginIcon(e,t){return this._requestedCustomIcons=this._requestedCustomIcons||[],this._requestedCustomIcons.find(i=>i.pluginName===e&&i.iconName===t)||this._requestedCustomIcons.push({pluginName:e,iconName:t}),this._customPluginIcons[`${e}-${t}`]}get requestedCustomIcons(){return this._requestedCustomIcons||[]}}function Vu(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Ea={exports:{}};(function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var h=o.parseURL(l);if(!h)throw new Error("Error trying to parse base URL.");return h.path=o.normalizePath(h.path),o.buildURLFromParts(h)}var d=o.parseURL(c);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return u.alwaysNormalize?(d.path=o.normalizePath(d.path),o.buildURLFromParts(d)):c;var g=o.parseURL(l);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var f=s.exec(g.path);g.netLoc=f[1],g.path=f[2]}g.netLoc&&!g.path&&(g.path="/");var m={scheme:g.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(m.netLoc=g.netLoc,d.path[0]!=="/"))if(!d.path)m.path=g.path,d.params||(m.params=g.params,d.query||(m.query=g.query));else{var y=g.path,v=y.substring(0,y.lastIndexOf("/")+1)+d.path;m.path=o.normalizePath(v)}return m.path===null&&(m.path=u.alwaysNormalize?o.normalizePath(d.path):d.path),o.buildURLFromParts(m)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};n.exports=o})()})(Ea);var Hs=Ea.exports;function Ta(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function ge(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ta(Object(t),!0).forEach(function(i){Wu(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Ta(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function Hu(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Ku(n){var e=Hu(n,"string");return typeof e=="symbol"?e:String(e)}function Wu(n,e,t){return e=Ku(e),e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function he(){return he=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},he.apply(this,arguments)}const N=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},Yu=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=zu},zu=Number.MAX_SAFE_INTEGER||9007199254740991;let p=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n}({}),$=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),C=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.UNKNOWN="unknown",n}({});const vt=function(){},Ks={trace:vt,debug:vt,log:vt,warn:vt,info:vt,error:vt};let Qt=Ks;function qu(n){const e=self.console[n];return e?e.bind(self.console,`[${n}] >`):vt}function ju(n,...e){e.forEach(function(t){Qt[t]=n[t]?n[t].bind(n):qu(t)})}function Xu(n,e){if(typeof console=="object"&&n===!0||typeof n=="object"){ju(n,"debug","log","info","warn","error");try{Qt.log(`Debug logs enabled for "${e}" in hls.js version 1.5.1`)}catch{Qt=Ks}}else Qt=Ks}const L=Qt,Qu=/^(\d+)x(\d+)$/,Sa=/(.+?)=(".*?"|.*?)(?:,|$)/g;class oe{constructor(e){typeof e=="string"&&(e=oe.parseAttrList(e)),he(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Qu.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={},s='"';for(Sa.lastIndex=0;(t=Sa.exec(e))!==null;){let r=t[2];r.indexOf(s)===0&&r.lastIndexOf(s)===r.length-1&&(r=r.slice(1,-1));const a=t[1].trim();i[a]=r}return i}}function Zu(n){return n!=="ID"&&n!=="CLASS"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function Ju(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"}class Ws{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const s in i)if(Object.prototype.hasOwnProperty.call(e,s)&&e[s]!==i[s]){L.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=s;break}e=he(new oe({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);N(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return e!==null?new Date(this._startDate.getTime()+e*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(N(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&N(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Zt{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ie={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Ys{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[ie.AUDIO]:null,[ie.VIDEO]:null,[ie.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2);let s;i.length===1?s=(t==null?void 0:t.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Hs.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class pi extends Ys{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Zt,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!N(this.programDateTime))return null;const e=N(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,a=!1){const{elementaryStreams:o}=this,l=o[e];if(!l){o[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:a};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[ie.AUDIO]=null,e[ie.VIDEO]=null,e[ie.AUDIOVIDEO]=null}}class La extends Ys{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Zt,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const a=e.enumeratedString("BYTERANGE");a&&this.setByteRange(a,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const eh=10;class xa{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?N(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||eh}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function zs(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function th(n){const e=qs(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function ih(n){const e=function(i,s,r){const a=i[s];i[s]=i[r],i[r]=a};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function sh(n){const e=n.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",a=s[1];r?(i.splice(-1,1),t=zs(a)):t=th(a)}}return t}function qs(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}const Dt=typeof self<"u"?self:void 0;var ae={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},xe={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function _a(n){switch(n){case xe.FAIRPLAY:return ae.FAIRPLAY;case xe.PLAYREADY:return ae.PLAYREADY;case xe.WIDEVINE:return ae.WIDEVINE;case xe.CLEARKEY:return ae.CLEARKEY}}var Ca={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function nh(n){if(n===Ca.WIDEVINE)return ae.WIDEVINE}function ba(n){switch(n){case ae.FAIRPLAY:return xe.FAIRPLAY;case ae.PLAYREADY:return xe.PLAYREADY;case ae.WIDEVINE:return xe.WIDEVINE;case ae.CLEARKEY:return xe.CLEARKEY}}function js(n){const{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[ae.FAIRPLAY,ae.WIDEVINE,ae.PLAYREADY,ae.CLEARKEY].filter(s=>!!e[s]):[];return!i[ae.WIDEVINE]&&t&&i.push(ae.WIDEVINE),i}const wa=function(n){return Dt!=null&&(n=Dt.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function rh(n,e,t,i){let s;switch(n){case ae.FAIRPLAY:s=["cenc","sinf"];break;case ae.WIDEVINE:case ae.PLAYREADY:s=["cenc"];break;case ae.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return ah(s,e,t,i)}function ah(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs="${r}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs="${r}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function Et(n,e,t){return Uint8Array.prototype.slice?n.slice(e,t):new Uint8Array(Array.prototype.slice.call(n,e,t))}const Xs=(n,e)=>e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,Aa=(n,e)=>e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,Jt=(n,e)=>{const t=e;let i=0;for(;Xs(n,e);){i+=10;const s=yi(n,e+6);i+=s,Aa(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)},yi=(n,e)=>{let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t},oh=(n,e)=>Xs(n,e)&&yi(n,e+6)+10<=n.length-e,Qs=n=>{const e=Ia(n);for(let t=0;t<e.length;t++){const i=e[t];if(Ra(i))return fh(i)}},Ra=n=>n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp",lh=n=>{const e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=yi(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}},Ia=n=>{let e=0;const t=[];for(;Xs(n,e);){const i=yi(n,e+6);e+=10;const s=e+i;for(;e+8<s;){const r=lh(n.subarray(e)),a=ch(r);a&&t.push(a),e+=r.size+10}Aa(n,e)&&(e+=10)}return t},ch=n=>n.type==="PRIV"?uh(n):n.type[0]==="W"?dh(n):hh(n),uh=n=>{if(n.size<2)return;const e=Be(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}},hh=n=>{if(n.size<2)return;if(n.type==="TXXX"){let t=1;const i=Be(n.data.subarray(t),!0);t+=i.length+1;const s=Be(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Be(n.data.subarray(1));return{key:n.type,data:e}},dh=n=>{if(n.type==="WXXX"){if(n.size<2)return;let t=1;const i=Be(n.data.subarray(t),!0);t+=i.length+1;const s=Be(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Be(n.data);return{key:n.type,data:e}},fh=n=>{if(n.data.byteLength===8){const e=new Uint8Array(n.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}},Be=(n,e=!1)=>{const t=gh();if(t){const c=t.decode(n);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const i=n.length;let s,r,a,o="",l=0;for(;l<i;){if(s=n[l++],s===0&&e)return o;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:r=n[l++],o+=String.fromCharCode((s&31)<<6|r&63);break;case 14:r=n[l++],a=n[l++],o+=String.fromCharCode((s&15)<<12|(r&63)<<6|(a&63)<<0);break}}return o};let Zs;function gh(){if(!navigator.userAgent.includes("PlayStation 4"))return!Zs&&typeof self.TextDecoder<"u"&&(Zs=new self.TextDecoder("utf-8")),Zs}const $e={hexDump:function(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}},vi=Math.pow(2,32)-1,mh=[].push,Da={video:1,audio:2,id3:3,text:4};function de(n){return String.fromCharCode.apply(null,n)}function Pa(n,e){const t=n[e]<<8|n[e+1];return t<0?65536+t:t}function G(n,e){const t=ka(n,e);return t<0?4294967296+t:t}function ka(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function Js(n,e,t){n[e]=t>>24,n[e+1]=t>>16&255,n[e+2]=t>>8&255,n[e+3]=t&255}function ph(n){const e=n.byteLength;for(let t=0;t<e;){const i=G(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function K(n,e){const t=[];if(!e.length)return t;const i=n.byteLength;for(let s=0;s<i;){const r=G(n,s),a=de(n.subarray(s+4,s+8)),o=r>1?s+r:i;if(a===e[0])if(e.length===1)t.push(n.subarray(s+8,o));else{const l=K(n.subarray(s+8,o),e.slice(1));l.length&&mh.apply(t,l)}s=o}return t}function yh(n){const e=[],t=n[0];let i=8;const s=G(n,i);i+=4;const r=0,a=0;t===0?i+=8:i+=16,i+=2;let o=n.length+a;const l=Pa(n,i);i+=2;for(let c=0;c<l;c++){let u=i;const h=G(n,u);u+=4;const d=h&2147483647;if((h&2147483648)>>>31===1)return L.warn("SIDX has hierarchical references (not supported)"),null;const f=G(n,u);u+=4,e.push({referenceSize:d,subsegmentDuration:f,info:{duration:f/s,start:o,end:o+d-1}}),o+=d,u+=4,i=u}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:l,references:e}}function Fa(n){const e=[],t=K(n,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],a=K(r,["tkhd"])[0];if(a){let o=a[0];const l=G(a,o===0?12:20),c=K(r,["mdia","mdhd"])[0];if(c){o=c[0];const u=G(c,o===0?12:20),h=K(r,["mdia","hdlr"])[0];if(h){const d=de(h.subarray(8,12)),g={soun:ie.AUDIO,vide:ie.VIDEO}[d];if(g){const f=K(r,["mdia","minf","stbl","stsd"])[0],m=vh(f);e[l]={timescale:u,type:g},e[g]=ge({timescale:u,id:l},m)}}}}}return K(n,["moov","mvex","trex"]).forEach(s=>{const r=G(s,4),a=e[r];a&&(a.default={duration:G(s,12),flags:G(s,20)})}),e}function vh(n){const e=n.subarray(8),t=e.subarray(86),i=de(e.subarray(4,8));let s=i;const r=i==="enca"||i==="encv";if(r){const o=K(e,[i])[0].subarray(i==="enca"?28:78);K(o,["sinf"]).forEach(c=>{const u=K(c,["schm"])[0];if(u){const h=de(u.subarray(4,8));if(h==="cbcs"||h==="cenc"){const d=K(c,["frma"])[0];d&&(s=de(d))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const a=K(t,["avcC"])[0];s+="."+Ei(a[1])+Ei(a[2])+Ei(a[3]);break}case"mp4a":{const a=K(e,[i])[0],o=K(a.subarray(28),["esds"])[0];if(o&&o.length>12){let l=4;if(o[l++]!==3)break;l=en(o,l),l+=2;const c=o[l++];if(c&128&&(l+=2),c&64&&(l+=o[l++]),o[l++]!==4)break;l=en(o,l);const u=o[l++];if(u===64)s+="."+Ei(u);else break;if(l+=12,o[l++]!==5)break;l=en(o,l);const h=o[l++];let d=(h&248)>>3;d===31&&(d+=1+((h&7)<<3)+((o[l]&224)>>5)),s+="."+d}break}case"hvc1":case"hev1":{const a=K(t,["hvcC"])[0],o=a[1],l=["","A","B","C"][o>>6],c=o&31,u=G(a,2),h=(o&32)>>5?"H":"L",d=a[12],g=a.subarray(6,12);s+="."+l+c,s+="."+u.toString(16).toUpperCase(),s+="."+h+d;let f="";for(let m=g.length;m--;){const y=g[m];(y||f)&&(f="."+y.toString(16).toUpperCase()+f)}s+=f;break}case"dvh1":case"dvhe":{const a=K(t,["dvcC"])[0],o=a[2]>>1&127,l=a[2]<<5&32|a[3]>>3&31;s+="."+Ge(o)+"."+Ge(l);break}case"vp09":{const a=K(t,["vpcC"])[0],o=a[4],l=a[5],c=a[6]>>4&15;s+="."+Ge(o)+"."+Ge(l)+"."+Ge(c);break}case"av01":{const a=K(t,["av1C"])[0],o=a[1]>>>5,l=a[1]&31,c=a[2]>>>7?"H":"M",u=(a[2]&64)>>6,h=(a[2]&32)>>5,d=o===2&&u?h?12:10:u?10:8,g=(a[2]&16)>>4,f=(a[2]&8)>>3,m=(a[2]&4)>>2,y=a[2]&3;s+="."+o+"."+Ge(l)+c+"."+Ge(d)+"."+g+"."+f+m+y+"."+Ge(1)+"."+Ge(1)+"."+Ge(1)+"."+0;break}}return{codec:s,encrypted:r}}function en(n,e){const t=e+5;for(;n[e++]&128&&e<t;);return e}function Ei(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Ge(n){return(n<10?"0":"")+n}function Eh(n,e){if(!n||!e)return n;const t=e.keyId;return t&&e.isCommonEncryption&&K(n,["moov","trak"]).forEach(s=>{const a=K(s,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=K(a,["enca"]);const l=o.length>0;l||(o=K(a,["encv"])),o.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);K(u,["sinf"]).forEach(d=>{const g=Ma(d);if(g){const f=g.subarray(8,24);f.some(m=>m!==0)||(L.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${$e.hexDump(f)} -> ${$e.hexDump(t)}`),g.set(t,8))}})})}),n}function Ma(n){const e=K(n,["schm"])[0];if(e){const t=de(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return K(n,["schi","tenc"])[0]}return L.error("[eme] missing 'schm' box"),null}function Th(n,e){return K(e,["moof","traf"]).reduce((t,i)=>{const s=K(i,["tfdt"])[0],r=s[0],a=K(i,["tfhd"]).reduce((o,l)=>{const c=G(l,4),u=n[c];if(u){let h=G(s,4);if(r===1){if(h===vi)return L.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;h*=vi+1,h+=G(s,8)}const d=u.timescale||9e4,g=h/d;if(N(g)&&(o===null||g<o))return g}return o},null);return a!==null&&N(a)&&(t===null||a<t)?a:t},null)}function Sh(n,e){let t=0,i=0,s=0;const r=K(n,["moof","traf"]);for(let a=0;a<r.length;a++){const o=r[a],l=K(o,["tfhd"])[0],c=G(l,4),u=e[c];if(!u)continue;const h=u.default,d=G(l,0)|(h==null?void 0:h.flags);let g=h==null?void 0:h.duration;d&8&&(d&2?g=G(l,12):g=G(l,8));const f=u.timescale||9e4,m=K(o,["trun"]);for(let y=0;y<m.length;y++){if(t=Lh(m[y]),!t&&g){const v=G(m[y],4);t=g*v}u.type===ie.VIDEO?i+=t/f:u.type===ie.AUDIO&&(s+=t/f)}}if(i===0&&s===0){let a=0;const o=K(n,["sidx"]);for(let l=0;l<o.length;l++){const c=yh(o[l]);c!=null&&c.references&&(a+=c.references.reduce((u,h)=>u+h.info.duration||0,0))}return a}return i||s}function Lh(n){const e=G(n,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const s=G(n,4);for(let r=0;r<s;r++){if(e&256){const a=G(n,t);i+=a,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function xh(n,e,t){K(e,["moof","traf"]).forEach(i=>{K(i,["tfhd"]).forEach(s=>{const r=G(s,4),a=n[r];if(!a)return;const o=a.timescale||9e4;K(i,["tfdt"]).forEach(l=>{const c=l[0],u=t*o;if(u){let h=G(l,4);if(c===0)h-=u,h=Math.max(h,0),Js(l,4,h);else{h*=Math.pow(2,32),h+=G(l,8),h-=u,h=Math.max(h,0);const d=Math.floor(h/(vi+1)),g=Math.floor(h%(vi+1));Js(l,4,d),Js(l,8,g)}}})})})}function _h(n){const e={valid:null,remainder:null},t=K(n,["moof"]);if(t.length<2)return e.remainder=n,e;const i=t[t.length-1];return e.valid=Et(n,0,i.byteOffset-8),e.remainder=Et(n,i.byteOffset-8),e}function Ae(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Oa(n,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let a=!1;return K(i,["moof"]).map(l=>{const c=l.byteOffset-8;K(l,["traf"]).map(h=>{const d=K(h,["tfdt"]).map(g=>{const f=g[0];let m=G(g,4);return f===1&&(m*=Math.pow(2,32),m+=G(g,8)),m/s})[0];return d!==void 0&&(n=d),K(h,["tfhd"]).map(g=>{const f=G(g,4),m=G(g,0)&16777215,y=(m&1)!==0,v=(m&2)!==0,E=(m&8)!==0;let T=0;const _=(m&16)!==0;let S=0;const w=(m&32)!==0;let b=8;f===r&&(y&&(b+=8),v&&(b+=4),E&&(T=G(g,b),b+=4),_&&(S=G(g,b),b+=4),w&&(b+=4),e.type==="video"&&(a=Ch(e.codec)),K(h,["trun"]).map(D=>{const k=D[0],R=G(D,0)&16777215,P=(R&1)!==0;let W=0;const M=(R&4)!==0,H=(R&256)!==0;let ee=0;const Y=(R&512)!==0;let V=0;const le=(R&1024)!==0,O=(R&2048)!==0;let U=0;const Z=G(D,4);let j=8;P&&(W=G(D,j),j+=4),M&&(j+=4);let te=W+c;for(let be=0;be<Z;be++){if(H?(ee=G(D,j),j+=4):ee=T,Y?(V=G(D,j),j+=4):V=S,le&&(j+=4),O&&(k===0?U=G(D,j):U=ka(D,j),j+=4),e.type===ie.VIDEO){let ve=0;for(;ve<V;){const ce=G(i,te);if(te+=4,bh(a,i[te])){const Ze=i.subarray(te,te+ce);Na(Ze,a?2:1,n+U/s,t)}te+=ce,ve+=ce+4}}n+=ee/s}}))})})}),t}function Ch(n){if(!n)return!1;const e=n.indexOf("."),t=e<0?n:n.substring(0,e);return t==="hvc1"||t==="hev1"||t==="dvh1"||t==="dvhe"}function bh(n,e){if(n){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Na(n,e,t,i){const s=Ua(n);let r=0;r+=e;let a=0,o=0,l=0;for(;r<s.length;){a=0;do{if(r>=s.length)break;l=s[r++],a+=l}while(l===255);o=0;do{if(r>=s.length)break;l=s[r++],o+=l}while(l===255);const c=s.length-r;let u=r;if(o<c)r+=o;else if(o>c){L.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(s[u++]===181){const d=Pa(s,u);if(u+=2,d===49){const g=G(s,u);if(u+=4,g===1195456820){const f=s[u++];if(f===3){const m=s[u++],y=31&m,v=64&m,E=v?2+y*3:0,T=new Uint8Array(E);if(v){T[0]=m;for(let _=1;_<E;_++)T[_]=s[u++]}i.push({type:f,payloadType:a,pts:t,bytes:T})}}}}}else if(a===5&&o>16){const h=[];for(let f=0;f<16;f++){const m=s[u++].toString(16);h.push(m.length==1?"0"+m:m),(f===3||f===5||f===7||f===9)&&h.push("-")}const d=o-16,g=new Uint8Array(d);for(let f=0;f<d;f++)g[f]=s[u++];i.push({payloadType:a,pts:t,uuid:h.join(""),userData:Be(g),userDataBytes:g})}}}function Ua(n){const e=n.byteLength,t=[];let i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;const s=e-t.length,r=new Uint8Array(s);let a=0;for(i=0;i<s;a++,i++)a===t[0]&&(a++,t.shift()),r[i]=n[a];return r}function wh(n){const e=n[0];let t="",i="",s=0,r=0,a=0,o=0,l=0,c=0;if(e===0){for(;de(n.subarray(c,c+1))!=="\0";)t+=de(n.subarray(c,c+1)),c+=1;for(t+=de(n.subarray(c,c+1)),c+=1;de(n.subarray(c,c+1))!=="\0";)i+=de(n.subarray(c,c+1)),c+=1;i+=de(n.subarray(c,c+1)),c+=1,s=G(n,12),r=G(n,16),o=G(n,20),l=G(n,24),c=28}else if(e===1){c+=4,s=G(n,c),c+=4;const h=G(n,c);c+=4;const d=G(n,c);for(c+=4,a=2**32*h+d,Yu(a)||(a=Number.MAX_SAFE_INTEGER,L.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=G(n,c),c+=4,l=G(n,c),c+=4;de(n.subarray(c,c+1))!=="\0";)t+=de(n.subarray(c,c+1)),c+=1;for(t+=de(n.subarray(c,c+1)),c+=1;de(n.subarray(c,c+1))!=="\0";)i+=de(n.subarray(c,c+1)),c+=1;i+=de(n.subarray(c,c+1)),c+=1}const u=n.subarray(c,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:a,presentationTimeDelta:r,eventDuration:o,id:l,payload:u}}function Ah(n,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function Rh(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;if(e){i=1,s=new Uint8Array(e.length*16);for(let o=0;o<e.length;o++){const l=e[o];if(l.byteLength!==16)throw new RangeError("Invalid key");s.set(l,o*16)}}else i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const a=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(a.buffer).setUint32(0,t.byteLength,!1),Ah([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,a,t||new Uint8Array)}function Ih(n){if(!(n instanceof ArrayBuffer)||n.byteLength<32)return null;const e={version:0,systemId:"",kids:null,data:null},t=new DataView(n),i=t.getUint32(0);if(n.byteLength!==i&&i>44||t.getUint32(4)!==1886614376||(e.version=t.getUint32(8)>>>24,e.version>1))return null;e.systemId=$e.hexDump(new Uint8Array(n,12,16));const r=t.getUint32(28);if(e.version===0){if(i-32<r)return null;e.data=new Uint8Array(n,32,r)}else if(e.version===1){e.kids=[];for(let a=0;a<r;a++)e.kids.push(new Uint8Array(n,32+a*16,16))}return e}let Ti={};class Pt{static clearKeyUriToKeyIdMap(){Ti={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&e!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case xe.FAIRPLAY:case xe.WIDEVINE:case xe.PLAYREADY:case xe.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof e!="number"&&(this.method==="AES-128"&&!this.iv&&L.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=Dh(e);return new Pt(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=sh(this.uri);if(t)switch(this.keyFormat){case xe.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case xe.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Rh(i,null,t);const s=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(s)),a=r.substring(r.indexOf("<"),r.length),c=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("KID")[0];if(c){const u=c.childNodes[0]?c.childNodes[0].nodeValue:c.getAttribute("VALUE");if(u){const h=zs(u).subarray(0,16);ih(h),this.keyId=h}}break}default:{let i=t.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=Ti[this.uri];if(!i){const s=Object.keys(Ti).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),Ti[this.uri]=i}this.keyId=i}return this}}function Dh(n){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}const Ba=/\{\$([a-zA-Z0-9-_]+)\}/g;function $a(n){return Ba.test(n)}function Ce(n,e,t){if(n.variableList!==null||n.hasVariableRefs)for(let i=t.length;i--;){const s=t[i],r=e[s];r&&(e[s]=tn(n,r))}}function tn(n,e){if(n.variableList!==null||n.hasVariableRefs){const t=n.variableList;return e.replace(Ba,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function Ga(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const a=new self.URL(t).searchParams;if(a.has(s))r=a.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(a){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${a.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function Ph(n,e,t){const i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function Tt(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const Si={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function kh(n,e){const t=Si[e];return!!t&&!!t[n.slice(0,4)]}function sn(n,e,t=!0){return!n.split(",").some(i=>!Va(i,e,t))}function Va(n,e,t=!0){var i;const s=Tt(t);return(i=s==null?void 0:s.isTypeSupported(ei(n,e)))!=null?i:!1}function ei(n,e){return`${e}/mp4;codecs="${n}"`}function Ha(n){if(n){const e=n.substring(0,4);return Si.video[e]}return 2}function Li(n){return n.split(",").reduce((e,t)=>{const i=Si.video[t];return i?(i*2+e)/(e?3:2):(Si.audio[t]+e)/(e?2:1)},0)}const nn={};function Fh(n,e=!0){if(nn[n])return nn[n];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[n];for(let i=0;i<t.length;i++)if(Va(t[i],"audio",e))return nn[n]=t[i],t[i];return n}const Mh=/flac|opus/i;function xi(n,e=!0){return n.replace(Mh,t=>Fh(t.toLowerCase(),e))}function Ka(n,e){return n&&n!=="mp4a"?n:e}function Oh(n){const e=n.split(".");if(e.length>2){let t=e.shift()+".";return t+=parseInt(e.shift()).toString(16),t+=("000"+parseInt(e.shift()).toString(16)).slice(-4),t}return n}const Wa=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Ya=/#EXT-X-MEDIA:(.*)/g,Nh=/^#EXT(?:INF|-X-TARGETDURATION):/m,za=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Uh=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Ve{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static resolve(e,t){return Hs.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return Nh.test(e)}static parseMasterPlaylist(e,t){const i=$a(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];Wa.lastIndex=0;let a;for(;(a=Wa.exec(e))!=null;)if(a[1]){var o;const c=new oe(a[1]);Ce(s,c,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const u=tn(s,a[2]),h={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:Ve.resolve(u,t)},d=c.decimalResolution("RESOLUTION");d&&(h.width=d.width,h.height=d.height),Bh(c.CODECS,h),(o=h.unknownCodecs)!=null&&o.length||r.push(h),s.levels.push(h)}else if(a[3]){const c=a[3],u=a[4];switch(c){case"SESSION-DATA":{const h=new oe(u);Ce(s,h,["DATA-ID","LANGUAGE","VALUE","URI"]);const d=h["DATA-ID"];d&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[d]=h);break}case"SESSION-KEY":{const h=qa(u,t,s);h.encrypted&&h.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(h)):L.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new oe(u);Ce(s,h,["NAME","VALUE","QUERYPARAM"]),Ga(s,h,t)}break}case"CONTENT-STEERING":{const h=new oe(u);Ce(s,h,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:Ve.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=ja(u);break}}}const l=r.length>0&&r.length<s.levels.length;return s.levels=l?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},a=i.levels,o={AUDIO:a.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:a.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(Ya.lastIndex=0;(s=Ya.exec(e))!==null;){const c=new oe(s[1]),u=c.TYPE;if(u){const h=o[u],d=r[u]||[];r[u]=d,Ce(i,c,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const g=c.LANGUAGE,f=c["ASSOC-LANGUAGE"],m=c.CHANNELS,y=c.CHARACTERISTICS,v=c["INSTREAM-ID"],E={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||g||"",type:u,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:g,url:c.URI?Ve.resolve(c.URI,t):""};if(f&&(E.assocLang=f),m&&(E.channels=m),y&&(E.characteristics=y),v&&(E.instreamId=v),h!=null&&h.length){const T=Ve.findGroup(h,E.groupId)||h[0];Xa(E,T,"audioCodec"),Xa(E,T,"textCodec")}d.push(E)}}return r}static parseLevelPlaylist(e,t,i,s,r,a){const o=new xa(t),l=o.fragments;let c=null,u=0,h=0,d=0,g=0,f=null,m=new pi(s,t),y,v,E,T=-1,_=!1,S=null;for(za.lastIndex=0,o.m3u8=e,o.hasVariableRefs=$a(e);(y=za.exec(e))!==null;){_&&(_=!1,m=new pi(s,t),m.start=d,m.sn=u,m.cc=g,m.level=i,c&&(m.initSegment=c,m.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null,S&&(m.setByteRange(S),S=null)));const k=y[1];if(k){m.duration=parseFloat(k);const R=(" "+y[2]).slice(1);m.title=R||null,m.tagList.push(R?["INF",k,R]:["INF",k])}else if(y[3]){if(N(m.duration)){m.start=d,E&&Ja(m,E,o),m.sn=u,m.level=i,m.cc=g,l.push(m);const R=(" "+y[3]).slice(1);m.relurl=tn(o,R),Qa(m,f),f=m,d+=m.duration,u++,h=0,_=!0}}else if(y[4]){const R=(" "+y[4]).slice(1);f?m.setByteRange(R,f):m.setByteRange(R)}else if(y[5])m.rawProgramDateTime=(" "+y[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),T===-1&&(T=l.length);else{if(y=y[0].match(Uh),!y){L.warn("No matches on slow regex match for level playlist!");continue}for(v=1;v<y.length&&!(typeof y[v]<"u");v++);const R=(" "+y[v]).slice(1),P=(" "+y[v+1]).slice(1),W=y[v+2]?(" "+y[v+2]).slice(1):"";switch(R){case"PLAYLIST-TYPE":o.type=P.toUpperCase();break;case"MEDIA-SEQUENCE":u=o.startSN=parseInt(P);break;case"SKIP":{const M=new oe(P);Ce(o,M,["RECENTLY-REMOVED-DATERANGES"]);const H=M.decimalInteger("SKIPPED-SEGMENTS");if(N(H)){o.skippedSegments=H;for(let Y=H;Y--;)l.unshift(null);u+=H}const ee=M.enumeratedString("RECENTLY-REMOVED-DATERANGES");ee&&(o.recentlyRemovedDateranges=ee.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(P),1);break;case"VERSION":o.version=parseInt(P);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(P||W)&&m.tagList.push(W?[P,W]:[P]);break;case"DISCONTINUITY":g++,m.tagList.push(["DIS"]);break;case"GAP":m.gap=!0,m.tagList.push([R]);break;case"BITRATE":m.tagList.push([R,P]);break;case"DATERANGE":{const M=new oe(P);Ce(o,M,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),Ce(o,M,M.clientAttrs);const H=new Ws(M,o.dateRanges[M.ID]);H.isValid||o.skippedSegments?o.dateRanges[H.id]=H:L.warn(`Ignoring invalid DATERANGE tag: "${P}"`),m.tagList.push(["EXT-X-DATERANGE",P]);break}case"DEFINE":{{const M=new oe(P);Ce(o,M,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in M?Ph(o,M,a):Ga(o,M,t)}break}case"DISCONTINUITY-SEQUENCE":g=parseInt(P);break;case"KEY":{const M=qa(P,t,o);if(M.isSupported()){if(M.method==="NONE"){E=void 0;break}E||(E={}),E[M.keyFormat]&&(E=he({},E)),E[M.keyFormat]=M}else L.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${P}"`);break}case"START":o.startTimeOffset=ja(P);break;case"MAP":{const M=new oe(P);if(Ce(o,M,["BYTERANGE","URI"]),m.duration){const H=new pi(s,t);Za(H,M,i,E),c=H,m.initSegment=c,c.rawProgramDateTime&&!m.rawProgramDateTime&&(m.rawProgramDateTime=c.rawProgramDateTime)}else{const H=m.byteRangeEndOffset;if(H){const ee=m.byteRangeStartOffset;S=`${H-ee}@${ee}`}else S=null;Za(m,M,i,E),c=m,_=!0}break}case"SERVER-CONTROL":{const M=new oe(P);o.canBlockReload=M.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=M.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&M.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=M.optionalFloat("PART-HOLD-BACK",0),o.holdBack=M.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const M=new oe(P);o.partTarget=M.decimalFloatingPoint("PART-TARGET");break}case"PART":{let M=o.partList;M||(M=o.partList=[]);const H=h>0?M[M.length-1]:void 0,ee=h++,Y=new oe(P);Ce(o,Y,["BYTERANGE","URI"]);const V=new La(Y,m,t,ee,H);M.push(V),m.duration+=V.duration;break}case"PRELOAD-HINT":{const M=new oe(P);Ce(o,M,["URI"]),o.preloadHint=M;break}case"RENDITION-REPORT":{const M=new oe(P);Ce(o,M,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(M);break}default:L.warn(`line parsed but not handled: ${y}`);break}}}f&&!f.relurl?(l.pop(),d-=f.duration,o.partList&&(o.fragmentHint=f)):o.partList&&(Qa(m,f),m.cc=g,o.fragmentHint=m,E&&Ja(m,E,o));const w=l.length,b=l[0],D=l[w-1];if(d+=o.skippedSegments*o.targetduration,d>0&&w&&D){o.averagetargetduration=d/w;const k=D.sn;o.endSN=k!=="initSegment"?k:0,o.live||(D.endList=!0),b&&(o.startCC=b.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(d+=o.fragmentHint.duration),o.totalduration=d,o.endCC=g,T>0&&$h(l,T),o}}function qa(n,e,t){var i,s;const r=new oe(n);Ce(t,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=(i=r.METHOD)!=null?i:"",o=r.URI,l=r.hexadecimalInteger("IV"),c=r.KEYFORMATVERSIONS,u=(s=r.KEYFORMAT)!=null?s:"identity";o&&r.IV&&!l&&L.error(`Invalid IV: ${r.IV}`);const h=o?Ve.resolve(o,e):"",d=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Pt(a,h,u,d,l)}function ja(n){const t=new oe(n).decimalFloatingPoint("TIME-OFFSET");return N(t)?t:null}function Bh(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=t.filter(r=>kh(r,i));s.length&&(e[`${i}Codec`]=s.join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function Xa(n,e,t){const i=e[t];i&&(n[t]=i)}function $h(n,e){let t=n[e];for(let i=e;i--;){const s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function Qa(n,e){n.rawProgramDateTime?n.programDateTime=Date.parse(n.rawProgramDateTime):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime),N(n.programDateTime)||(n.programDateTime=null,n.rawProgramDateTime=null)}function Za(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function Ja(n,e,t){n.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}var Q={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},B={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function eo(n){const{type:e}=n;switch(e){case Q.AUDIO_TRACK:return B.AUDIO;case Q.SUBTITLE_TRACK:return B.SUBTITLE;default:return B.MAIN}}function rn(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class Gh{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,a=new r(t);return this.loaders[e.type]=a,a}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Q.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:s,pathwayId:r,url:a,deliveryDirectives:o}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:Q.LEVEL,url:a,deliveryDirectives:o})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.AUDIO_TRACK,url:r,deliveryDirectives:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.SUBTITLE_TRACK,url:r,deliveryDirectives:a})}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const c=s.context;if(c&&c.url===e.url&&c.level===e.level){L.trace("[playlist-loader]: playlist request ongoing");return}L.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===Q.MANIFEST?r=i.manifestLoadPolicy.default:r=he({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),N((t=e.deliveryDirectives)==null?void 0:t.part)){let c;if(e.type===Q.LEVEL&&e.level!==null?c=this.hls.levels[e.level].details:e.type===Q.AUDIO_TRACK&&e.id!==null?c=this.hls.audioTracks[e.id].details:e.type===Q.SUBTITLE_TRACK&&e.id!==null&&(c=this.hls.subtitleTracks[e.id].details),c){const u=c.partTarget,h=c.targetduration;if(u&&h){const d=Math.max(u*3,h*.8)*1e3;r=he({},r,{maxTimeToFirstByteMs:Math.min(d,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(d,r.maxTimeToFirstByteMs)})}}}const a=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(c,u,h,d)=>{const g=this.getInternalLoader(h);this.resetInternalLoader(h.type);const f=c.data;if(f.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(c,h,new Error("no EXTM3U delimiter"),d||null,u);return}u.parsing.start=performance.now(),Ve.isMediaPlaylist(f)?this.handleTrackOrLevelPlaylist(c,u,h,d||null,g):this.handleMasterPlaylist(c,u,h,d)},onError:(c,u,h,d)=>{this.handleNetworkError(u,h,!1,c,d)},onTimeout:(c,u,h)=>{this.handleNetworkError(u,h,!0,void 0,c)}};s.load(e,o,l)}handleMasterPlaylist(e,t,i,s){const r=this.hls,a=e.data,o=rn(e,i),l=Ve.parseMasterPlaylist(a,o);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,s,t);return}const{contentSteering:c,levels:u,sessionData:h,sessionKeys:d,startTimeOffset:g,variableList:f}=l;this.variableList=f;const{AUDIO:m=[],SUBTITLES:y,"CLOSED-CAPTIONS":v}=Ve.parseMasterPlaylistMedia(a,o,l);m.length&&!m.some(T=>!T.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(L.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new oe({}),bitrate:0,url:""})),r.trigger(p.MANIFEST_LOADED,{levels:u,audioTracks:m,subtitles:y,captions:v,contentSteering:c,url:o,stats:t,networkDetails:s,sessionData:h,sessionKeys:d,startTimeOffset:g,variableList:f})}handleTrackOrLevelPlaylist(e,t,i,s,r){const a=this.hls,{id:o,level:l,type:c}=i,u=rn(e,i),h=0,d=N(l)?l:N(o)?o:0,g=eo(i),f=Ve.parseLevelPlaylist(e.data,u,d,g,h,this.variableList);if(c===Q.MANIFEST){const m={attrs:new oe({}),bitrate:0,details:f,name:"",url:u};a.trigger(p.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=f,this.handlePlaylistLoaded(f,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(p.ERROR,{type:$.NETWORK_ERROR,details:C.MANIFEST_PARSING_ERROR,fatal:t.type===Q.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let a=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===Q.LEVEL?a+=`: ${e.level} id: ${e.id}`:(e.type===Q.AUDIO_TRACK||e.type===Q.SUBTITLE_TRACK)&&(a+=` id: ${e.id} group-id: "${e.groupId}"`);const o=new Error(a);L.warn(`[playlist-loader]: ${a}`);let l=C.UNKNOWN,c=!1;const u=this.getInternalLoader(e);switch(e.type){case Q.MANIFEST:l=i?C.MANIFEST_LOAD_TIMEOUT:C.MANIFEST_LOAD_ERROR,c=!0;break;case Q.LEVEL:l=i?C.LEVEL_LOAD_TIMEOUT:C.LEVEL_LOAD_ERROR,c=!1;break;case Q.AUDIO_TRACK:l=i?C.AUDIO_TRACK_LOAD_TIMEOUT:C.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case Q.SUBTITLE_TRACK:l=i?C.SUBTITLE_TRACK_LOAD_TIMEOUT:C.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(e.type);const h={type:$.NETWORK_ERROR,details:l,fatal:c,url:e.url,loader:u,context:e,error:o,networkDetails:t,stats:r};if(s){const d=(t==null?void 0:t.url)||e.url;h.response=ge({url:d,data:void 0},s)}this.hls.trigger(p.ERROR,h)}handlePlaylistLoaded(e,t,i,s,r,a){const o=this.hls,{type:l,level:c,id:u,groupId:h,deliveryDirectives:d}=s,g=rn(t,s),f=eo(s),m=typeof s.level=="number"&&f===B.MAIN?c:void 0;if(!e.fragments.length){const v=new Error("No Segments found in Playlist");o.trigger(p.ERROR,{type:$.NETWORK_ERROR,details:C.LEVEL_EMPTY_ERROR,fatal:!1,url:g,error:v,reason:v.message,response:t,context:s,level:m,parent:f,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const y=e.playlistParsingError;if(y){o.trigger(p.ERROR,{type:$.NETWORK_ERROR,details:C.LEVEL_PARSING_ERROR,fatal:!1,url:g,error:y,reason:y.message,response:t,context:s,level:m,parent:f,networkDetails:r,stats:i});return}switch(e.live&&a&&(a.getCacheAge&&(e.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case Q.MANIFEST:case Q.LEVEL:o.trigger(p.LEVEL_LOADED,{details:e,level:m||0,id:u||0,stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.AUDIO_TRACK:o.trigger(p.AUDIO_TRACK_LOADED,{details:e,id:u||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.SUBTITLE_TRACK:o.trigger(p.SUBTITLE_TRACK_LOADED,{details:e,id:u||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:d});break}}}function to(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function io(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){L.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){L.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function kt(n){const e=n.mode;if(e==="disabled"&&(n.mode="hidden"),n.cues)for(let t=n.cues.length;t--;)n.removeCue(n.cues[t]);e==="disabled"&&(n.mode=e)}function an(n,e,t,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=Hh(n.cues,e,t);for(let a=0;a<r.length;a++)(!i||i(r[a]))&&n.removeCue(r[a])}s==="disabled"&&(n.mode=s)}function Vh(n,e){if(e<n[0].startTime)return 0;const t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t;for(;i<=s;){const r=Math.floor((s+i)/2);if(e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r}return n[i].startTime-e<e-n[s].startTime?i:s}function Hh(n,e,t){const i=[],s=Vh(n,e);if(s>-1)for(let r=s,a=n.length;r<a;r++){const o=n[r];if(o.startTime>=e&&o.endTime<=t)i.push(o);else if(o.startTime>t)return i}return i}function _i(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}var Re={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const Kh=.25;function on(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function so(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,JSON.stringify(s?ge({type:s},i):i))}return r}const Ci=(()=>{const n=on();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function ln(n,e){return n.getTime()/1e3-e}function Wh(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class Yh{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(kt(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return to(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=on();if(a)for(let o=0;o<r.length;o++){const l=r[o].type;if(l===Re.emsg&&!i||!s)continue;const c=Ia(r[o].data);if(c){const u=r[o].pts;let h=u+r[o].duration;h>Ci&&(h=Ci),h-u<=0&&(h=u+Kh);for(let g=0;g<c.length;g++){const f=c[g];if(!Ra(f)){this.updateId3CueEnds(u,l);const m=so(a,u,h,f,l);m&&this.id3Track.addCue(m)}}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const a=s[r];a.type===t&&a.startTime<e&&a.endTime===Ci&&(a.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:a}=this;if(!a)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=a;if(r&&(o||l)){let c;s==="audio"?c=u=>u.type===Re.audioId3&&l:s==="video"?c=u=>u.type===Re.emsg&&o:c=u=>u.type===Re.audioId3&&l||u.type===Re.emsg&&o,an(r,t,i,c)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:s}=this,{dateRanges:r}=t,a=Object.keys(r);if(s){const u=Object.keys(i).filter(h=>!a.includes(h));for(let h=u.length;h--;){const d=u[h];Object.keys(i[d].cues).forEach(g=>{s.removeCue(i[d].cues[g])}),delete i[d]}}const o=t.fragments[t.fragments.length-1];if(a.length===0||!N(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,c=on();for(let u=0;u<a.length;u++){const h=a[u],d=r[h],g=ln(d.startDate,l),f=i[h],m=(f==null?void 0:f.cues)||{};let y=(f==null?void 0:f.durationKnown)||!1,v=Ci;const E=d.endDate;if(E)v=ln(E,l),y=!0;else if(d.endOnNext&&!y){const _=a.reduce((S,w)=>{if(w!==d.id){const b=r[w];if(b.class===d.class&&b.startDate>d.startDate&&(!S||d.startDate<S.startDate))return b}return S},null);_&&(v=ln(_.startDate,l),y=!0)}const T=Object.keys(d.attr);for(let _=0;_<T.length;_++){const S=T[_];if(!Zu(S))continue;const w=m[S];if(w)y&&!f.durationKnown&&(w.endTime=v);else if(c){let b=d.attr[S];Ju(S)&&(b=Wh(b));const D=so(c,g,v,{key:S,data:b},Re.dateRange);D&&(D.id=h,this.id3Track.addCue(D),m[S]=D)}}i[h]={cues:m,dateRange:d,durationKnown:y}}}}class zh{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(e===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:a,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let c=o&&i||t;(l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=r!==void 0?r:a*s);const u=s;return c+Math.min(this.stallCount*1,u)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(e===null||t===null||i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,a=s-i.totalduration,o=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(a,r),o)}get drift(){const{levelDetails:e}=this;return e===null?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(p.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(p.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===C.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&L.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||r===1||!t.live)return;const a=this.targetLatency;if(a===null)return;const o=i-a,l=Math.min(this.maxLatency,a+t.targetduration);if(o<l&&o>.05&&this.forwardBufferLength>1){const u=Math.min(2,Math.max(1,r)),h=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;e.playbackRate=Math.min(u,Math.max(1,h))}else e.playbackRate!==1&&e.playbackRate!==0&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}const cn=["NONE","TYPE-0","TYPE-1",null];function qh(n){return cn.indexOf(n)>-1}const bi=["SDR","PQ","HLG"];function jh(n){return!!n&&bi.indexOf(n)>-1}var Ft={No:"",Yes:"YES",v2:"v2"};function Xh(n,e){const{canSkipUntil:t,canSkipDateRanges:i,endSN:s}=n,r=e!==void 0?e-s:0;return t&&r<t?i?Ft.v2:Ft.Yes:Ft.No}class un{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class St{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(t=>!!t).map(t=>t.substring(0,4)).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return no(this._audioGroups,e)}hasSubtitleGroup(e){return no(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function no(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function hn(n,e){const t=e.startPTS;if(N(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&(s.duration=i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.start=n.start+(n.minEndPTS-n.start):e.start=n.start+n.duration:e.start=Math.max(n.start-e.duration,0)}function ro(n,e,t,i,s,r){i-t<=0&&(L.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let o=t,l=i;const c=e.startPTS,u=e.endPTS;if(N(c)){const y=Math.abs(c-t);N(e.deltaPTS)?e.deltaPTS=Math.max(y,e.deltaPTS):e.deltaPTS=y,o=Math.max(t,c),t=Math.min(t,c),s=Math.min(s,e.startDTS),l=Math.min(i,u),i=Math.max(i,u),r=Math.max(r,e.endDTS)}const h=t-e.start;e.start!==0&&(e.start=t),e.duration=i-e.start,e.startPTS=t,e.maxStartPTS=o,e.startDTS=s,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const d=e.sn;if(!n||d<n.startSN||d>n.endSN)return 0;let g;const f=d-n.startSN,m=n.fragments;for(m[f]=e,g=f;g>0;g--)hn(m[g],m[g-1]);for(g=f;g<m.length-1;g++)hn(m[g],m[g+1]);return n.fragmentHint&&hn(m[m.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,h}function Qh(n,e){let t=null;const i=n.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){t=c;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s=0,r;if(ed(n,e,(l,c)=>{l.relurl&&(s=l.cc-c.cc),N(l.startPTS)&&N(l.endPTS)&&(c.start=c.startPTS=l.startPTS,c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.duration=l.endPTS-l.startPTS,c.duration&&(r=c),e.PTSKnown=e.alignedSliding=!0),c.elementaryStreams=l.elementaryStreams,c.loader=l.loader,c.stats=l.stats,l.initSegment&&(c.initSegment=l.initSegment,t=l.initSegment)}),t&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(c=>{var u;c&&(!c.initSegment||c.initSegment.relurl===((u=t)==null?void 0:u.relurl))&&(c.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some(l=>!l),e.deltaUpdateFailed){L.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=Zh(n.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const a=e.fragments;if(s){L.warn("discontinuity sliding from playlist, take drift into account");for(let l=0;l<a.length;l++)a[l].cc+=s}e.skippedSegments&&(e.startCC=e.fragments[0].cc),Jh(n.partList,e.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),r?ro(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):ao(n,e),a.length&&(e.totalduration=e.edge-a[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const l=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=l),e.driftEndTime=o,e.driftEnd=l}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime}function Zh(n,e,t){const i=he({},n);return t&&t.forEach(s=>{delete i[s]}),Object.keys(e).forEach(s=>{const r=new Ws(e[s].attr,i[s]);r.isValid?i[s]=r:L.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[s].attr)}"`)}),i}function Jh(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){const a=n[s],o=e[s+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?t(a,o):i--}}}function ed(n,e,t){const i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,a=e.startSN-n.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let c=s;c<=r;c++){const u=l[a+c];let h=o[c];i&&!h&&c<i&&(h=e.fragments[c]=u),u&&h&&t(u,h)}}function ao(n,e){const t=e.startSN+e.skippedSegments-n.startSN,i=n.fragments;t<0||t>=i.length||dn(e,i[t].start)}function dn(n,e){if(e){const t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].start+=e;n.fragmentHint&&(n.fragmentHint.start+=e)}}function td(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function id(n,e,t){if(!(n!=null&&n.details))return null;const i=n.details;let s=i.fragments[e-i.startSN];return s||(s=i.fragmentHint,s&&s.sn===e)?s:e<i.startSN&&t&&t.sn===e?t:null}function oo(n,e,t){var i;return n!=null&&n.details?lo((i=n.details)==null?void 0:i.partList,e,t):null}function lo(n,e,t){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function co(n){n.forEach((e,t)=>{const{details:i}=e;i!=null&&i.fragments&&i.fragments.forEach(s=>{s.level=t})})}function wi(n){switch(n.details){case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_TIMEOUT:case C.LEVEL_LOAD_TIMEOUT:case C.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function uo(n,e){const t=wi(e);return n.default[`${t?"timeout":"error"}Retry`]}function fn(n,e){const t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function ho(n){return ge(ge({},n),{errorRetry:null,timeoutRetry:null})}function Ai(n,e,t,i){if(!n)return!1;const s=i==null?void 0:i.code,r=e<n.maxNumRetry&&(sd(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function sd(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}const fo={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];const a=e(r);if(a>0)t=s+1;else if(a<0)i=s-1;else return r}return null}};function nd(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!N(e))return null;const i=n[0].programDateTime;if(e<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;t=t||0;for(let r=0;r<n.length;++r){const a=n[r];if(rd(e,t,a))return a}return null}function Ri(n,e,t=0,i=0){let s=null;if(n){s=e[n.sn-e[0].sn+1]||null;const a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7)}else t===0&&e[0].start===0&&(s=e[0]);if(s&&(!n||n.level===s.level)&&gn(t,i,s)===0)return s;const r=fo.search(e,gn.bind(null,t,i));return r&&(r!==n||!s)?r:s}function gn(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function rd(n,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function ad(n,e){return fo.search(n,t=>t.cc<e?1:t.cc>e?-1:0)}var fe={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Ie={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class go{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=L.log.bind(L,"[info]:"),this.warn=L.warn.bind(L,"[warning]:"),this.error=L.error.bind(L,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(p.ERROR,this.onError,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(p.ERROR,this.onError,this),e.off(p.ERROR,this.onErrorOut,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===B.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i,s;if(t.fatal)return;const r=this.hls,a=t.context;switch(t.details){case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case C.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction={action:fe.DoNothing,flags:Ie.None};return}case C.FRAG_GAP:case C.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=fe.SendAlternateToPenaltyBox;return}case C.LEVEL_EMPTY_ERROR:case C.LEVEL_PARSING_ERROR:{var o,l;const c=t.parent===B.MAIN?t.level:r.loadLevel;t.details===C.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(l=o.levelDetails)!=null&&l.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case C.LEVEL_LOAD_ERROR:case C.LEVEL_LOAD_TIMEOUT:typeof(a==null?void 0:a.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,a.level));return;case C.AUDIO_TRACK_LOAD_ERROR:case C.AUDIO_TRACK_LOAD_TIMEOUT:case C.SUBTITLE_LOAD_ERROR:case C.SUBTITLE_TRACK_LOAD_TIMEOUT:if(a){const c=r.levels[r.loadLevel];if(c&&(a.type===Q.AUDIO_TRACK&&c.hasAudioGroup(a.groupId)||a.type===Q.SUBTITLE_TRACK&&c.hasSubtitleGroup(a.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=fe.SendAlternateToPenaltyBox,t.errorAction.flags=Ie.MoveAllAlternatesMatchingHost;return}}return;case C.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=r.levels[r.loadLevel],u=c==null?void 0:c.attrs["HDCP-LEVEL"];u?t.errorAction={action:fe.SendAlternateToPenaltyBox,flags:Ie.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(t)}return;case C.BUFFER_ADD_CODEC_ERROR:case C.REMUX_ALLOC_ERROR:case C.BUFFER_APPEND_ERROR:t.errorAction=this.getLevelSwitchAction(t,(s=t.level)!=null?s:r.loadLevel);return;case C.INTERNAL_EXCEPTION:case C.BUFFER_APPENDING_ERROR:case C.BUFFER_FULL_ERROR:case C.LEVEL_SWITCH_ERROR:case C.BUFFER_STALLED_ERROR:case C.BUFFER_SEEK_OVER_HOLE:case C.BUFFER_NUDGE_ON_STALL:t.errorAction={action:fe.DoNothing,flags:Ie.None};return}t.type===$.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,s=uo(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Ai(s,r,wi(e),e.response))return{action:fe.RetryRequest,flags:Ie.None,retryConfig:s,retryCount:r};const o=this.getLevelSwitchAction(e,t);return s&&(o.retryConfig=s,o.retryCount=r),o}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=t.config,o=uo(e.details.startsWith("key")?a:r,e),l=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(s&&(e.details!==C.FRAG_GAP&&s.fragmentError++,Ai(o,l,wi(e),e.response)))return{action:fe.RetryRequest,flags:Ie.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s){var r,a;const c=e.details;s.loadError++,c===C.BUFFER_APPEND_ERROR&&s.fragmentError++;let u=-1;const{levels:h,loadLevel:d,minAutoLevel:g,maxAutoLevel:f}=i;i.autoLevelEnabled||(i.loadLevel=-1);const m=(r=e.frag)==null?void 0:r.type,v=(m===B.AUDIO&&c===C.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===C.BUFFER_ADD_CODEC_ERROR||c===C.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:w})=>s.audioCodec!==w),T=e.sourceBufferName==="video"&&(c===C.BUFFER_ADD_CODEC_ERROR||c===C.BUFFER_APPEND_ERROR)&&h.some(({codecSet:w,audioCodec:b})=>s.codecSet!==w&&s.audioCodec===b),{type:_,groupId:S}=(a=e.context)!=null?a:{};for(let w=h.length;w--;){const b=(w+d)%h.length;if(b!==d&&b>=g&&b<=f&&h[b].loadError===0){var o,l;const D=h[b];if(c===C.FRAG_GAP&&e.frag){const k=h[b].details;if(k){const R=Ri(e.frag,k.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else{if(_===Q.AUDIO_TRACK&&D.hasAudioGroup(S)||_===Q.SUBTITLE_TRACK&&D.hasSubtitleGroup(S))continue;if(m===B.AUDIO&&(o=s.audioGroups)!=null&&o.some(k=>D.hasAudioGroup(k))||m===B.SUBTITLE&&(l=s.subtitleGroups)!=null&&l.some(k=>D.hasSubtitleGroup(k))||v&&s.audioCodec===D.audioCodec||!v&&s.audioCodec!==D.audioCodec||T&&s.codecSet===D.codecSet)continue}u=b;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:fe.SendAlternateToPenaltyBox,flags:Ie.None,nextAutoLevel:u}}return{action:fe.SendAlternateToPenaltyBox,flags:Ie.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case fe.DoNothing:break;case fe.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==C.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case fe.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:a}=i;switch(s){case Ie.None:this.switchLevel(e,a);break;case Ie.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=cn[cn.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,a)}switchLevel(e,t){t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class Ii{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=L.log.bind(L,`${t}:`),this.warn=L.warn.bind(L,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=t==null?void 0:t.renditionReports;if(i){let s=-1;for(let r=0;r<i.length;r++){const a=i[r];let o;try{o=new self.URL(a.URI,t.url).href}catch(l){L.warn(`Could not construct new URL for Rendition Report: ${l}`),o=a.URI||""}if(o===e){s=r;break}else o===e.substring(0,o.length)&&(s=r)}if(s!==-1){const r=i[s],a=parseInt(r["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let o=parseInt(r["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const l=Math.min(t.age-t.partTarget,t.targetduration);o>=0&&l>t.partTarget&&(o+=1)}return new un(a,o>=0?o:void 0,Ft.No)}}}loadPlaylist(e){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:s,stats:r}=t,a=self.performance.now(),o=r.loading.first?Math.max(0,a-r.loading.first):0;if(s.advancedDateTime=Date.now()-o,s.live||i!=null&&i.live){if(s.reloaded(i),i&&this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),i&&s.fragments.length>0&&Qh(i,s),!this.canLoad||!s.live)return;let l,c,u;if(s.canBlockReload&&s.endSN&&s.advanced){const y=this.hls.config.lowLatencyMode,v=s.lastPartSn,E=s.endSN,T=s.lastPartIndex,_=T!==-1,S=v===E,w=y?0:T;_?(c=S?E+1:v,u=S?w:T+1):c=E+1;const b=s.age,D=b+s.ageHeader;let k=Math.min(D-s.partTarget,s.targetduration*1.5);if(k>0){if(i&&k>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${k} with playlist age: ${s.age}`),k=0;else{const R=Math.floor(k/s.targetduration);if(c+=R,u!==void 0){const P=Math.round(k%s.targetduration/s.partTarget);u+=P}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${b.toFixed(2)}s goal: ${k} skip sn ${R} to part ${u}`)}s.tuneInGoal=k}if(l=this.getDeliveryDirectives(s,t.deliveryDirectives,c,u),y||!S){this.loadPlaylist(l);return}}else(s.canBlockReload||s.canSkipUntil)&&(l=this.getDeliveryDirectives(s,t.deliveryDirectives,c,u));const h=this.hls.mainForwardBufferInfo,d=h?h.end-h.len:0,g=(s.edge-d)*1e3,f=td(s,g);s.updated&&a>this.requestScheduled+f&&(this.requestScheduled=r.loading.start),c!==void 0&&s.canBlockReload?this.requestScheduled=r.loading.first+f-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+f<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=f);let m=this.requestScheduled-a;m=Math.max(0,m),this.log(`reload live playlist ${e} in ${Math.round(m)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),m)}else this.clearTimer()}getDeliveryDirectives(e,t,i,s){let r=Xh(e,i);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=Ft.No),new un(i,s,r)}checkRetry(e){const t=e.details,i=wi(e),s=e.errorAction,{action:r,retryCount:a=0,retryConfig:o}=s||{},l=!!s&&!!o&&(r===fe.RetryRequest||!s.resolved&&r===fe.SendAlternateToPenaltyBox);if(l){var c;if(this.requestScheduled=-1,a>=o.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=fn(o,a);this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,s.resolved=!0}return l}}class Mt{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class od{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Mt(e),this.fast_=new Mt(t),this.defaultTTFB_=s,this.ttfb_=new Mt(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new Mt(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new Mt(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new Mt(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const mo={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},po={};function ld(n,e,t,i,s,r){const a=n.audioCodec?n.audioGroups:null,o=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,c=l?parseInt(l):o?1/0:2;let u=null;if(a!=null&&a.length)try{a.length===1&&a[0]?u=e.groups[a[0]].channels:u=a.reduce((h,d)=>{if(d){const g=e.groups[d];if(!g)throw new Error(`Audio track group ${d} not found`);Object.keys(g.channels).forEach(f=>{h[f]=(h[f]||0)+g.channels[f]})}return h},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!u&&N(c)&&Object.keys(u).some(h=>parseInt(h)>c)}function cd(n,e,t){const i=n.videoCodec,s=n.audioCodec;if(!i||!s||!t)return Promise.resolve(mo);const r={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(r.transferFunction=a.toLowerCase());const o=i.split(",").map(l=>({type:"media-source",video:ge(ge({},r),{},{contentType:ei(l,"video")})}));return s&&n.audioGroups&&n.audioGroups.forEach(l=>{var c;l&&((c=e.groups[l])==null||c.tracks.forEach(u=>{if(u.groupId===l){const h=u.channels||"",d=parseFloat(h);N(d)&&d>2&&o.push.apply(o,s.split(",").map(g=>({type:"media-source",audio:{contentType:ei(g,"audio"),channels:""+d}})))}}))}),Promise.all(o.map(l=>{const c=ud(l);return po[c]||(po[c]=t.decodingInfo(l))})).then(l=>({supported:!l.some(c=>!c.supported),configurations:o,decodingInfoResults:l})).catch(l=>({supported:!1,configurations:o,decodingInfoResults:[],error:l}))}function ud(n){const{audio:e,video:t}=n,i=t||e;if(i){const s=i.contentType.split('"')[1];if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${s}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${s}`}return""}function hd(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function dd(n,e){let t=!1,i=[];return n&&(t=n!=="SDR",i=[n]),e&&(i=e.allowedVideoRanges||bi.slice(0),t=e.preferHDR!==void 0?e.preferHDR:hd(),t?i=i.filter(s=>s!=="SDR"):i=["SDR"]),{preferHDR:t,allowedVideoRanges:i}}function fd(n,e,t,i,s){const r=Object.keys(n),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=a&&parseInt(a)===2;let c=!0,u=!1,h=1/0,d=1/0,g=1/0,f=0,m=[];const{preferHDR:y,allowedVideoRanges:v}=dd(e,s);for(let S=r.length;S--;){const w=n[r[S]];c=w.channels[2]>0,h=Math.min(h,w.minHeight),d=Math.min(d,w.minFramerate),g=Math.min(g,w.minBitrate);const b=v.filter(D=>w.videoRanges[D]>0);b.length>0&&(u=!0,m=b)}h=N(h)?h:0,d=N(d)?d:0;const E=Math.max(1080,h),T=Math.max(30,d);return g=N(g)?g:t,t=Math.max(g,t),u||(e=void 0,m=[]),{codecSet:r.reduce((S,w)=>{const b=n[w];if(w===S)return S;if(b.minBitrate>t)return qe(w,`min bitrate of ${b.minBitrate} > current estimate of ${t}`),S;if(!b.hasDefaultAudio)return qe(w,"no renditions with default or auto-select sound found"),S;if(o&&w.indexOf(o.substring(0,4))%5!==0)return qe(w,`audio codec preference "${o}" not found`),S;if(a&&!l){if(!b.channels[a])return qe(w,`no renditions with ${a} channel sound found (channels options: ${Object.keys(b.channels)})`),S}else if((!o||l)&&c&&b.channels[2]===0)return qe(w,"no renditions with stereo sound found"),S;return b.minHeight>E?(qe(w,`min resolution of ${b.minHeight} > maximum of ${E}`),S):b.minFramerate>T?(qe(w,`min framerate of ${b.minFramerate} > maximum of ${T}`),S):m.some(D=>b.videoRanges[D]>0)?b.maxScore<f?(qe(w,`max score of ${b.maxScore} < selected max of ${f}`),S):S&&(Li(w)>=Li(S)||b.fragmentError>n[S].fragmentError)?S:(f=b.maxScore,w):(qe(w,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),S)},void 0),videoRanges:m,preferHDR:y,minFramerate:d,minBitrate:g}}function qe(n,e){L.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function gd(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function md(n,e,t,i){return n.slice(t,i+1).reduce((s,r)=>{if(!r.codecSet)return s;const a=r.audioGroups;let o=s[r.codecSet];o||(s[r.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,r.bitrate);const l=Math.min(r.height,r.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,r.frameRate),o.maxScore=Math.max(o.maxScore,r.score),o.fragmentError+=r.fragmentError,o.videoRanges[r.videoRange]=(o.videoRanges[r.videoRange]||0)+1,a&&a.forEach(c=>{if(!c)return;const u=e.groups[c];o.hasDefaultAudio=o.hasDefaultAudio||e.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(u.channels).forEach(h=>{o.channels[h]=(o.channels[h]||0)+u.channels[h]})}),s},{})}function He(n,e,t){if("attrs"in n){const i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){const s=e[i];if(Ot(n,s,t))return i}return-1}function Ot(n,e,t){const{groupId:i,name:s,lang:r,assocLang:a,characteristics:o,default:l}=n,c=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||e.lang===r)&&(r===void 0||e.assocLang===a)&&(l===void 0||e.default===l)&&(c===void 0||e.forced===c)&&(o===void 0||pd(o,e.characteristics))&&(t===void 0||t(n,e))}function pd(n,e=""){const t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function Nt(n,e){const{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function yd(n,e,t,i,s){const r=e[i],o=e.reduce((d,g,f)=>{const m=g.uri;return(d[m]||(d[m]=[])).push(f),d},{})[r.uri];o.length>1&&(i=Math.max.apply(Math,o));const l=r.videoRange,c=r.frameRate,u=r.codecSet.substring(0,4),h=yo(e,i,d=>{if(d.videoRange!==l||d.frameRate!==c||d.codecSet.substring(0,4)!==u)return!1;const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return He(n,f,s)>-1});return h>-1?h:yo(e,i,d=>{const g=d.audioGroups,f=t.filter(m=>!g||g.indexOf(m.groupId)!==-1);return He(n,f,s)>-1})}function yo(n,e,t){for(let i=e;i;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}class vo{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:t,partCurrent:i,hls:s}=this,{autoLevelEnabled:r,media:a}=s;if(!t||!a)return;const o=performance.now(),l=i?i.stats:t.stats,c=i?i.duration:t.duration,u=o-l.loading.start,h=s.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||t.level<=h){this.clearTimer(),this._nextAutoLevel=-1;return}if(!r||a.paused||!a.playbackRate||!a.readyState)return;const d=s.mainForwardBufferInfo;if(d===null)return;const g=this.bwEstimator.getEstimateTTFB(),f=Math.abs(a.playbackRate);if(u<=Math.max(g,1e3*(c/(f*2))))return;const m=d.len/f,y=l.loading.first?l.loading.first-l.loading.start:-1,v=l.loaded&&y>-1,E=this.getBwEstimate(),T=s.levels,_=T[t.level],S=l.total||Math.max(l.loaded,Math.round(c*_.maxBitrate/8));let w=v?u-y:u;w<1&&v&&(w=Math.min(u,l.loaded*8/E));const b=v?l.loaded*1e3/w:0,D=b?(S-l.loaded)/b:S*8/E+g/1e3;if(D<=m)return;const k=b?b*8:E;let R=Number.POSITIVE_INFINITY,P;for(P=t.level-1;P>h;P--){const M=T[P].maxBitrate;if(R=this.getTimeToLoadFrag(g/1e3,k,c*M,!T[P].details),R<m)break}if(R>=D||R>c*10)return;s.nextLoadLevel=s.nextAutoLevel=P,v?this.bwEstimator.sample(u-Math.min(g,y),l.loaded):this.bwEstimator.sampleTTFB(u);const W=T[P].bitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>W&&this.resetEstimator(W),this.clearTimer(),L.warn(`[abr] Fragment ${t.sn}${i?" part "+i.index:""} of level ${t.level} is loading too slowly;
      Time to underbuffer: ${m.toFixed(3)} s
      Estimated load time for current fragment: ${D.toFixed(3)} s
      Estimated load time for down switch fragment: ${R.toFixed(3)} s
      TTFB estimate: ${y|0} ms
      Current BW estimate: ${N(E)?E|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${P} @ ${W|0} bps`),s.trigger(p.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:i,stats:l})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(L.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new od(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(p.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case C.BUFFER_ADD_CODEC_ERROR:case C.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case C.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const a=performance.now(),o=r?r.stats:i.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(h,c),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,a=s?this.lastLevelLoadSec:0;return r+a}onLevelLoaded(e,t){const i=this.hls.config,{loading:s}=t.stats,r=s.end-s.start;N(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===B.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,a=this.hls.levels[t.level],o=(a.loaded?a.loaded.bytes:0)+s.loaded,l=(a.loaded?a.loaded.duration:0)+r;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(p.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==B.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;const a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return L.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const a=this.hls.levels;if(a.length>Math.max(e,r)&&a[e].loadError<=a[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){var e;return`${this.getBwEstimate()}_${(e=this.hls.mainForwardBufferInfo)==null?void 0:e.len}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:a,media:o}=i,l=t?t.duration:e?e.duration:0,c=o&&o.playbackRate!==0?Math.abs(o.playbackRate):1,u=this.getBwEstimate(),h=i.mainForwardBufferInfo,d=(h?h.len:0)/c;let g=r.abrBandWidthFactor,f=r.abrBandWidthUpFactor;if(d){const T=this.findBestLevel(u,a,s,d,0,g,f);if(T>=0)return T}let m=l?Math.min(l,r.maxStarvationDelay):r.maxStarvationDelay;if(!d){const T=this.bitrateTestDelay;T&&(m=(l?Math.min(l,r.maxLoadingDelay):r.maxLoadingDelay)-T,L.info(`[abr] bitrate test took ${Math.round(1e3*T)}ms, set first fragment max fetchDuration to ${Math.round(1e3*m)} ms`),g=f=1)}const y=this.findBestLevel(u,a,s,d,m,g,f);if(L.info(`[abr] ${d?"rebuffering expected":"buffer is empty"}, optimal quality level ${y}`),y>-1)return y;const v=i.levels[a],E=i.levels[i.loadLevel];return(v==null?void 0:v.bitrate)<(E==null?void 0:E.bitrate)?a:i.loadLevel}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,a,o){var l;const c=s+r,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:d,partCurrent:g}=this,{levels:f,allAudioTracks:m,loadLevel:y,config:v}=this.hls;if(f.length===1)return 0;const E=f[h],T=!!(E!=null&&(l=E.details)!=null&&l.live),_=y===-1||u===-1;let S,w="SDR",b=(E==null?void 0:E.frameRate)||0;const{audioPreference:D,videoPreference:k}=v,R=this.audioTracksByGroup||(this.audioTracksByGroup=gd(m));if(_){if(this.firstSelection!==-1)return this.firstSelection;const Y=this.codecTiers||(this.codecTiers=md(f,R,t,i)),V=fd(Y,w,e,D,k),{codecSet:le,videoRanges:O,minFramerate:U,minBitrate:Z,preferHDR:j}=V;S=le,w=j?O[O.length-1]:O[0],b=U,e=Math.max(e,Z),L.log(`[abr] picked start tier ${JSON.stringify(V)}`)}else S=E==null?void 0:E.codecSet,w=E==null?void 0:E.videoRange;const P=g?g.duration:d?d.duration:0,W=this.bwEstimator.getEstimateTTFB()/1e3,M=[];for(let Y=i;Y>=t;Y--){var H,ee;const V=f[Y],le=Y>h;if(!V)continue;if(v.useMediaCapabilities&&!V.supportedResult&&!V.supportedPromise){const ve=navigator.mediaCapabilities;typeof(ve==null?void 0:ve.decodingInfo)=="function"&&ld(V,R,w,b,e,D)?(V.supportedPromise=cd(V,R,ve),V.supportedPromise.then(ce=>{V.supportedResult=ce;const Ze=this.hls.levels,Oe=Ze.indexOf(V);ce.error?L.warn(`[abr] MediaCapabilities decodingInfo error: "${ce.error}" for level ${Oe} ${JSON.stringify(ce)}`):ce.supported||(L.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${Oe} ${JSON.stringify(ce)}`),Oe>-1&&Ze.length>1&&(L.log(`[abr] Removing unsupported level ${Oe}`),this.hls.removeLevel(Oe)))})):V.supportedResult=mo}if(S&&V.codecSet!==S||w&&V.videoRange!==w||le&&b>V.frameRate||!le&&b>0&&b<V.frameRate||!((H=V.supportedResult)!=null&&(ee=H.decodingInfoResults)!=null&&ee[0].smooth)){M.push(Y);continue}const O=V.details,U=(g?O==null?void 0:O.partTarget:O==null?void 0:O.averagetargetduration)||P;let Z;le?Z=o*e:Z=a*e;const j=P&&s>=P*2&&r===0?f[Y].averageBitrate:f[Y].maxBitrate,te=this.getTimeToLoadFrag(W,Z,j*U,O===void 0);if(Z>=j&&(Y===u||V.loadError===0&&V.fragmentError===0)&&(te<=W||!N(te)||T&&!this.bitrateTestDelay||te<c)){const ve=this.forcedAutoLevel;return Y!==y&&(ve===-1||ve!==y)&&(M.length&&L.trace(`[abr] Skipped level(s) ${M.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${f[M[0]].codecs}" ${f[M[0]].videoRange}; not compatible with "${E.codecs}" ${w}`),L.info(`[abr] switch candidate:${h}->${Y} adjustedbw(${Math.round(Z)})-bitrate=${Math.round(Z-j)} ttfb:${W.toFixed(1)} avgDuration:${U.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${te.toFixed(1)} firstSelection:${_} codecSet:${S} videoRange:${w} hls.loadLevel:${y}`)),_&&(this.firstSelection=Y),Y}}return-1}set nextAutoLevel(e){const t=Math.max(this.hls.minAutoLevel,e);this._nextAutoLevel!=t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}}class vd{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var me={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class Ed{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(p.BUFFER_APPENDED,this.onBufferAppended,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.BUFFER_APPENDED,this.onBufferAppended,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const a=r.end;if(r.start<=e&&a!==null&&e<=a)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const a=i[s[r]];if((a==null?void 0:a.body.type)===t&&a.buffered){const o=a.body;if(o.start<=e&&e<=o.end)return o}}return null}detectEvictedFragments(e,t,i,s){this.timeRanges&&(this.timeRanges[e]=t);const r=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o||r>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===i&&this.removeFragment(o.body);return}const l=o.range[e];l&&l.time.some(c=>{const u=!this.isTimeBuffered(c.startPTS,c.endPTS,t);return u&&this.removeFragment(o.body),u})})}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:s}=e;if(!t||i.sn==="initSegment")return;const r=Ut(i),a=this.fragments[r];if(!a||a.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(l=>{const c=i.elementaryStreams[l];if(!c)return;const u=t[l],h=o||c.partial===!0;a.range[l]=this.getBufferedTimes(i,s,h,u)}),a.loaded=null,Object.keys(a.range).length?(a.buffered=!0,(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),Di(a)||this.removeParts(i.sn-1,i.type)):this.removeFragment(a.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter(s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=Ut(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},a=e.start,o=e.end,l=e.minEndPTS||o,c=e.maxStartPTS||a;for(let u=0;u<s.length;u++){const h=s.start(u)-this.bufferPadding,d=s.end(u)+this.bufferPadding;if(c>=h&&l<=d){r.time.push({startPTS:Math.max(a,s.start(u)),endPTS:Math.min(o,s.end(u))});break}else if(a<d&&o>h){const g=Math.max(a,s.start(u)),f=Math.min(o,s.end(u));f>g&&(r.partial=!0,r.time.push({startPTS:g,endPTS:f}))}else if(o<=h)break}return r}getPartialFragment(e){let t=null,i,s,r,a=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(c=>{const u=l[c];u&&Di(u)&&(s=u.body.start-o,r=u.body.end+o,e>=s&&e<=r&&(i=Math.min(e-s,r-e),a<=i&&(t=u.body,a=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Di(t))}getState(e){const t=Ut(e),i=this.fragments[t];return i?i.buffered?Di(i)?me.PARTIAL:me.OK:me.APPENDING:me.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let a=0;a<i.length;a++){if(s=i.start(a)-this.bufferPadding,r=i.end(a)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:s}=t;if(i.sn==="initSegment"||i.bitrateTest)return;const r=s?null:t,a=Ut(i);this.fragments[a]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r}=t;if(i.sn==="initSegment")return;const a=i.type;if(s){let o=this.activePartLists[a];o||(this.activePartLists[a]=o=[]),o.push(s)}this.timeRanges=r,Object.keys(r).forEach(o=>{const l=r[o];this.detectEvictedFragments(o,l,a,s)})}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Ut(e);return!!this.fragments[t]}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o)return;const l=o.body;l.type!==i||s&&!l.gap||l.start<t&&l.end>e&&(o.buffered||r)&&this.removeFragment(l)})}removeFragment(e){const t=Ut(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=i.filter(r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Di(n){var e,t,i;return n.buffered&&(n.body.gap||((e=n.range.video)==null?void 0:e.partial)||((t=n.range.audio)==null?void 0:t.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Ut(n){return`${n.type}_${n.level}_${n.sn}`}const Td={length:0,start:()=>0,end:()=>0};class ne{static isBuffered(e,t){try{if(e){const i=ne.getBuffered(e);for(let s=0;s<i.length;s++)if(t>=i.start(s)&&t<=i.end(s))return!0}}catch{}return!1}static bufferInfo(e,t,i){try{if(e){const s=ne.getBuffered(e),r=[];let a;for(a=0;a<s.length;a++)r.push({start:s.start(a),end:s.end(a)});return this.bufferedInfo(r,t,i)}}catch{}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort(function(c,u){const h=c.start-u.start;return h||u.end-c.end});let s=[];if(i)for(let c=0;c<e.length;c++){const u=s.length;if(u){const h=s[u-1].end;e[c].start-h<i?e[c].end>h&&(s[u-1].end=e[c].end):s.push(e[c])}else s.push(e[c])}else s=e;let r=0,a,o=t,l=t;for(let c=0;c<s.length;c++){const u=s[c].start,h=s[c].end;if(t+i>=u&&t<h)o=u,l=h,r=l-t;else if(t+i<u){a=u;break}}return{len:r,start:o||0,end:l||0,nextStart:a}}static getBuffered(e){try{return e.buffered}catch(t){return L.log("failed to get media.buffered",t),Td}}}class Pi{constructor(e,t,i,s=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=ki(),this.buffering={audio:ki(),video:ki(),audiovideo:ki()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=a}}function ki(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Fi(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function Sd(n,e,t){return!!(e&&(t.endCC>t.startCC||n&&n.cc<t.startCC))}function Ld(n,e){const t=n.fragments,i=e.fragments;if(!i.length||!t.length){L.log("No fragments to align");return}const s=Fi(t,i[0].cc);if(!s||s&&!s.startPTS){L.log("No frag in previous level to align on");return}return s}function Eo(n,e){if(n){const t=n.start+e;n.start=n.startPTS=t,n.endPTS=t+n.duration}}function To(n,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)Eo(t[i],n);e.fragmentHint&&Eo(e.fragmentHint,n),e.alignedSliding=!0}function xd(n,e,t){e&&(_d(n,t,e),!t.alignedSliding&&e&&Mi(t,e),!t.alignedSliding&&e&&!t.skippedSegments&&ao(e,t))}function _d(n,e,t){if(Sd(n,t,e)){const i=Ld(t,e);i&&N(i.start)&&(L.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),To(i.start,e))}}function Mi(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;const t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r;const a=Math.min(e.endCC,n.endCC);e.startCC<a&&n.startCC<a&&(s=Fi(i,a),r=Fi(t,a)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Fi(t,s.cc)||t[Math.floor(t.length/2)]);const o=s.programDateTime,l=r.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(r.start-s.start);To(c,n)}const So=Math.pow(2,17);class Cd{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new je({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(g=>g[0]==="GAP")){l(xo(e));return}else e.gap=!1;const c=this.loader=e.loader=r?new r(s):new a(s),u=Lo(e),h=ho(s.fragLoadPolicy.default),d={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:So};e.stats=c.stats,c.load(u,d,{onSuccess:(g,f,m,y)=>{this.resetLoader(e,c);let v=g.data;m.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),o({frag:e,part:null,payload:v,networkDetails:y})},onError:(g,f,m,y)=>{this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:ge({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:y}))},onAbort:(g,f,m)=>{this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:m,stats:g}))},onTimeout:(g,f,m)=>{this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}))},onProgress:(g,f,m,y)=>{t&&t({frag:e,part:null,payload:m,networkDetails:y})}})})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(xo(e,t));return}const c=this.loader=e.loader=r?new r(s):new a(s),u=Lo(e,t),h=ho(s.fragLoadPolicy.default),d={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:So};t.stats=c.stats,c.load(u,d,{onSuccess:(g,f,m,y)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const v={frag:e,part:t,payload:g.data,networkDetails:y};i(v),o(v)},onError:(g,f,m,y)=>{this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:ge({url:u.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:m,stats:y}))},onAbort:(g,f,m)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:m,stats:g}))},onTimeout:(g,f,m)=>{this.resetLoader(e,c),l(new je({type:$.NETWORK_ERROR,details:C.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:g}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/r),l),h=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=s.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Lo(n,e=null){const t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(N(s)&&N(r)){var a;let o=s,l=r;if(n.sn==="initSegment"&&((a=n.decryptdata)==null?void 0:a.method)==="AES-128"){const c=r-s;c%16&&(l=r+(16-c%16)),s!==0&&(i.resetIV=!0,o=s-16)}i.rangeStart=o,i.rangeEnd=l}return i}function xo(n,e){const t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:$.MEDIA_ERROR,details:C.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new je(i)}class je extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class bd{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class wd{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function Ad(n){const e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?Et(n,0,e-t):n}class Rd{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],a=i[2],o=i[3],l=this.invSubMix,c=l[0],u=l[1],h=l[2],d=l[3],g=new Uint32Array(256);let f=0,m=0,y=0;for(y=0;y<256;y++)y<128?g[y]=y<<1:g[y]=y<<1^283;for(y=0;y<256;y++){let v=m^m<<1^m<<2^m<<3^m<<4;v=v>>>8^v&255^99,e[f]=v,t[v]=f;const E=g[f],T=g[E],_=g[T];let S=g[v]*257^v*16843008;s[f]=S<<24|S>>>8,r[f]=S<<16|S>>>16,a[f]=S<<8|S>>>24,o[f]=S,S=_*16843009^T*65537^E*257^f*16843008,c[v]=S<<24|S>>>8,u[v]=S<<16|S>>>16,h[v]=S<<8|S>>>24,d[v]=S,f?(f=E^g[g[g[_^E]]],m^=g[g[m]]):f=m=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const a=this.ksRows=(r+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),u=this.invKeySchedule=new Uint32Array(a),h=this.sBox,d=this.rcon,g=this.invSubMix,f=g[0],m=g[1],y=g[2],v=g[3];let E,T;for(o=0;o<a;o++){if(o<r){E=c[o]=t[o];continue}T=E,o%r===0?(T=T<<8|T>>>24,T=h[T>>>24]<<24|h[T>>>16&255]<<16|h[T>>>8&255]<<8|h[T&255],T^=d[o/r|0]<<24):r>6&&o%r===4&&(T=h[T>>>24]<<24|h[T>>>16&255]<<16|h[T>>>8&255]<<8|h[T&255]),c[o]=E=(c[o-r]^T)>>>0}for(l=0;l<a;l++)o=a-l,l&3?T=c[o]:T=c[o-4],l<4||o<=4?u[l]=T:u[l]=f[h[T>>>24]]^m[h[T>>>16&255]]^y[h[T>>>8&255]]^v[h[T&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],u=o[2],h=o[3],d=this.uint8ArrayToUint32Array_(i);let g=d[0],f=d[1],m=d[2],y=d[3];const v=new Int32Array(e),E=new Int32Array(v.length);let T,_,S,w,b,D,k,R,P,W,M,H,ee,Y;const V=this.networkToHostOrderSwap;for(;t<v.length;){for(P=V(v[t]),W=V(v[t+1]),M=V(v[t+2]),H=V(v[t+3]),b=P^r[0],D=H^r[1],k=M^r[2],R=W^r[3],ee=4,Y=1;Y<s;Y++)T=l[b>>>24]^c[D>>16&255]^u[k>>8&255]^h[R&255]^r[ee],_=l[D>>>24]^c[k>>16&255]^u[R>>8&255]^h[b&255]^r[ee+1],S=l[k>>>24]^c[R>>16&255]^u[b>>8&255]^h[D&255]^r[ee+2],w=l[R>>>24]^c[b>>16&255]^u[D>>8&255]^h[k&255]^r[ee+3],b=T,D=_,k=S,R=w,ee=ee+4;T=a[b>>>24]<<24^a[D>>16&255]<<16^a[k>>8&255]<<8^a[R&255]^r[ee],_=a[D>>>24]<<24^a[k>>16&255]<<16^a[R>>8&255]<<8^a[b&255]^r[ee+1],S=a[k>>>24]<<24^a[R>>16&255]<<16^a[b>>8&255]<<8^a[D&255]^r[ee+2],w=a[R>>>24]<<24^a[b>>16&255]<<16^a[D>>8&255]<<8^a[k&255]^r[ee+3],E[t]=V(T^g),E[t+1]=V(w^f),E[t+2]=V(S^m),E[t+3]=V(_^y),g=P,f=W,m=M,y=H,t=t+4}return E.buffer}}const Id=16;class mn{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Ad(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise((s,r)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const a=this.flush();a?s(a.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:s,currentResult:r,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(e=Ae(a,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;s&&(i=s);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Rd),l.expandKey(t);const c=r;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=Et(o,-16).buffer,c||null}webCryptoDecrypt(e,t,i){const s=this.subtle;return(this.key!==t||!this.fastAesKey)&&(this.key=t,this.fastAesKey=new wd(s,t)),this.fastAesKey.expandKey().then(r=>s?(this.logOnce("WebCrypto AES decrypt"),new bd(s,new Uint8Array(i)).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(L.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i)))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%Id;return i!==e.length&&(t=Et(e,0,i),this.remainderData=Et(e,i)),t}logOnce(e){this.logEnabled&&(L.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Dd={toString:function(n){let e="";const t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},I={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Oi extends vd{constructor(e,t,i,s,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=I.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=s,this.log=L.log.bind(L,`${s}:`),this.warn=L.warn.bind(L,`${s}:`),this.hls=e,this.fragmentLoader=new Cd(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new mn(e.config),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=I.STOPPED}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(i!=null&&i.length){const r=i[i.length-1];return ne.isBuffered(this.media,r.start+r.duration/2)}const s=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===I.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const e=this.media;e!=null&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:s,state:r}=this,a=i?i.currentTime:0,o=ne.bufferInfo(s||i,a,e.maxBufferHole);if(this.log(`media seeking to ${N(a)?a.toFixed(3):a}, state: ${r}`),this.state===I.ENDED)this.resetLoadingState();else if(t){const l=e.maxFragLookUpTolerance,c=t.start-l,u=t.start+t.duration+l;if(!o.len||u<o.start||c>o.end){const h=a>u;(a<c||h)&&(h&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=I.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{if(this.fragContextChanged(e)){this.warn(`Fragment ${e.sn}${r.part?" p: "+r.part.index:""} of level ${e.level} was dropped during download.`),this.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const a=this.state;if(this.fragContextChanged(e)){(a===I.FRAG_LOADING||!this.fragCurrent&&a===I.PARSING)&&(this.fragmentTracker.removeFragment(e),this.state=I.IDLE);return}"payload"in r&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(p.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===I.STOPPED||this.state===I.ERROR||(this.warn(r),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===me.APPENDING){const r=e.type,a=this.getFwdBufferInfo(this.mediaBuffer,r),o=Math.max(e.duration,a?a.len:this.config.maxBufferLength);this.reduceMaxBufferLength(o)&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===me.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(p.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{if(!i||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{payload:r}=i,a=e.decryptdata;if(r&&r.byteLength>0&&a!=null&&a.key&&a.iv&&a.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),a.key.buffer,a.iv.buffer).catch(l=>{throw s.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:e}),l}).then(l=>{const c=self.performance.now();return s.trigger(p.FRAG_DECRYPTED,{frag:e,payload:l,stats:{tstart:o,tdecrypt:c}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===I.STOPPED||this.state===I.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state=I.IDLE,e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var i,s,r,a;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===B.MAIN?"level":"track"} ${e.level} (frag:[${((i=e.startPTS)!=null?i:NaN).toFixed(3)}-${((s=e.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${o?Dd.toString(ne.getBuffered(o)):"(detached)"})`),e.sn!=="initSegment"){var l;if(e.type!==B.SUBTITLE){const u=e.elementaryStreams;if(!Object.keys(u).some(h=>!!u[h])){this.state=I.IDLE;return}}const c=(l=this.levels)==null?void 0:l[e.level];c!=null&&c.fragmentError&&(this.log(`Resetting level fragment error count of ${c.fragmentError} on frag buffered`),c.fragmentError=0)}this.state=I.IDLE,o&&(!this.loadedmetadata&&e.type==B.MAIN&&o.buffered.length&&((r=this.fragCurrent)==null?void 0:r.sn)===((a=this.fragPrevious)==null?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,a=!r||r.length===0||r.some(l=>!l),o=new Pi(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!a);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;const a=t==null?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${e.level}`),this.state=I.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(u=>{if(!this.fragContextChanged(u.frag))return this.hls.trigger(p.KEY_LOADED,u),this.state===I.KEY_LOADING&&(this.state=I.IDLE),u}),this.hls.trigger(p.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(e,a.encryptedFragments),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&e.sn!=="initSegment"){const u=a.partList;if(u&&s){i>e.end&&a.fragmentHint&&(e=a.fragmentHint);const h=this.getNextPart(u,e,i);if(h>-1){const d=u[h];this.log(`Loading part sn: ${e.sn} p: ${d.index} cc: ${e.cc} of playlist [${a.startSN}-${a.endSN}] parts [0-${h}-${u.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=I.FRAG_LOADING;let g;return o?g=o.then(f=>!f||this.fragContextChanged(f.frag)?null:this.doFragPartsLoad(e,d,t,s)).catch(f=>this.handleFragLoadError(f)):g=this.doFragPartsLoad(e,d,t,s).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(p.FRAG_LOADING,{frag:e,part:d,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(u,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${a?"of ["+a.startSN+"-"+a.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),N(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=I.FRAG_LOADING;const l=this.config.progressive;let c;return l&&o?c=o.then(u=>!u||this.fragContextChanged(u==null?void 0:u.frag)?null:this.fragmentLoader.load(e,s)).catch(u=>this.handleFragLoadError(u)):c=Promise.all([this.fragmentLoader.load(e,l?s:void 0),o]).then(([u])=>(!l&&u&&s&&s(u),u)).catch(u=>this.handleFragLoadError(u)),this.hls.trigger(p.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):c}doFragPartsLoad(e,t,i,s){return new Promise((r,a)=>{var o;const l=[],c=(o=i.details)==null?void 0:o.partList,u=h=>{this.fragmentLoader.loadPart(e,h,s).then(d=>{l[h.index]=d;const g=d.part;this.hls.trigger(p.FRAG_LOADED,d);const f=oo(i,e.sn,h.index+1)||lo(c,e.sn,h.index+1);if(f)u(f);else return r({frag:e,part:g,partsLoaded:l})}).catch(a)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===C.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(p.ERROR,t)}else this.hls.trigger(p.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==I.PARSING){!this.fragCurrent&&this.state!==I.STOPPED&&this.state!==I.ERROR&&(this.state=I.IDLE);return}const{frag:i,part:s,level:r}=t,a=self.performance.now();i.stats.parsing.end=a,s&&(s.stats.parsing.end=a),this.updateLevelTiming(i,s,r,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:a}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of level ${s}. The current chunk will not be buffered.`),null;const o=t[s],l=a>-1?oo(o,r,a):null,c=l?l.fragment:id(o,r,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:l,level:o}):null}bufferFragmentData(e,t,i,s,r){var a;if(!e||this.state!==I.PARSING)return;const{data1:o,data2:l}=e;let c=o;if(o&&l&&(c=Ae(o,l)),!((a=c)!=null&&a.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:c};if(this.hls.trigger(p.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!ne.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=ne.bufferInfo(t,i,0),r=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(e.start-a,s.end-a),i+a);e.start-o>a&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return N(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:s}}=this,r=ne.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(t,i);if(a&&r.nextStart<a.end)return ne.bufferInfo(e,t,Math.max(r.nextStart,s))}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i?(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0):!1}getAppendedFrag(e,t=B.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,B.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,a=i[0].start;let o;if(t.live){const l=r.initialLiveManifestSize;if(s<l)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${l})`),null;(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a)&&(o=this.getInitialLiveFragment(t,i),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=a&&(o=i[0]);if(!o){const l=r.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,l,t)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===me.OK||i===me.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){const a=e.gap,o=this.getNextFragment(this.nextLoadPosition,t);if(o===null)return o;if(e=o,a&&e&&!e.gap&&i.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s);if(l!==null&&i.len+l.len>=r)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,a=!0;for(let o=0,l=e.length;o<l;o++){const c=e[o];if(a=a&&!c.independent,s>-1&&i<c.start)break;const u=c.loaded;u?s=-1:(r||c.independent||a)&&c.fragment===t&&(s=o),r=u}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=nd(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const a=t[r-e.startSN];i.cc===a.cc&&(s=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=ad(t,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,c=s.maxFragLookUpTolerance,u=i.partList,h=!!(s.lowLatencyMode&&u!=null&&u.length&&l);h&&l&&!this.bitrateTest&&(a=a.concat(l),o=l.sn);let d;if(e<t){const g=e>t-c?0:c;d=Ri(r,a,e,g)}else d=a[a.length-1];if(d){const g=d.sn-i.startSN,f=this.fragmentTracker.getState(d);if((f===me.OK||f===me.PARTIAL&&d.gap)&&(r=d),r&&d.sn===r.sn&&(!h||u[0].fragment.sn>d.sn)&&r&&d.level===r.level){const y=a[g+1];d.sn<o&&this.fragmentTracker.getState(y)!==me.OK?d=y:d=null}}return d}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,a=e.fragments[0].start,o=e.edge,l=r>=a-t.maxFragLookUpTolerance&&r<=o;if(s!==null&&i.duration>s&&(r<s||!l)){const c=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!l&&i.readyState<4||r<o-c)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(e,t,i){const s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=e.fragments[0].start,a=!t,o=e.alignedSliding&&N(r);if(a||!o&&!r){const{fragPrevious:l}=this;xd(l,i,e);const c=e.fragments[0].start;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${l?l.sn:"na"} fragments: ${s}`),c}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),i===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,r=s?this.startTimeOffset:e.startTimeOffset;r!==null&&N(r)?(i=t+r,r<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${r} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&e.sn!=="initSegment"&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==I.FRAG_LOADING_WAITING_RETRY)&&(this.state=I.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const u=this.getCurrentContext(t.chunkMeta);u&&(t.frag=u.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=t.details===C.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction,{action:o,retryCount:l=0,retryConfig:c}=a||{};if(a&&o===fe.RetryRequest&&c){this.resetStartWhenNotLoaded(this.levelLastLoaded);const u=fn(c,l);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${l+1}/${c.maxNumRetry} in ${u}ms`),a.resolved=!0,this.retryDate=self.performance.now()+u,this.state=I.FRAG_LOADING_WAITING_RETRY}else if(c&&a)if(this.resetFragmentErrors(e),l<c.maxNumRetry)!r&&o!==fe.RemoveAlternatePermanently&&(a.resolved=!0);else{L.warn(`${t.details} reached or exceeded max retry (${l})`);return}else(a==null?void 0:a.action)===fe.SendAlternateToPenaltyBox?this.state=I.WAITING_LEVEL:this.state=I.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===I.PARSING||this.state===I.PARSED){const t=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,t),s=i&&i.len>.5;s&&this.reduceMaxBufferLength(i.len);const r=!s;return r&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(e){e===B.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==I.STOPPED&&(this.state=I.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=ne.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===I.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=I.IDLE}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){var r;const a=i.details;if(!a){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${h})`),l||!1;const d=s?0:ro(a,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(p.LEVEL_PTS_UPDATED,{details:a,level:i,drift:d,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)&&((r=this.transmuxer)==null?void 0:r.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(i.fragmentError===0&&(i.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(l.message),this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=I.PARSED,this.hls.trigger(p.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class _o{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=Pd(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function Pd(n,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<n.length;s++){const r=n[s];t.set(r,i),i+=r.length}return t}function kd(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Fd(){const n=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(n);return{worker:new self.Worker(e),objectURL:e}}function Md(n){const e=new self.URL(n,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}function Ke(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class pn{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Ae(this.cachedData,e),this.cachedData=null);let i=Jt(e,0),s=i?i.length:0,r;const a=this._audioTrack,o=this._id3Track,l=i?Qs(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&N(l))&&(this.basePTS=Od(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Re.audioId3,duration:Number.POSITIVE_INFINITY});s<c;){if(this.canParse(e,s)){const u=this.appendFrame(a,e,s);u?(this.frameIndex++,this.lastPTS=u.sample.pts,s+=u.length,r=s):s=c}else oh(e,s)?(i=Jt(e,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Re.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===c&&r!==c){const u=Et(e,r);this.cachedData?this.cachedData=Ae(this.cachedData,u):this.cachedData=u}}return{audioTrack:a,videoTrack:Ke(),id3Track:o,textTrack:Ke()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Ke(),id3Track:this._id3Track,textTrack:Ke()}}destroy(){}}const Od=(n,e,t)=>{if(N(n))return n*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};function Nd(n,e,t,i){let s,r,a,o;const l=navigator.userAgent.toLowerCase(),c=i,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((e[t+2]&192)>>>6)+1;const h=(e[t+2]&60)>>>2;if(h>u.length-1){const d=new Error(`invalid ADTS sampling index:${h}`);n.emit(p.ERROR,p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}return a=(e[t+2]&1)<<2,a|=(e[t+3]&192)>>>6,L.log(`manifest codec:${i}, ADTS type:${s}, samplingIndex:${h}`),/firefox/i.test(l)?h>=6?(s=5,o=new Array(4),r=h-3):(s=2,o=new Array(2),r=h):l.indexOf("android")!==-1?(s=2,o=new Array(2),r=h):(s=5,o=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&h>=6?r=h-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(h>=6&&a===1||/vivaldi/i.test(l))||!i&&a===1)&&(s=2,o=new Array(2)),r=h)),o[0]=s<<3,o[0]|=(h&14)>>1,o[1]|=(h&1)<<7,o[1]|=a<<3,s===5&&(o[1]|=(r&14)>>1,o[2]=(r&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:u[h],channelCount:a,codec:"mp4a.40."+s,manifestCodec:c}}function Co(n,e){return n[e]===255&&(n[e+1]&246)===240}function bo(n,e){return n[e+1]&1?7:9}function yn(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function Ud(n,e){return e+5<n.length}function Ni(n,e){return e+1<n.length&&Co(n,e)}function Bd(n,e){return Ud(n,e)&&Co(n,e)&&yn(n,e)<=n.length-e}function $d(n,e){if(Ni(n,e)){const t=bo(n,e);if(e+t>=n.length)return!1;const i=yn(n,e);if(i<=t)return!1;const s=e+i;return s===n.length||Ni(n,s)}return!1}function wo(n,e,t,i,s){if(!n.samplerate){const r=Nd(e,t,i,s);if(!r)return;n.config=r.config,n.samplerate=r.samplerate,n.channelCount=r.channelCount,n.codec=r.codec,n.manifestCodec=r.manifestCodec,L.log(`parsed codec:${n.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function Ao(n){return 1024*9e4/n}function Gd(n,e){const t=bo(n,e);if(e+t<=n.length){const i=yn(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function Ro(n,e,t,i,s){const r=Ao(n.samplerate),a=i+s*r,o=Gd(e,t);let l;if(o){const{frameLength:h,headerLength:d}=o,g=d+h,f=Math.max(0,t+g-e.length);f?(l=new Uint8Array(g-d),l.set(e.subarray(t+d,e.length),0)):l=e.subarray(t+d,t+g);const m={unit:l,pts:a};return f||n.samples.push(m),{sample:m,length:g,missing:f}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}let Ui=null;const Vd=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Hd=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Kd=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Wd=[0,1,1,4];function Io(n,e,t,i,s){if(t+24>e.length)return;const r=Do(e,t);if(r&&t+r.frameLength<=e.length){const a=r.samplesPerFrame*9e4/r.sampleRate,o=i+s*a,l={unit:e.subarray(t,t+r.frameLength),pts:o,dts:o};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function Do(n,e){const t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const a=n[e+2]>>1&1,o=n[e+3]>>6,l=t===3?3-i:i===3?3:4,c=Vd[l*14+s-1]*1e3,h=Hd[(t===3?0:t===2?1:2)*3+r],d=o===3?1:2,g=Kd[t][i],f=Wd[i],m=g*8*f,y=Math.floor(g*c/h+a)*f;if(Ui===null){const T=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ui=T?parseInt(T[1]):0}return!!Ui&&Ui<=87&&i===2&&c>=224e3&&o===0&&(n[e+3]=n[e+3]|128),{sampleRate:h,channelCount:d,frameLength:y,samplesPerFrame:m}}}function vn(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function Po(n,e){return e+1<n.length&&vn(n,e)}function Yd(n,e){return vn(n,e)&&4<=n.length-e}function ko(n,e){if(e+1<n.length&&vn(n,e)){const i=Do(n,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===n.length||Po(n,r)}return!1}class zd extends pn{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Jt(e,0);let i=(t==null?void 0:t.length)||0;if(ko(e,i))return!1;for(let s=e.length;i<s;i++)if($d(e,i))return L.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Bd(e,t)}appendFrame(e,t,i){wo(e,this.observer,t,i,e.manifestCodec);const s=Ro(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const qd=/\/emsg[-/]ID3/i;class jd{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=Ke("video",1),a=this.audioTrack=Ke("audio",1),o=this.txtTrack=Ke("text",1);if(this.id3Track=Ke("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=Fa(e);if(l.video){const{id:c,timescale:u,codec:h}=l.video;r.id=c,r.timescale=o.timescale=u,r.codec=h}if(l.audio){const{id:c,timescale:u,codec:h}=l.audio;a.id=c,a.timescale=u,a.codec=h}o.id=Da.text,r.sampleDuration=0,r.duration=a.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return ph(e)}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Ae(this.remainderData,e));const o=_h(i);this.remainderData=o.remainder,s.samples=o.valid||new Uint8Array}else s.samples=i;const a=this.extractID3Track(s,t);return r.samples=Oa(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=Oa(e,t),{videoTrack:t,audioTrack:Ke(),id3Track:s,textTrack:Ke()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=K(e.samples,["emsg"]);s&&s.forEach(r=>{const a=wh(r);if(qd.test(a.schemeIdUri)){const o=N(a.presentationTime)?a.presentationTime/a.timeScale:t+a.presentationTimeDelta/a.timeScale;let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;i.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:Re.emsg,duration:l})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const Fo=(n,e)=>{let t=0,i=5;e+=i;const s=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=n[e];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,s[0]=(a[0]&r[0])>>l,t=t?t<<o|s[0]:s[0],e+=1,i-=o}return t};class Xd extends pn{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const s=Mo(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;const t=Jt(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&Qs(t)!==void 0&&Fo(e,i)<16}}function Mo(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const o=[48e3,44100,32e3][r],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+r]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let d=0;h===2?d+=2:(h&1&&h!==1&&(d+=2),h&4&&(d+=2));const g=(e[t+6]<<8|e[t+7])>>12-d&1,m=[2,1,2,3,3,4,4,5][h]+g,y=e[t+5]>>3,v=e[t+5]&7,E=new Uint8Array([r<<6|y<<1|v>>2,(v&3)<<6|h<<3|g<<2|l>>4,l<<4&224]),T=1536/o*9e4,_=i+s*T,S=e.subarray(t,t+u);return n.config=E,n.channelCount=m,n.samplerate=o,n.samples.push({unit:S,pts:_}),u}class Qd{constructor(){this.VideoSample=null}createVideoSample(e,t,i,s){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:s,length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,s=i.length;if(s){const r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}e.debug.length&&L.log(e.pts+"/"+e.dts+":"+e.debug)}}class Oo{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&L.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t=8,i=8,s;for(let r=0;r<e;r++)i!==0&&(s=this.readEG(),i=(t+s+256)%256),t=i===0?t:i}readSPS(){let e=0,t=0,i=0,s=0,r,a,o;const l=this.readUByte.bind(this),c=this.readBits.bind(this),u=this.readUEG.bind(this),h=this.readBoolean.bind(this),d=this.skipBits.bind(this),g=this.skipEG.bind(this),f=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);l();const y=l();if(c(5),d(3),l(),f(),y===100||y===110||y===122||y===244||y===44||y===83||y===86||y===118||y===128){const w=u();if(w===3&&d(1),f(),f(),d(1),h())for(a=w!==3?8:12,o=0;o<a;o++)h()&&(o<6?m(16):m(64))}f();const v=u();if(v===0)u();else if(v===1)for(d(1),g(),g(),r=u(),o=0;o<r;o++)g();f(),d(1);const E=u(),T=u(),_=c(1);_===0&&d(1),d(1),h()&&(e=u(),t=u(),i=u(),s=u());let S=[1,1];if(h()&&h())switch(l()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:{S=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((E+1)*16-e*2-t*2),height:(2-_)*(T+1)*16-(_?2:4)*(i+s),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Zd extends Qd{parseAVCPES(e,t,i,s,r){const a=this.parseAVCNALu(e,i.data);let o=this.VideoSample,l,c=!1;i.data=null,o&&a.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),a.forEach(u=>{var h;switch(u.type){case 1:{let m=!1;l=!0;const y=u.data;if(c&&y.length>4){const v=new Oo(y).readSliceType();(v===2||v===4||v===7||v===9)&&(m=!0)}if(m){var d;(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=m;break}case 5:l=!0,(h=o)!=null&&h.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:{l=!0,Na(u.data,1,i.pts,t.samples);break}case 7:{var g,f;l=!0,c=!0;const m=u.data,v=new Oo(m).readSPS();if(!e.sps||e.width!==v.width||e.height!==v.height||((g=e.pixelRatio)==null?void 0:g[0])!==v.pixelRatio[0]||((f=e.pixelRatio)==null?void 0:f[1])!==v.pixelRatio[1]){e.width=v.width,e.height=v.height,e.pixelRatio=v.pixelRatio,e.sps=[m],e.duration=r;const E=m.subarray(1,4);let T="avc1.";for(let _=0;_<3;_++){let S=E[_].toString(16);S.length<2&&(S="0"+S),T+=S}e.codec=T}break}case 8:l=!0,e.pps=[u.data];break;case 9:l=!0,e.audFound=!0,o&&this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:l=!0;break;default:l=!1,o&&(o.debug+="unknown NAL "+u.type+" ");break}o&&l&&o.units.push(u)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}parseAVCNALu(e,t){const i=t.byteLength;let s=e.naluState||0;const r=s,a=[];let o=0,l,c,u,h=-1,d=0;for(s===-1&&(h=0,d=t[0]&31,s=0,o=1);o<i;){if(l=t[o++],!s){s=l?0:1;continue}if(s===1){s=l?0:2;continue}if(!l)s=3;else if(l===1){if(c=o-s-1,h>=0){const g={data:t.subarray(h,c),type:d};a.push(g)}else{const g=this.getLastNalUnit(e.samples);g&&(r&&o<=4-r&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-r)),c>0&&(g.data=Ae(g.data,t.subarray(0,c)),g.state=0))}o<i?(u=t[o]&31,h=o,d=u,s=0):s=-1}else s=0}if(h>=0&&s>=0){const g={data:t.subarray(h,i),type:d,state:s};a.push(g)}if(a.length===0){const g=this.getLastNalUnit(e.samples);g&&(g.data=Ae(g.data,t))}return e.naluState=s,a}}class Jd{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new mn(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const a=Ua(r.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const a=r[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,i,s,a),!this.decrypter.isSync()))return}}}}const pe=188;class rt{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.videoParser=new Zd}static probe(e){const t=rt.syncOffset(e);return t>0&&L.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),t!==-1}static syncOffset(e){const t=e.length;let i=Math.min(pe*5,t-pe)+1,s=0;for(;s<i;){let r=!1,a=-1,o=0;for(let l=s;l<t;l+=pe)if(e[l]===71&&(t-l===pe||e[l+pe]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+pe*99,e.length-pe)+1)),r||(r=En(e,l)===0),r&&o>1&&(a===0&&o>2||l+pe>i))return a}else{if(o)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Da[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=rt.createTrack("video"),this._audioTrack=rt.createTrack("audio",s),this._id3Track=rt.createTrack("id3"),this._txtTrack=rt.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=a.pid,h=a.pesData,d=o.pid,g=l.pid,f=o.pesData,m=l.pesData,y=null,v=this.pmtParsed,E=this._pmtId,T=e.length;if(this.remainderData&&(e=Ae(this.remainderData,e),T=e.length,this.remainderData=null),T<pe&&!s)return this.remainderData=e,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const _=Math.max(0,rt.syncOffset(e));T-=(T-_)%pe,T<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,T,e.buffer.byteLength-T));let S=0;for(let b=_;b<T;b+=pe)if(e[b]===71){const D=!!(e[b+1]&64),k=En(e,b),R=(e[b+3]&48)>>4;let P;if(R>1){if(P=b+5+e[b+4],P===b+pe)continue}else P=b+4;switch(k){case u:D&&(h&&(r=Bt(h))&&this.videoParser.parseAVCPES(a,c,r,!1,this._duration),h={data:[],size:0}),h&&(h.data.push(e.subarray(P,b+pe)),h.size+=b+pe-P);break;case d:if(D){if(f&&(r=Bt(f)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break;case"ac3":this.parseAC3PES(o,r);break}f={data:[],size:0}}f&&(f.data.push(e.subarray(P,b+pe)),f.size+=b+pe-P);break;case g:D&&(m&&(r=Bt(m))&&this.parseID3PES(l,r),m={data:[],size:0}),m&&(m.data.push(e.subarray(P,b+pe)),m.size+=b+pe-P);break;case 0:D&&(P+=e[P]+1),E=this._pmtId=ef(e,P);break;case E:{D&&(P+=e[P]+1);const W=tf(e,P,this.typeSupported,i);u=W.videoPid,u>0&&(a.pid=u,a.segmentCodec=W.segmentVideoCodec),d=W.audioPid,d>0&&(o.pid=d,o.segmentCodec=W.segmentAudioCodec),g=W.id3Pid,g>0&&(l.pid=g),y!==null&&!v&&(L.warn(`MPEG-TS PMT found at ${b} after unknown PID '${y}'. Backtracking to sync byte @${_} to parse all TS packets.`),y=null,b=_-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:y=k;break}}else S++;if(S>0){const b=new Error(`Found ${S} TS packet/s that do not start with 0x47`);this.observer.emit(p.ERROR,p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:b,reason:b.message})}a.pesData=h,o.pesData=f,l.pesData=m;const w={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return s&&this.extractRemainingSamples(w),w}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,a=i.pesData,o=t.pesData,l=s.pesData;let c;if(a&&(c=Bt(a))?(this.videoParser.parseAVCPES(i,r,c,!0,this._duration),i.pesData=null):i.pesData=a,o&&(c=Bt(o))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else o!=null&&o.size&&L.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(c=Bt(l))?(this.parseID3PES(s,c),s.pesData=null):s.pesData=l}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new Jd(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this._duration=0}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const h=s.missing,d=s.sample.unit.byteLength;if(h===-1)r=Ae(s.sample.unit,r);else{const g=d-h;s.sample.unit.set(r.subarray(0,h),g),e.samples.push(s.sample),i=s.missing}}let a,o;for(a=i,o=r.length;a<o-1&&!Ni(r,a);a++);if(a!==i){let h;const d=a<o-1;d?h=`AAC PES did not start with ADTS header,offset:${a}`:h="No ADTS header found in AAC PES";const g=new Error(h);if(L.warn(`parsing error: ${h}`),this.observer.emit(p.ERROR,p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,levelRetry:d,error:g,reason:h}),!d)return}wo(e,this.observer,r,a,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(s){const h=Ao(e.samplerate);l=s.sample.pts+h}else{L.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;a<o;)if(u=Ro(e,r,a,l,c),a+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;a<o-1&&!Ni(r,a);a++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,a=0;const o=t.pts;if(o===void 0){L.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<s;)if(Po(i,a)){const l=Io(e,i,a,o,r);if(l)a+=l.length,r++;else break}else a++}parseAC3PES(e,t){{const i=t.data,s=t.pts;if(s===void 0){L.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let a=0,o=0,l;for(;o<r&&(l=Mo(e,i,o,s,a++))>0;)o+=l}}parseID3PES(e,t){if(t.pts===void 0){L.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=he({},t,{type:this._videoTrack?Re.emsg:Re.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function En(n,e){return((n[e+1]&31)<<8)+n[e+2]}function ef(n,e){return(n[e+10]&31)<<8|n[e+11]}function tf(n,e,t,i){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},r=(n[e+1]&15)<<8|n[e+2],a=e+3+r-4,o=(n[e+10]&15)<<8|n[e+11];for(e+=12+o;e<a;){const l=En(n,e),c=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){Tn("ADTS AAC");break}case 15:s.audioPid===-1&&(s.audioPid=l);break;case 21:s.id3Pid===-1&&(s.id3Pid=l);break;case 219:if(!i){Tn("H.264");break}case 27:s.videoPid===-1&&(s.videoPid=l,s.segmentVideoCodec="avc");break;case 3:case 4:!t.mpeg&&!t.mp3?L.log("MPEG audio found, not supported in this browser"):s.audioPid===-1&&(s.audioPid=l,s.segmentAudioCodec="mp3");break;case 193:if(!i){Tn("AC-3");break}case 129:t.ac3?s.audioPid===-1&&(s.audioPid=l,s.segmentAudioCodec="ac3"):L.log("AC-3 audio found, not supported in this browser");break;case 6:if(s.audioPid===-1&&c>0){let u=e+5,h=c;for(;h>2;){switch(n[u]){case 106:t.ac3!==!0?L.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=l,s.segmentAudioCodec="ac3");break}const g=n[u+1]+2;u+=g,h-=g}}break;case 194:case 135:L.warn("Unsupported EC-3 in M2TS found");break;case 36:L.warn("Unsupported HEVC in M2TS found");break}e+=c+5}return s}function Tn(n){L.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Bt(n){let e=0,t,i,s,r,a;const o=n.data;if(!n||n.size===0)return null;for(;o[0].length<19&&o.length>1;)o[0]=Ae(o[0],o[1]),o.splice(1,1);if(t=o[0],(t[0]<<16)+(t[1]<<8)+t[2]===1){if(i=(t[4]<<8)+t[5],i&&i>n.size-6)return null;const c=t[7];c&192&&(r=(t[9]&14)*536870912+(t[10]&255)*4194304+(t[11]&254)*16384+(t[12]&255)*128+(t[13]&254)/2,c&64?(a=(t[14]&14)*536870912+(t[15]&255)*4194304+(t[16]&254)*16384+(t[17]&255)*128+(t[18]&254)/2,r-a>60*9e4&&(L.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),s=t[8];let u=s+9;if(n.size<=u)return null;n.size-=u;const h=new Uint8Array(n.size);for(let d=0,g=o.length;d<g;d++){t=o[d];let f=t.byteLength;if(u)if(u>f){u-=f;continue}else t=t.subarray(u),f-=u,u=0;h.set(t,e),e+=f}return i&&(i-=s+3),{data:h,pts:r,dts:a,len:i}}return null}class sf extends pn{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Jt(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&Qs(t)!==void 0&&Fo(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(ko(e,i))return L.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return Yd(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return Io(e,t,i,this.basePTS,this.frameIndex)}}class No{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const at=Math.pow(2,32)-1;class x{static init(){x.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in x.types)x.types.hasOwnProperty(e)&&(x.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);x.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);x.STTS=x.STSC=x.STCO=r,x.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),x.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),x.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),x.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);x.FTYP=x.box(x.types.ftyp,a,l,a,o),x.DINF=x.box(x.types.dinf,x.box(x.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(e,4),s=0,i=8;s<r;s++)a.set(t[s],i),i+=t[s].byteLength;return a}static hdlr(e){return x.box(x.types.hdlr,x.HDLR_TYPES[e])}static mdat(e){return x.box(x.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(at+1)),s=Math.floor(t%(at+1));return x.box(x.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return x.box(x.types.mdia,x.mdhd(e.timescale,e.duration),x.hdlr(e.type),x.minf(e))}static mfhd(e){return x.box(x.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?x.box(x.types.minf,x.box(x.types.smhd,x.SMHD),x.DINF,x.stbl(e)):x.box(x.types.minf,x.box(x.types.vmhd,x.VMHD),x.DINF,x.stbl(e))}static moof(e,t,i){return x.box(x.types.moof,x.mfhd(e),x.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=x.trak(e[t]);return x.box.apply(null,[x.types.moov,x.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(x.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=x.trex(e[t]);return x.box.apply(null,[x.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(at+1)),s=Math.floor(t%(at+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return x.box(x.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return x.box(x.types.sdtp,i)}static stbl(e){return x.box(x.types.stbl,x.stsd(e),x.box(x.types.stts,x.STTS),x.box(x.types.stsc,x.STSC),x.box(x.types.stsz,x.STSZ),x.box(x.types.stco,x.STCO))}static avc1(e){let t=[],i=[],s,r,a;for(s=0;s<e.sps.length;s++)r=e.sps[s],a=r.byteLength,t.push(a>>>8&255),t.push(a&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],a=r.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(r));const o=x.box(x.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return x.box(x.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,x.box(x.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),x.box(x.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return x.box(x.types.mp4a,x.audioStsd(e),x.box(x.types.esds,x.esds(e)))}static mp3(e){return x.box(x.types[".mp3"],x.audioStsd(e))}static ac3(e){return x.box(x.types["ac-3"],x.audioStsd(e),x.box(x.types.dac3,e.config))}static stsd(e){return e.type==="audio"?e.segmentCodec==="mp3"&&e.codec==="mp3"?x.box(x.types.stsd,x.STSD,x.mp3(e)):e.segmentCodec==="ac3"?x.box(x.types.stsd,x.STSD,x.ac3(e)):x.box(x.types.stsd,x.STSD,x.mp4a(e)):x.box(x.types.stsd,x.STSD,x.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,s=e.width,r=e.height,a=Math.floor(i/(at+1)),o=Math.floor(i%(at+1));return x.box(x.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=x.sdtp(e),s=e.id,r=Math.floor(t/(at+1)),a=Math.floor(t%(at+1));return x.box(x.types.traf,x.box(x.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),x.box(x.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255])),x.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,x.box(x.types.trak,x.tkhd(e),x.mdia(e))}static trex(e){const t=e.id;return x.box(x.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,a=new Uint8Array(r);let o,l,c,u,h,d;for(t+=8+r,a.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<s;o++)l=i[o],c=l.duration,u=l.size,h=l.flags,d=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*o);return x.box(x.types.trun,a)}static initSegment(e){x.types||x.init();const t=x.moov(e);return Ae(x.FTYP,t)}}x.types=void 0,x.HDLR_TYPES=void 0,x.STTS=void 0,x.STSC=void 0,x.STCO=void 0,x.STSZ=void 0,x.VMHD=void 0,x.SMHD=void 0,x.STSD=void 0,x.FTYP=void 0,x.DINF=void 0;const Uo=9e4;function Sn(n,e,t=1,i=!1){const s=n*e*t;return i?Math.round(s):s}function nf(n,e,t=1,i=!1){return Sn(n,e,1/t,i)}function ti(n,e=!1){return Sn(n,1e3,1/Uo,e)}function rf(n,e=1){return Sn(n,Uo,1/e)}const af=10*1e3,Bo=1024,of=1152,lf=1536;let $t=null,Ln=null;class Bi{constructor(e,t,i,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,$t===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);$t=a?parseInt(a[1]):0}if(Ln===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Ln=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){L.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){L.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){L.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e.reduce((s,r)=>{const a=r.pts-s;return a<-4294967296?(t=!0,De(s,r.pts)):a>0?s:r.pts},e[0].pts);return t&&L.debug("PTS rollover detected"),i}remux(e,t,i,s,r,a,o,l){let c,u,h,d,g,f,m=r,y=r;const v=e.pid>-1,E=t.pid>-1,T=t.samples.length,_=e.samples.length>0,S=o&&T>0||T>1;if((!v||_)&&(!E||S)||this.ISGenerated||o){if(this.ISGenerated){var b,D,k,R;const H=this.videoTrackConfig;H&&(t.width!==H.width||t.height!==H.height||((b=t.pixelRatio)==null?void 0:b[0])!==((D=H.pixelRatio)==null?void 0:D[0])||((k=t.pixelRatio)==null?void 0:k[1])!==((R=H.pixelRatio)==null?void 0:R[1]))&&this.resetInitSegment()}else h=this.generateIS(e,t,r,a);const P=this.isVideoContiguous;let W=-1,M;if(S&&(W=cf(t.samples),!P&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,W>0){L.warn(`[mp4-remuxer]: Dropped ${W} out of ${T} video samples due to a missing keyframe`);const H=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(W),t.dropped+=W,y+=(t.samples[0].pts-H)/t.inputTimeScale,M=y}else W===-1&&(L.warn(`[mp4-remuxer]: No keyframe found out of ${T} video samples`),f=!1);if(this.ISGenerated){if(_&&S){const H=this.getVideoStartPts(t.samples),Y=(De(e.samples[0].pts,H)-H)/t.inputTimeScale;m+=Math.max(0,Y),y+=Math.max(0,-Y)}if(_){if(e.samplerate||(L.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(e,t,r,a)),u=this.remuxAudio(e,m,this.isAudioContiguous,a,E||S||l===B.AUDIO?y:void 0),S){const H=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(L.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(e,t,r,a)),c=this.remuxVideo(t,y,P,H)}}else S&&(c=this.remuxVideo(t,y,P,0));c&&(c.firstKeyFrame=W,c.independent=W!==-1,c.firstKeyFramePTS=M)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(g=$o(i,r,this._initPTS,this._initDTS)),s.samples.length&&(d=Go(s,r,this._initPTS))),{audio:u,video:c,initSegment:h,independent:f,text:d,id3:g}}generateIS(e,t,i,s){const r=e.samples,a=t.samples,o=this.typeSupported,l={},c=this._initPTS;let u=!c||s,h="audio/mp4",d,g,f;if(u&&(d=g=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(h="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):x.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(f=e.inputTimeScale,!c||f!==c.timescale?d=g=r[0].pts-Math.round(f*i):u=!1)}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:x.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(f=t.inputTimeScale,!c||f!==c.timescale){const m=this.getVideoStartPts(a),y=Math.round(f*i);g=Math.min(g,De(a[0].dts,m)-y),d=Math.min(d,m-y)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:d,timescale:f},this._initDTS={baseTime:g,timescale:f}):d=f=void 0,{tracks:l,initPTS:d,timescale:f}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,a=e.samples,o=[],l=a.length,c=this._initPTS;let u=this.nextAvcDts,h=8,d=this.videoSampleDuration,g,f,m=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,v=!1;if(!i||u===null){const O=t*r,U=a[0].pts-De(a[0].dts,a[0].pts);$t&&u!==null&&Math.abs(O-U-u)<15e3?i=!0:u=O-U}const E=c.baseTime*r/c.timescale;for(let O=0;O<l;O++){const U=a[O];U.pts=De(U.pts-E,u),U.dts=De(U.dts-E,u),U.dts<a[O>0?O-1:O].dts&&(v=!0)}v&&a.sort(function(O,U){const Z=O.dts-U.dts,j=O.pts-U.pts;return Z||j}),g=a[0].dts,f=a[a.length-1].dts;const T=f-g,_=T?Math.round(T/(l-1)):d||e.inputTimeScale/30;if(i){const O=g-u,U=O>_,Z=O<-1;if((U||Z)&&(U?L.warn(`AVC: ${ti(O,!0)} ms (${O}dts) hole between fragments detected at ${t.toFixed(3)}`):L.warn(`AVC: ${ti(-O,!0)} ms (${O}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!Z||u>=a[0].pts||$t)){g=u;const j=a[0].pts-O;if(U)a[0].dts=g,a[0].pts=j;else for(let te=0;te<a.length&&!(a[te].dts>j);te++)a[te].dts-=O,a[te].pts-=O;L.log(`Video: Initial PTS/DTS adjusted: ${ti(j,!0)}/${ti(g,!0)}, delta: ${ti(O,!0)} ms`)}}g=Math.max(0,g);let S=0,w=0,b=g;for(let O=0;O<l;O++){const U=a[O],Z=U.units,j=Z.length;let te=0;for(let be=0;be<j;be++)te+=Z[be].data.length;w+=te,S+=j,U.length=te,U.dts<b?(U.dts=b,b+=_/4|0||1):b=U.dts,m=Math.min(U.pts,m),y=Math.max(U.pts,y)}f=a[l-1].dts;const D=w+4*S+8;let k;try{k=new Uint8Array(D)}catch(O){this.observer.emit(p.ERROR,p.ERROR,{type:$.MUX_ERROR,details:C.REMUX_ALLOC_ERROR,fatal:!1,error:O,bytes:D,reason:`fail allocating video mdat ${D}`});return}const R=new DataView(k.buffer);R.setUint32(0,D),k.set(x.types.mdat,4);let P=!1,W=Number.POSITIVE_INFINITY,M=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,ee=Number.NEGATIVE_INFINITY;for(let O=0;O<l;O++){const U=a[O],Z=U.units;let j=0;for(let ve=0,ce=Z.length;ve<ce;ve++){const Ze=Z[ve],Oe=Ze.data,Hn=Ze.data.byteLength;R.setUint32(h,Hn),h+=4,k.set(Oe,h),h+=Hn,j+=4+Hn}let te;if(O<l-1)d=a[O+1].dts-U.dts,te=a[O+1].pts-U.pts;else{const ve=this.config,ce=O>0?U.dts-a[O-1].dts:_;if(te=O>0?U.pts-a[O-1].pts:_,ve.stretchShortVideoTrack&&this.nextAudioPts!==null){const Ze=Math.floor(ve.maxBufferHole*r),Oe=(s?m+s*r:this.nextAudioPts)-U.pts;Oe>Ze?(d=Oe-ce,d<0?d=ce:P=!0,L.log(`[mp4-remuxer]: It is approximately ${Oe/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=ce}else d=ce}const be=Math.round(U.pts-U.dts);W=Math.min(W,d),H=Math.max(H,d),M=Math.min(M,te),ee=Math.max(ee,te),o.push(new Vo(U.key,d,j,be))}if(o.length){if($t){if($t<70){const O=o[0].flags;O.dependsOn=2,O.isNonSync=0}}else if(Ln&&ee-M<H-W&&_/H<.025&&o[0].cts===0){L.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let O=g;for(let U=0,Z=o.length;U<Z;U++){const j=O+o[U].duration,te=O+o[U].cts;if(U<Z-1){const be=j+o[U+1].cts;o[U].duration=be-te}else o[U].duration=U?o[U-1].duration:_;o[U].cts=0,O=j}}}d=P||!d?_:d,this.nextAvcDts=u=f+d,this.videoSampleDuration=d,this.isVideoContiguous=!0;const le={data1:x.moof(e.sequenceNumber++,g,he({},e,{samples:o})),data2:k,startPTS:m/r,endPTS:(y+d)/r,startDTS:g/r,endDTS:u/r,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,le}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return of;case"ac3":return lf;default:return Bo}}remuxAudio(e,t,i,s,r){const a=e.inputTimeScale,o=e.samplerate?e.samplerate:a,l=a/o,c=this.getSamplesPerFrame(e),u=c*l,h=this._initPTS,d=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],f=r!==void 0;let m=e.samples,y=d?0:8,v=this.nextAudioPts||-1;const E=t*a,T=h.baseTime*a/h.timescale;if(this.isAudioContiguous=i=i||m.length&&v>0&&(s&&Math.abs(E-v)<9e3||Math.abs(De(m[0].pts-T,E)-v)<20*u),m.forEach(function(Y){Y.pts=De(Y.pts-T,E)}),!i||v<0){if(m=m.filter(Y=>Y.pts>=0),!m.length)return;r===0?v=0:s&&!f?v=Math.max(0,E):v=m[0].pts}if(e.segmentCodec==="aac"){const Y=this.config.maxAudioFramesDrift;for(let V=0,le=v;V<m.length;V++){const O=m[V],U=O.pts,Z=U-le,j=Math.abs(1e3*Z/a);if(Z<=-Y*u&&f)V===0&&(L.warn(`Audio frame @ ${(U/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*Z/a)} ms.`),this.nextAudioPts=v=le=U);else if(Z>=Y*u&&j<af&&f){let te=Math.round(Z/u);le=U-te*u,le<0&&(te--,le+=u),V===0&&(this.nextAudioPts=v=le),L.warn(`[mp4-remuxer]: Injecting ${te} audio frame @ ${(le/a).toFixed(3)}s due to ${Math.round(1e3*Z/a)} ms gap.`);for(let be=0;be<te;be++){const ve=Math.max(le,0);let ce=No.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);ce||(L.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),ce=O.unit.subarray()),m.splice(V,0,{unit:ce,pts:ve}),le+=u,V++}}O.pts=le,le+=u}}let _=null,S=null,w,b=0,D=m.length;for(;D--;)b+=m[D].unit.byteLength;for(let Y=0,V=m.length;Y<V;Y++){const le=m[Y],O=le.unit;let U=le.pts;if(S!==null){const j=g[Y-1];j.duration=Math.round((U-S)/l)}else if(i&&e.segmentCodec==="aac"&&(U=v),_=U,b>0){b+=y;try{w=new Uint8Array(b)}catch(j){this.observer.emit(p.ERROR,p.ERROR,{type:$.MUX_ERROR,details:C.REMUX_ALLOC_ERROR,fatal:!1,error:j,bytes:b,reason:`fail allocating audio mdat ${b}`});return}d||(new DataView(w.buffer).setUint32(0,b),w.set(x.types.mdat,4))}else return;w.set(O,y);const Z=O.byteLength;y+=Z,g.push(new Vo(!0,c,Z,0)),S=U}const k=g.length;if(!k)return;const R=g[g.length-1];this.nextAudioPts=v=S+l*R.duration;const P=d?new Uint8Array(0):x.moof(e.sequenceNumber++,_/l,he({},e,{samples:g}));e.samples=[];const W=_/a,M=v/a,ee={data1:P,data2:w,startPTS:W,endPTS:M,startDTS:W,endDTS:M,type:"audio",hasAudio:!0,hasVideo:!1,nb:k};return this.isAudioContiguous=!0,ee}remuxEmptyAudio(e,t,i,s){const r=e.inputTimeScale,a=e.samplerate?e.samplerate:r,o=r/a,l=this.nextAudioPts,c=this._initDTS,u=c.baseTime*9e4/c.timescale,h=(l!==null?l:s.startDTS*r)+u,d=s.endDTS*r+u,g=o*Bo,f=Math.ceil((d-h)/g),m=No.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(L.warn("[mp4-remuxer]: remux empty Audio"),!m){L.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const y=[];for(let v=0;v<f;v++){const E=h+v*g;y.push({unit:m,pts:E,dts:E})}return e.samples=y,this.remuxAudio(e,t,i,!1)}}function De(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function cf(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function $o(n,e,t,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let o=0;o<s;o++){const l=n.samples[o];l.pts=De(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=De(l.dts-i.baseTime*r/i.timescale,e*r)/r}const a=n.samples;return n.samples=[],{samples:a}}function Go(n,e,t){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let a=0;a<i;a++){const o=n.samples[a];o.pts=De(o.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((a,o)=>a.pts-o.pts);const r=n.samples;return n.samples=[],{samples:r}}class Vo{constructor(e,t,i,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=s,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class uf{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(Eh(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=Fa(e);s.audio&&(t=Ho(s.audio,ie.AUDIO)),s.video&&(i=Ho(s.video,ie.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:L.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,a){var o,l;let{initPTS:c,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};N(u)||(u=this.lastEndTime=r||0);const d=t.samples;if(!(d!=null&&d.length))return h;const g={initPTS:void 0,timescale:1};let f=this.initData;if((o=f)!=null&&o.length||(this.generateInitSegment(d),f=this.initData),!((l=f)!=null&&l.length))return L.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);const m=Sh(d,f),y=Th(f,d),v=y===null?r:y;(hf(c,v,r,m)||g.timescale!==c.timescale&&a)&&(g.initPTS=v-r,c&&c.timescale===1&&L.warn(`Adjusting initPTS by ${g.initPTS-c.baseTime}`),this.initPTS=c={baseTime:g.initPTS,timescale:1});const E=e?v-c.baseTime/c.timescale:u,T=E+m;xh(f,d,c.baseTime/c.timescale),m>0?this.lastEndTime=T:(L.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const _=!!f.audio,S=!!f.video;let w="";_&&(w+="audio"),S&&(w+="video");const b={data1:d,startPTS:E,startDTS:E,endPTS:T,endDTS:T,type:w,hasAudio:_,hasVideo:S,nb:1,dropped:0};return h.audio=b.type==="audio"?b:void 0,h.video=b.type!=="audio"?b:void 0,h.initSegment=g,h.id3=$o(i,r,c,c),s.samples.length&&(h.text=Go(s,r,c)),h}}function hf(n,e,t,i){if(n===null)return!0;const s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function Ho(n,e){const t=n==null?void 0:n.codec;if(t&&t.length>4)return t;if(e===ie.AUDIO){if(t==="ec-3"||t==="ac-3"||t==="alac")return t;if(t==="fLaC"||t==="Opus")return xi(t,!1);const i="mp4a.40.5";return L.info(`Parsed audio codec "${t}" or audio object type not handled. Using "${i}"`),i}return L.warn(`Unhandled video codec "${t}"`),t==="hvc1"||t==="hev1"?"hvc1.1.6.L120.90":t==="av01"?"av01.0.04M.08":"avc1.42e01e"}let Xe;try{Xe=self.performance.now.bind(self.performance)}catch{L.debug("Unable to use Performance API on this environment"),Xe=Dt==null?void 0:Dt.Date.now}const $i=[{demux:jd,remux:uf},{demux:rt,remux:Bi},{demux:zd,remux:Bi},{demux:sf,remux:Bi}];$i.splice(2,0,{demux:Xd,remux:Bi});class Ko{constructor(e,t,i,s,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.id=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=Xe();let a=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:c,discontinuity:u,trackSwitch:h,accurateTimeOffset:d,timeOffset:g,initSegmentChange:f}=s||o,{audioCodec:m,videoCodec:y,defaultInitPts:v,duration:E,initSegmentData:T}=l,_=df(a,t);if(_&&_.method==="AES-128"){const D=this.getDecrypter();if(D.isSync()){let k=D.softwareDecrypt(a,_.key.buffer,_.iv.buffer);if(i.part>-1&&(k=D.flush()),!k)return r.executeEnd=Xe(),xn(i);a=new Uint8Array(k)}else return this.decryptionPromise=D.webCryptoDecrypt(a,_.key.buffer,_.iv.buffer).then(k=>{const R=this.push(k,null,i);return this.decryptionPromise=null,R}),this.decryptionPromise}const S=this.needsProbing(u,h);if(S){const D=this.configureTransmuxer(a);if(D)return L.warn(`[transmuxer] ${D.message}`),this.observer.emit(p.ERROR,p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,fatal:!1,error:D,reason:D.message}),r.executeEnd=Xe(),xn(i)}(u||h||f||S)&&this.resetInitSegment(T,m,y,E,t),(u||f||S)&&this.resetInitialTimestamp(v),c||this.resetContiguity();const w=this.transmux(a,_,g,d,i),b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,r.executeEnd=Xe(),w}flush(e){const t=e.transmuxing;t.executeStart=Xe();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(e));const a=[],{timeOffset:o}=s;if(i){const h=i.flush();h&&a.push(this.push(h,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c)return t.executeEnd=Xe(),[xn(e)];const u=l.flush(o);return Gi(u)?u.then(h=>(this.flushRemux(a,h,e),a)):(this.flushRemux(a,u,e),a)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:a,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;L.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const u=this.remuxer.remux(s,r,a,o,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=Xe()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,i,s),o.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let a;return t&&t.method==="SAMPLE-AES"?a=this.transmuxSampleAes(e,t,i,s,r):a=this.transmuxUnencrypted(e,i,s,r),a}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,o,l,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s,vendor:r}=this;let a;for(let d=0,g=$i.length;d<g;d++){var o;if((o=$i[d].demux)!=null&&o.probe(e)){a=$i[d];break}}if(!a)return new Error("Failed to find demuxer by probing fragment data");const l=this.demuxer,c=this.remuxer,u=a.remux,h=a.demux;(!c||!(c instanceof u))&&(this.remuxer=new u(i,t,s,r)),(!l||!(l instanceof h))&&(this.demuxer=new h(i,t,s),this.probe=h.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new mn(this.config)),e}}function df(n,e){let t=null;return n.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const xn=n=>({remuxResult:{},chunkMeta:n});function Gi(n){return"then"in n&&n.then instanceof Function}class ff{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class gf{constructor(e,t,i,s,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=a}}var Wo={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function r(l,c,u,h,d){if(typeof u!="function")throw new TypeError("The listener must be a function");var g=new s(u,h||l,d),f=t?t+c:c;return l._events[f]?l._events[f].fn?l._events[f]=[l._events[f],g]:l._events[f].push(g):(l._events[f]=g,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)e.call(u,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},o.prototype.listeners=function(c){var u=t?t+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,g=h.length,f=new Array(g);d<g;d++)f[d]=h[d].fn;return f},o.prototype.listenerCount=function(c){var u=t?t+c:c,h=this._events[u];return h?h.fn?1:h.length:0},o.prototype.emit=function(c,u,h,d,g,f){var m=t?t+c:c;if(!this._events[m])return!1;var y=this._events[m],v=arguments.length,E,T;if(y.fn){switch(y.once&&this.removeListener(c,y.fn,void 0,!0),v){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,h),!0;case 4:return y.fn.call(y.context,u,h,d),!0;case 5:return y.fn.call(y.context,u,h,d,g),!0;case 6:return y.fn.call(y.context,u,h,d,g,f),!0}for(T=1,E=new Array(v-1);T<v;T++)E[T-1]=arguments[T];y.fn.apply(y.context,E)}else{var _=y.length,S;for(T=0;T<_;T++)switch(y[T].once&&this.removeListener(c,y[T].fn,void 0,!0),v){case 1:y[T].fn.call(y[T].context);break;case 2:y[T].fn.call(y[T].context,u);break;case 3:y[T].fn.call(y[T].context,u,h);break;case 4:y[T].fn.call(y[T].context,u,h,d);break;default:if(!E)for(S=1,E=new Array(v-1);S<v;S++)E[S-1]=arguments[S];y[T].fn.apply(y[T].context,E)}}return!0},o.prototype.on=function(c,u,h){return r(this,c,u,h,!1)},o.prototype.once=function(c,u,h){return r(this,c,u,h,!0)},o.prototype.removeListener=function(c,u,h,d){var g=t?t+c:c;if(!this._events[g])return this;if(!u)return a(this,g),this;var f=this._events[g];if(f.fn)f.fn===u&&(!d||f.once)&&(!h||f.context===h)&&a(this,g);else{for(var m=0,y=[],v=f.length;m<v;m++)(f[m].fn!==u||d&&!f[m].once||h&&f[m].context!==h)&&y.push(f[m]);y.length?this._events[g]=y.length===1?y[0]:y:a(this,g)}return this},o.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&a(this,u)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(Wo);var mf=Wo.exports,_n=Vu(mf);class Yo{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const a=(u,h)=>{h=h||{},h.frag=this.frag,h.id=this.id,u===p.ERROR&&(this.error=h.error),this.hls.trigger(u,h)};this.observer=new _n,this.observer.on(p.FRAG_DECRYPTED,a),this.observer.on(p.ERROR,a);const o=Tt(r.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')},c=navigator.vendor;if(this.useWorker&&typeof Worker<"u"&&(r.workerPath||kd())){try{r.workerPath?(L.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=Md(r.workerPath)):(L.log(`injecting Web Worker for "${t}"`),this.workerContext=Fd()),this.onwmsg=d=>this.onWorkerMessage(d);const{worker:h}=this.workerContext;h.addEventListener("message",this.onwmsg),h.onerror=d=>{const g=new Error(`${d.message}  (${d.filename}:${d.lineno})`);r.enableWorker=!1,L.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(p.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:g})},h.postMessage({cmd:"init",typeSupported:l,vendor:c,id:t,config:JSON.stringify(r)})}catch(h){L.warn(`Error setting up "${t}" Web Worker, fallback to inline`,h),this.resetWorker(),this.error=null,this.transmuxer=new Ko(this.observer,l,r,c,t)}return}this.transmuxer=new Ko(this.observer,l,r,c,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,s,r,a,o,l,c,u){var h,d;c.transmuxing.start=self.performance.now();const{transmuxer:g}=this,f=a?a.start:r.start,m=r.decryptdata,y=this.frag,v=!(y&&r.cc===y.cc),E=!(y&&c.level===y.level),T=y?c.sn-y.sn:-1,_=this.part?c.part-this.part.index:-1,S=T===0&&c.id>1&&c.id===(y==null?void 0:y.stats.chunkCount),w=!E&&(T===1||T===0&&(_===1||S&&_<=0)),b=self.performance.now();(E||T||r.stats.parsing.start===0)&&(r.stats.parsing.start=b),a&&(_||!w)&&(a.stats.parsing.start=b);const D=!(y&&((h=r.initSegment)==null?void 0:h.url)===((d=y.initSegment)==null?void 0:d.url)),k=new gf(v,w,l,E,f,D);if(!w||v||D){L.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${c.sn} p: ${c.part} level: ${c.level} id: ${c.id}
        discontinuity: ${v}
        trackSwitch: ${E}
        contiguous: ${w}
        accurateTimeOffset: ${l}
        timeOffset: ${f}
        initSegmentChange: ${D}`);const R=new ff(i,s,t,o,u);this.configureTransmuxer(R)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:m,chunkMeta:c,state:k},e instanceof ArrayBuffer?[e]:[]);else if(g){const R=g.push(e,m,c,k);Gi(R)?(g.async=!0,R.then(P=>{this.handleTransmuxComplete(P)}).catch(P=>{this.transmuxerError(P,c,"transmuxer-interface push error")})):(g.async=!1,this.handleTransmuxComplete(R))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);Gi(i)||t.async?(Gi(i)||(i=Promise.resolve(i)),i.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")})):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":{var s;const r=(s=this.workerContext)==null?void 0:s.objectURL;r&&self.URL.revokeObjectURL(r);break}case"transmuxComplete":{this.handleTransmuxComplete(t.data);break}case"flush":{this.onFlush(t.data);break}case"workerLog":L[t.data.logType]&&L[t.data.logType](t.data.message);break;default:{t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data);break}}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}function zo(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!Gt(n[t].attrs,e[t].attrs))return!1;return!0}function Gt(n,e,t){const i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function Cn(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}const qo=100;class jo extends Oi{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",B.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.ERROR,this.onError,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.ERROR,this.onError,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i==="main"){const a=t.cc;this.initPTS[t.cc]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${a} found from main: ${s}`),this.videoTrackCC=a,this.state===I.WAITING_INIT_PTS&&this.tick()}}startLoad(e){if(!this.levels){this.startPosition=e,this.state=I.STOPPED;return}const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(qo),t>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=I.IDLE):(this.loadedmetadata=!1,this.state=I.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case I.IDLE:this.doTickIdle();break;case I.WAITING_TRACK:{var e;const{levels:i,trackId:s}=this,r=i==null||(e=i[s])==null?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=I.WAITING_INIT_PTS}break}case I.FRAG_LOADING_WAITING_RETRY:{var t;const i=performance.now(),s=this.retryDate;if(!s||i>=s||(t=this.media)!=null&&t.seeking){const{levels:r,trackId:a}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((r==null?void 0:r[a])||null),this.state=I.IDLE}break}case I.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:s,part:r,cache:a,complete:o}=i;if(this.initPTS[s.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=I.FRAG_LOADING;const l=a.flush(),c={frag:s,part:r,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),o&&super._handleFragmentLoadComplete(c)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${s.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const l=this.getLoadPosition(),c=ne.bufferInfo(this.mediaBuffer,l,this.config.maxBufferHole);gn(c.end,this.config.maxFragLookUpTolerance,s)<0&&(this.log(`Waiting fragment cc (${s.cc}) @ ${s.start} cancelled because another fragment at ${c.end} is needed`),this.clearWaitingFragment())}}else this.state=I.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=I.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:s}=this,r=e.config;if(!i&&(this.startFragRequested||!r.startFragPrefetch)||!(t!=null&&t[s]))return;const a=t[s],o=a.details;if(!o||o.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(o)){this.state=I.WAITING_TRACK;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,ie.AUDIO,B.AUDIO));const c=this.getFwdBufferInfo(l,B.AUDIO);if(c===null)return;const{bufferedTrack:u,switchingTrack:h}=this;if(!h&&this._streamEnded(c,o)){e.trigger(p.BUFFER_EOS,{type:"audio"}),this.state=I.ENDED;return}const d=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,B.MAIN),g=c.len,f=this.getMaxBufferLength(d==null?void 0:d.len),m=o.fragments,y=m[0].start;let v=this.flushing?this.getLoadPosition():c.end;if(h&&i){const S=this.getLoadPosition();u&&!Gt(h.attrs,u.attrs)&&(v=S),o.PTSKnown&&S<y&&(c.end>y||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=y+.05)}if(g>=f&&!h&&v<m[m.length-1].start)return;let E=this.getNextFragment(v,o),T=!1;if(E&&this.isLoopLoading(E,v)&&(T=!!E.gap,E=this.getNextFragmentLoopLoading(E,o,c,B.MAIN,f)),!E){this.bufferFlushed=!0;return}const _=d&&E.start>d.end+o.targetduration;if(_||!(d!=null&&d.len)&&c.len){const S=this.getAppendedFrag(E.start,B.MAIN);if(S===null||(T||(T=!!S.gap||!!_&&d.len===0),_&&!T||T&&c.nextStart&&c.nextStart<S.end))return}this.loadFragment(E,a,v)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new St(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?this.setInterval(qo):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=I.IDLE,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=I.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(p.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=t;return}const{levels:s}=this,{details:r,id:a}=t;if(!s){this.warn(`Audio tracks were reset while loading level ${a}`);return}this.log(`Audio track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const o=s[a];let l=0;if(r.live||(i=o.details)!=null&&i.live){this.checkLiveUpdate(r);const u=this.mainDetails;if(r.deltaUpdateFailed||!u)return;if(!o.details&&r.hasProgramDateTime&&u.hasProgramDateTime)Mi(r,u),l=r.fragments[0].start;else{var c;l=this.alignPlaylists(r,o.details,(c=this.levelLastLoaded)==null?void 0:c.details)}}o.details=r,this.levelLastLoaded=o,!this.startFragRequested&&(this.mainDetails||!r.live)&&this.setStartPosition(o.details,l),this.state===I.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=I.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new Yo(this.hls,B.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[i.cc],f=(t=i.initSegment)==null?void 0:t.data;if(g!==void 0){const y=s?s.index:-1,v=y!==-1,E=new Pi(i.level,i.sn,i.stats.chunkCount,r.byteLength,y,v);d.push(r,f,h,"",i,s,u.totalduration,!1,E,g)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${o}`);const{cache:m}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new _o,complete:!1};m.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=I.WAITING_INIT_PTS}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==B.AUDIO){if(!this.loadedmetadata&&i.type===B.MAIN){const r=this.videoBuffer||this.media;r&&ne.getBuffered(r).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(p.AUDIO_TRACK_SWITCHED,ge({},r)))}this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=I.ERROR;return}switch(t.details){case C.FRAG_GAP:case C.FRAG_PARSING_ERROR:case C.FRAG_DECRYPT_ERROR:case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(B.AUDIO,t);break;case C.AUDIO_TRACK_LOAD_ERROR:case C.AUDIO_TRACK_LOAD_TIMEOUT:case C.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===I.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Q.AUDIO_TRACK&&(this.state=I.IDLE);break;case C.BUFFER_APPEND_ERROR:case C.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="audio")return;if(t.details===C.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case C.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==ie.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==ie.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===I.ENDED&&(this.state=I.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,B.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{details:h}=u,{audio:d,text:g,id3:f,initSegment:m}=r;if(this.fragContextChanged(l)||!h){this.fragmentTracker.removeFragment(l);return}if(this.state=I.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){const y=l.initSegment||l;this._bufferInitSegment(u,m.tracks,y,a),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:i,tracks:m.tracks})}if(d){const{startPTS:y,endPTS:v,startDTS:E,endDTS:T}=d;c&&(c.elementaryStreams[ie.AUDIO]={startPTS:y,endPTS:v,startDTS:E,endDTS:T}),l.setElementaryStreamInfo(ie.AUDIO,y,v,E,T),this.bufferFragmentData(d,l,c,a)}if(f!=null&&(t=f.samples)!=null&&t.length){const y=he({id:i,frag:l,details:h},f);s.trigger(p.FRAG_PARSING_METADATA,y)}if(g){const y=he({id:i,frag:l,details:h},g);s.trigger(p.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(e,t,i,s){if(this.state!==I.PARSING)return;t.video&&delete t.video;const r=t.audio;if(!r)return;r.id="audio";const a=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&a.split(",").length===1&&(r.levelCodec=a),this.hls.trigger(p.BUFFER_CODECS,t);const o=r.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:o};this.hls.trigger(p.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.fragCurrent=e,this.switchingTrack||s===me.NOT_LOADED||s===me.PARTIAL){var r;if(e.sn==="initSegment")this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=I.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragments[0].start!==t.details.fragments[0].start&&Mi(t.details,a)}else this.startFragRequested=!0,super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){const{media:t,bufferedTrack:i}=this,s=i==null?void 0:i.attrs,r=e.attrs;t&&s&&(s.CHANNELS!==r.CHANNELS||i.name!==e.name||i.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(p.AUDIO_TRACK_SWITCHED,ge({},e))}}class Xo extends Ii{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(d=>!i||i.indexOf(d.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(d=>d.default)&&(this.selectDefaultTrack=!1),o.forEach((d,g)=>{d.id=g});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!r&&l){const d=He(l,o,Nt);if(d>-1)r=o[d];else{const g=He(l,this.tracks);r=this.tracks[g]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const u={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(p.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(c!==-1&&h===-1)this.setAudioTrack(c);else if(o.length&&h===-1){var a;const d=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(d.message),this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:d})}}else this.shouldReloadPlaylist(r)&&this.setAudioTrack(this.trackId)}onError(e,t){t.fatal||!t.context||t.context.type===Q.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&(this.requestScheduled=-1,this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&Ot(e,s,Nt))return s;const r=He(e,this.tracksInGroup,Nt);if(r>-1){const a=this.tracksInGroup[r];return this.setAudioTrack(r),a}else if(s){let a=t.loadLevel;a===-1&&(a=t.firstAutoLevel);const o=yd(e,t.levels,i,a,Nt);if(o===-1)return null;t.nextLoadLevel=o}if(e.channels||e.audioCodec){const a=He(e,i);if(a>-1)return i[a]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(p.AUDIO_TRACK_SWITCHING,ge({},s)),r))return;const a=this.switchParams(s.url,i==null?void 0:i.details);this.loadPlaylist(a)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||Ot(e,s,Nt)))return i}if(e){const{name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(Ot({name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l},u,Nt))return c}for(let c=0;c<t.length;c++){const u=t[c];if(Gt(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(Gt(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`loading audio-track playlist ${i} "${t.name}" lang:${t.lang} group:${s}`),this.clearTimer(),this.hls.trigger(p.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}}const Qo=500;class Zo extends Oi{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",B.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.ERROR,this.onError,this),e.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.ERROR,this.onError,this),e.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=I.IDLE,this.setInterval(Qo),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(this.fragPrevious=i,this.state=I.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let a;const o=i.start;for(let c=0;c<r.length;c++)if(o>=r[c].start&&o<=r[c].end){a=r[c];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},r.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=r){a.shift();continue}else if(a[o].start<r)a[o].start=r;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,r,B.SUBTITLE)}}onFragBuffered(e,t){if(!this.loadedmetadata&&t.frag.type===B.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===B.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==I.STOPPED&&(this.state=I.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(!this.levels||zo(this.levels,t)){this.levels=t.map(i=>new St(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new St(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,B.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.setInterval(Qo)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:s,levels:r}=this,{details:a,id:o}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=r[s];if(o>=r.length||o!==s||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(i=l.details)!=null&&i.live){const h=this.mainDetails;if(a.deltaUpdateFailed||!h)return;const d=h.fragments[0];if(!l.details)a.hasProgramDateTime&&h.hasProgramDateTime?(Mi(a,h),c=a.fragments[0].start):d&&(c=d.start,dn(a,c));else{var u;c=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&d&&(c=d.start,dn(a,c))}}l.details=a,this.levelLastLoaded=l,!this.startFragRequested&&(this.mainDetails||!a.live)&&this.setStartPosition(l.details,c),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===I.IDLE&&(Ri(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&s.method==="AES-128"){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer).catch(o=>{throw r.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();r.trigger(p.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=I.IDLE})}}doTick(){if(!this.media){this.state=I.IDLE;return}if(this.state===I.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details)return;const{config:s}=this,r=this.getLoadPosition(),a=ne.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:o,len:l}=a,c=this.getFwdBufferInfo(this.media,B.MAIN),u=i.details,h=this.getMaxBufferLength(c==null?void 0:c.len)+u.levelTargetDuration;if(l>h)return;const d=u.fragments,g=d.length,f=u.edge;let m=null;const y=this.fragPrevious;if(o<f){const v=s.maxFragLookUpTolerance,E=o>f-v?0:v;m=Ri(y,d,Math.max(d[0].start,o),E),!m&&y&&y.start<d[0].start&&(m=d[0])}else m=d[g-1];if(!m)return;if(m=this.mapToInitFragWhenRequired(m),m.sn!=="initSegment"){const v=m.sn-u.startSN,E=d[v-1];E&&E.cc===m.cc&&this.fragmentTracker.getState(E)===me.NOT_LOADED&&(m=E)}this.fragmentTracker.getState(m)===me.NOT_LOADED&&this.loadFragment(m,i,o)}}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,e.sn==="initSegment"?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new pf(this.tracksBuffered[this.currentTrackId]||[])}}class pf{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}class Jo extends Ii{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=_i(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),_i(this.media.textTracks).forEach(t=>{kt(t)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,h)=>{u.id=h});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!r&&o){this.selectDefaultTrack=!1;const u=He(o,a);if(u>-1)r=a[u];else{const h=He(o,this.tracks);r=this.tracks[h]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(p.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){const r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||Ot(r,e)))return s}if(e){for(let s=0;s<t.length;s++){const r=t[s];if(Gt(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const r=t[s];if(Gt(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(Cn(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Q.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Ot(e,i))return i;const s=He(e,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=He(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(p.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=_i(e.textTracks),i=this.currentTrack;let s;if(i&&(s=t.filter(r=>Cn(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!N(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:u}=s;this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:u});const h=this.switchParams(s.url,i==null?void 0:i.details);this.loadPlaylist(h)}}class yf{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,i){const s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise(r=>{t=r}),s={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,e),i}executeNext(e){const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(s){L.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${s}`),i.onError(s);const r=this.buffers[e];r!=null&&r.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const el=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class tl{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=i=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:i,mediaSource:s}=this;this.log("Media source opened"),i&&(i.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(p.MEDIA_ATTACHED,{media:i,mediaSource:s})),s&&s.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&L.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e;const t="[buffer-controller]";this.appendSource=e.config.preferManagedMediaSource,this.log=L.log.bind(L,t),this.warn=L.warn.bind(L,t),this.error=L.error.bind(L,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_APPENDING,this.onBufferAppending,this),e.on(p.BUFFER_CODECS,this.onBufferCodecs,this),e.on(p.BUFFER_EOS,this.onBufferEos,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.FRAG_PARSED,this.onFragParsed,this),e.on(p.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_APPENDING,this.onBufferAppending,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.BUFFER_EOS,this.onBufferEos,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.FRAG_PARSED,this.onFragParsed,this),e.off(p.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new yf(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media,s=Tt(this.appendSource);if(i&&s){var r;const a=this.mediaSource=new s;this.log(`created media source: ${(r=a.constructor)==null?void 0:r.name}`),a.addEventListener("sourceopen",this._onMediaSourceOpen),a.addEventListener("sourceended",this._onMediaSourceEnded),a.addEventListener("sourceclose",this._onMediaSourceClose),a.addEventListener("startstreaming",this._onStartStreaming),a.addEventListener("endstreaming",this._onEndStreaming);const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,il(i),vf(i,o),i.load()}catch{i.src=o}else i.src=o;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(this.log("media source detaching"),t.readyState==="open")try{t.endOfStream()}catch(s){this.warn(`onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(e.removeAttribute("src"),this.appendSource&&il(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(p.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(e=>{this.resetBuffer(e)}),this._initSourceBuffer()}resetBuffer(e){const t=this.sourceBuffer[e];try{if(t){var i;this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}}catch(s){this.warn(`onBufferReset ${e}`,s)}}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length,s=Object.keys(t);if(s.forEach(a=>{if(i){const l=this.tracks[a];if(l&&typeof l.buffer.changeType=="function"){var o;const{id:c,codec:u,levelCodec:h,container:d,metadata:g}=t[a],f=Ka(l.codec,l.levelCodec),m=f==null?void 0:f.replace(el,"$1");let y=Ka(u,h);const v=(o=y)==null?void 0:o.replace(el,"$1");if(y&&m!==v){a.slice(0,5)==="audio"&&(y=xi(y,this.hls.config.preferManagedMediaSource));const E=`${d};codecs=${y}`;this.appendChangeType(a,E),this.log(`switching codec ${f} to ${y}`),this.tracks[a]={buffer:l.buffer,codec:u,container:d,levelCodec:h,metadata:g,id:c}}}}else this.pendingTracks[a]=t[a]}),i)return;const r=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==r&&(this.log(`${r} bufferCodec event(s) expected ${s.join(",")}`),this.bufferCodecEventsExpected=r),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:i}=this,s={execute:()=>{const r=this.sourceBuffer[e];r&&(this.log(`changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${e} SourceBuffer type`,r)}};i.append(s,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:i,operationQueue:s,tracks:r}=this,{data:a,type:o,frag:l,part:c,chunkMeta:u}=t,h=u.buffering[o],d=self.performance.now();h.start=d;const g=l.stats.buffering,f=c?c.stats.buffering:null;g.start===0&&(g.start=d),f&&f.start===0&&(f.start=d);const m=r.audio;let y=!1;o==="audio"&&(m==null?void 0:m.container)==="audio/mpeg"&&(y=!this.lastMpegAudioChunk||u.id===1||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);const v=l.start,E={execute:()=>{if(h.executeStart=self.performance.now(),y){const T=this.sourceBuffer[o];if(T){const _=v-T.timestampOffset;Math.abs(_)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${v} (delta: ${_}) sn: ${l.sn})`),T.timestampOffset=v)}}this.appendExecutor(a,o)},onStart:()=>{},onComplete:()=>{const T=self.performance.now();h.executeEnd=h.end=T,g.first===0&&(g.first=T),f&&f.first===0&&(f.first=T);const{sourceBuffer:_}=this,S={};for(const w in _)S[w]=ne.getBuffered(_[w]);this.appendErrors[o]=0,o==="audio"||o==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(p.BUFFER_APPENDED,{type:o,frag:l,part:c,chunkMeta:u,parent:l.type,timeRanges:S})},onError:T=>{const _={type:$.MEDIA_ERROR,parent:l.type,details:C.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:l,part:c,chunkMeta:u,error:T,err:T,fatal:!1};if(T.code===DOMException.QUOTA_EXCEEDED_ERR)_.details=C.BUFFER_FULL_ERROR;else{const S=++this.appendErrors[o];_.details=C.BUFFER_APPEND_ERROR,this.warn(`Failed ${S}/${i.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),S>=i.config.appendErrorMaxRetry&&(_.fatal=!0)}i.trigger(p.ERROR,_)}};s.append(E,o,!!this.pendingTracks[o])}onBufferFlushing(e,t){const{operationQueue:i}=this,s=r=>({execute:this.removeExecutor.bind(this,r,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(p.BUFFER_FLUSHED,{type:r})},onError:a=>{this.warn(`Failed to remove from ${r} SourceBuffer`,a)}});t.type?i.append(s(t.type),t.type):this.getSourceBufferTypes().forEach(r=>{i.append(s(r),r)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],a=s?s.elementaryStreams:i.elementaryStreams;a[ie.AUDIOVIDEO]?r.push("audiovideo"):(a[ie.AUDIO]&&r.push("audio"),a[ie.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const c=s?s.stats:i.stats;this.hls.trigger(p.FRAG_BUFFERED,{frag:i,part:s,stats:c,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce((s,r)=>{const a=this.sourceBuffer[r];return a&&(!t.type||t.type===r)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${r} sourceBuffer now EOS`))),s&&!!(!a||a.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(r=>{const a=this.sourceBuffer[r];a&&(a.ending=!1)});const{mediaSource:s}=this;if(!s||s.readyState!=="open"){s&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${s.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),s.endOfStream()}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.getSourceBufferTypes().length)return;const r=e.config,a=i.currentTime,o=t.levelTargetDuration,l=t.live&&r.liveBackBufferLength!==null?r.liveBackBufferLength:r.backBufferLength;if(N(l)&&l>0){const c=Math.max(l,o),u=Math.floor(a/o)*o-c;this.flushBackBuffer(a,o,u)}if(N(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const c=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),u=Math.max(c,o),h=Math.floor(a/o)*o+u;this.flushFrontBuffer(a,o,h)}}flushBackBuffer(e,t,i){const{details:s,sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(o=>{const l=r[o];if(l){const c=ne.getBuffered(l);if(c.length>0&&i>c.start(0)){if(this.hls.trigger(p.BACK_BUFFER_REACHED,{bufferEnd:i}),s!=null&&s.live)this.hls.trigger(p.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l.ended&&c.end(c.length-1)-e<t*2){this.log(`Cannot flush ${o} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:o})}}})}flushFrontBuffer(e,t,i){const{sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(a=>{const o=s[a];if(o){const l=ne.getBuffered(o),c=l.length;if(c<2)return;const u=l.start(c-1),h=l.end(c-1);if(i>u||e>=u&&e<=h)return;if(o.ended&&e-h<2*t){this.log(`Cannot flush ${a} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(p.BUFFER_FLUSHING,{startOffset:u,endOffset:1/0,type:a})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:e,hls:t,media:i,mediaSource:s}=this,r=e.fragments[0].start+e.totalduration,a=i.duration,o=N(s.duration)?s.duration:0;e.live&&t.config.liveDurationInfinity?(s.duration=1/0,this.updateSeekableRange(e)):(r>o&&r>a||!N(a))&&(this.log(`Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&t!=null&&t.setLiveSeekableRange){const r=Math.max(0,i[0].start),a=Math.max(r,r+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${r}-${a}.`),t.setLiveSeekableRange(r,a)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&(!e||s===2||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const r=this.getSourceBufferTypes();if(r.length)this.hls.trigger(p.BUFFER_CREATED,{tracks:this.tracks}),r.forEach(a=>{t.executeNext(a)});else{const a=new Error("could not create source buffer for media codec(s)");this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const s in e)if(!t[s]){const r=e[s];if(!r)throw Error(`source buffer exists for track ${s}, however track does not`);let a=r.levelCodec||r.codec;a&&s.slice(0,5)==="audio"&&(a=xi(a,this.hls.config.preferManagedMediaSource));const o=`${r.container};codecs=${a}`;this.log(`creating sourceBuffer(${o})`);try{const l=t[s]=i.addSourceBuffer(o),c=s;this.addBufferListener(c,"updatestart",this._onSBUpdateStart),this.addBufferListener(c,"updateend",this._onSBUpdateEnd),this.addBufferListener(c,"error",this._onSBUpdateError),this.addBufferListener(c,"bufferedchange",(u,h)=>{const d=h.removedRanges;d!=null&&d.length&&this.hls.trigger(p.BUFFER_FLUSHED,{type:s})}),this.tracks[s]={buffer:l,codec:a,container:r.container,levelCodec:r.levelCodec,metadata:r.metadata,id:r.id}}catch(l){this.error(`error while trying to add sourceBuffer: ${l.message}`),this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:l,sourceBufferName:s,mimeType:o})}}}get mediaSrc(){var e;const t=((e=this.media)==null?void 0:e.firstChild)||this.media;return t==null?void 0:t.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const{operationQueue:i}=this;i.current(e).onComplete(),i.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var i;const s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});const r=this.operationQueue.current(e);r&&r.onError(s)}removeExecutor(e,t,i){const{media:s,mediaSource:r,operationQueue:a,sourceBuffer:o}=this,l=o[e];if(!s||!r||!l){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),a.shiftAndExecuteNext(e);return}const c=N(s.duration)?s.duration:1/0,u=N(r.duration)?r.duration:1/0,h=Math.max(0,t),d=Math.min(i,c,u);d>h&&(!l.ending||l.ended)?(l.ended=!1,this.log(`Removing [${h},${d}] from the ${e} SourceBuffer`),l.remove(h,d)):a.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.sourceBuffer[t];if(!i){if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);return}i.ended=!1,i.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}const{operationQueue:i}=this,s=t.map(r=>i.appendBlocker(r));Promise.all(s).then(()=>{e(),t.forEach(r=>{const a=this.sourceBuffer[r];a!=null&&a.updating||i.shiftAndExecuteNext(r)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const s=this.sourceBuffer[e];if(!s)return;const r=i.bind(this,e);this.listeners[e].push({event:t,listener:r}),s.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach(i=>{t.removeEventListener(i.event,i.listener)})}}function il(n){const e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function vf(n,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}const sl={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},nl=function(e){let t=e;return sl.hasOwnProperty(e)&&(t=sl[e]),String.fromCharCode(t)},Me=15,Qe=100,Ef={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Tf={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Sf={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Lf={25:2,26:4,29:6,30:8,31:10,27:13,28:15},xf=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class _f{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;L.log(`${this.time} [${e}] ${i}`)}}}const Lt=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class rl{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Cf{constructor(){this.uchar=" ",this.penState=new rl}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class bf{constructor(e){this.chars=[],this.pos=0,this.currPenState=new rl,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Qe;t++)this.chars.push(new Cf);this.logger=e}equals(e){for(let t=0;t<Qe;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<Qe;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Qe;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Qe&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Qe)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=nl(e);if(this.pos>=Qe){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<Qe;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<Qe;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class bn{constructor(e){this.rows=[],this.currRow=Me-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Me;t++)this.rows.push(new bf(e));this.logger=e}reset(){for(let e=0;e<Me;e++)this.rows[e].clear();this.currRow=Me-1}equals(e){let t=!0;for(let i=0;i<Me;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Me;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Me;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+JSON.stringify(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<Me;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[r].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(a.rows[r+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,a=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[a].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<Me;r++){const a=this.rows[r].getTextString();a&&(s=r+1,e?t.push("Row "+s+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class al{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new bn(i),this.nonDisplayedMemory=new bn(i),this.lastOutputScreen=new bn(i),this.currRollUpRow=this.displayedMemory.rows[Me-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Me-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class ol{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=cl(),this.logger=void 0;const s=this.logger=new _f;this.channels=[null,new al(e,t,s),new al(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,s,r,a=!1;this.logger.time=e;for(let o=0;o<t.length;o+=2)if(s=t[o]&127,r=t[o+1]&127,!(s===0&&r===0)){if(this.logger.log(3,"["+Lt([t[o],t[o+1]])+"] -> ("+Lt([s,r])+")"),i=this.parseCmd(s,r),i||(i=this.parseMidrow(s,r)),i||(i=this.parsePAC(s,r)),i||(i=this.parseBackgroundAttributes(s,r)),!i&&(a=this.parseChars(s,r),a)){const l=this.currentChannel;l&&l>0?this.channels[l].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!i&&!a&&this.logger.log(2,"Couldn't parse cleaned data "+Lt([s,r])+" orig: "+Lt([t[o],t[o+1]]))}}parseCmd(e,t){const{cmdHistory:i}=this,s=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,r=(e===23||e===31)&&t>=33&&t<=35;if(!(s||r))return!1;if(ll(e,t,i))return Vt(null,null,i),this.logger.log(3,"Repeated command ("+Lt([e,t])+") is dropped"),!0;const a=e===20||e===21||e===23?1:2,o=this.channels[a];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),Vt(e,t,i),this.currentChannel=a,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,"MIDROW ("+Lt([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=this.cmdHistory,r=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,a=(e===16||e===24)&&t>=64&&t<=95;if(!(r||a))return!1;if(ll(e,t,s))return Vt(null,null,s),!0;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?Ef[e]:Sf[e]:i=o===1?Tf[e]:Lf[e];const l=this.channels[o];return l?(l.setPAC(this.interpretPAC(i,t)),Vt(e,t,s),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let a;r===17?a=t+80:r===18?a=t+112:a=t+144,this.logger.log(2,"Special char '"+nl(a)+"' in channel "+i),s=[a]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);if(s){const a=Lt(s);this.logger.log(3,"Char codes =  "+a.join(",")),Vt(e,t,this.cmdHistory)}return s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const a={};e===16||e===24?(r=Math.floor((t-32)/2),a.background=xf[r],t%2===1&&(a.background=a.background+"_semi")):t===45?a.background="transparent":(a.foreground="black",t===47&&(a.underline=!0));const o=e<=23?1:2;return this.channels[o].setBkgData(a),Vt(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory=cl()}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Vt(n,e,t){t.a=n,t.b=e}function ll(n,e,t){return t.a===n&&t.b===e}function cl(){return{a:null,b:null}}class Vi{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var wn=function(){if(Dt!=null&&Dt.VTTCue)return self.VTTCue;const n=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const c=l.toLowerCase();return~o.indexOf(c)?c:!1}function i(o){return t(n,o)}function s(o){return t(e,o)}function r(o,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const h in u)o[h]=u[h]}return o}function a(o,l,c){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let d="",g=!1,f=o,m=l,y=c,v=null,E="",T=!0,_="auto",S="start",w=50,b="middle",D=50,k="middle";Object.defineProperty(u,"id",r({},h,{get:function(){return d},set:function(R){d=""+R}})),Object.defineProperty(u,"pauseOnExit",r({},h,{get:function(){return g},set:function(R){g=!!R}})),Object.defineProperty(u,"startTime",r({},h,{get:function(){return f},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");f=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",r({},h,{get:function(){return m},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");m=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",r({},h,{get:function(){return y},set:function(R){y=""+R,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",r({},h,{get:function(){return v},set:function(R){v=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",r({},h,{get:function(){return E},set:function(R){const P=i(R);if(P===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=P,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",r({},h,{get:function(){return T},set:function(R){T=!!R,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",r({},h,{get:function(){return _},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");_=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",r({},h,{get:function(){return S},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");S=P,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",r({},h,{get:function(){return w},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");w=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",r({},h,{get:function(){return b},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");b=P,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",r({},h,{get:function(){return D},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");D=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",r({},h,{get:function(){return k},set:function(R){const P=s(R);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");k=P,this.hasBeenReset=!0}})),u.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class wf{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function ul(n){function e(i,s,r,a){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(a||0)}const t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Af{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function hl(n,e,t,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const a=s[r].split(t);if(a.length!==2)continue;const o=a[0],l=a[1];e(o,l)}}const An=new wn(0,0,""),Hi=An.align==="middle"?"middle":"center";function Rf(n,e,t){const i=n;function s(){const o=ul(n);if(o===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const c=new Af;hl(o,function(d,g){let f;switch(d){case"region":for(let m=t.length-1;m>=0;m--)if(t[m].id===g){c.set(d,t[m].region);break}break;case"vertical":c.alt(d,g,["rl","lr"]);break;case"line":f=g.split(","),c.integer(d,f[0]),c.percent(d,f[0])&&c.set("snapToLines",!1),c.alt(d,f[0],["auto"]),f.length===2&&c.alt("lineAlign",f[1],["start",Hi,"end"]);break;case"position":f=g.split(","),c.percent(d,f[0]),f.length===2&&c.alt("positionAlign",f[1],["start",Hi,"end","line-left","line-right","auto"]);break;case"size":c.percent(d,g);break;case"align":c.alt(d,g,["start",Hi,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&An.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",Hi);let h=c.get("position","auto");h==="auto"&&An.position===50&&(h=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=h}function a(){n=n.replace(/^\s+/,"")}if(a(),e.startTime=s(),a(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),a(),e.endTime=s(),a(),r(n,e)}function dl(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class If{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new wf,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,a=0;for(r=dl(r);a<r.length&&r[a]!=="\r"&&r[a]!==`
`;)++a;const o=r.slice(0,a);return r[a]==="\r"&&++a,r[a]===`
`&&++a,t.buffer=r.slice(a),o}function s(r){hl(r,function(a,o){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const o=r.match(/^()?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let a=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(a?a=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new wn(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{Rf(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(a=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Df=/\r\n|\n\r|\n|\r/g,Rn=function(e,t,i=0){return e.slice(i,i+t.length)===t},Pf=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!N(t)||!N(i)||!N(s)||!N(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t},In=function(e){let t=5381,i=e.length;for(;i;)t=t*33^e.charCodeAt(--i);return(t>>>0).toString()};function Dn(n,e,t){return In(n.toString())+In(e.toString())+In(t)}const kf=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(a=r)!=null&&a.new;){var a;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function Ff(n,e,t,i,s,r,a){const o=new If,l=Be(new Uint8Array(n)).trim().replace(Df,`
`).split(`
`),c=[],u=e?rf(e.baseTime,e.timescale):0;let h="00:00.000",d=0,g=0,f,m=!0;o.oncue=function(y){const v=t[i];let E=t.ccOffset;const T=(d-u)/9e4;if(v!=null&&v.new&&(g!==void 0?E=t.ccOffset=v.start:kf(t,i,T)),T){if(!e){f=new Error("Missing initPTS for VTT MPEGTS");return}E=T-t.presentationOffset}const _=y.endTime-y.startTime,S=De((y.startTime+E-g)*9e4,s*9e4)/9e4;y.startTime=Math.max(S,0),y.endTime=Math.max(S+_,0);const w=y.text.trim();y.text=decodeURIComponent(encodeURIComponent(w)),y.id||(y.id=Dn(y.startTime,y.endTime,w)),y.endTime>0&&c.push(y)},o.onparsingerror=function(y){f=y},o.onflush=function(){if(f){a(f);return}r(c)},l.forEach(y=>{if(m)if(Rn(y,"X-TIMESTAMP-MAP=")){m=!1,y.slice(16).split(",").forEach(v=>{Rn(v,"LOCAL:")?h=v.slice(6):Rn(v,"MPEGTS:")&&(d=parseInt(v.slice(7)))});try{g=Pf(h)/1e3}catch(v){f=v}return}else y===""&&(m=!1);o.parse(y+`
`)}),o.flush()}const Pn="stpp.ttml.im1t",fl=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,gl=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Mf={left:"start",center:"center",right:"end",start:"start",end:"end"};function ml(n,e,t,i){const s=K(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(o=>Be(o)),a=nf(e.baseTime,1,e.timescale);try{r.forEach(o=>t(Of(o,a)))}catch(o){i(o)}}function Of(n,e){const s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(r).reduce((h,d)=>(h[d]=s.getAttribute(`ttp:${d}`)||r[d],h),{}),o=s.getAttribute("xml:space")!=="preserve",l=pl(kn(s,"styling","style")),c=pl(kn(s,"layout","region")),u=kn(s,"body","[begin]");return[].map.call(u,h=>{const d=yl(h,o);if(!d||!h.hasAttribute("begin"))return null;const g=Mn(h.getAttribute("begin"),a),f=Mn(h.getAttribute("dur"),a);let m=Mn(h.getAttribute("end"),a);if(g===null)throw vl(h);if(m===null){if(f===null)throw vl(h);m=g+f}const y=new wn(g-e,m-e,d);y.id=Dn(y.startTime,y.endTime,y.text);const v=c[h.getAttribute("region")],E=l[h.getAttribute("style")],T=Nf(v,E,l),{textAlign:_}=T;if(_){const S=Mf[_];S&&(y.lineAlign=S),y.align=_}return he(y,T),y}).filter(h=>h!==null)}function kn(n,e,t){const i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function pl(n){return n.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function yl(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?yl(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function Nf(n,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return a&&t.hasOwnProperty(a)&&(s=t[a]),r.reduce((o,l)=>{const c=Fn(e,i,l)||Fn(n,i,l)||Fn(s,i,l);return c&&(o[l]=c),o},{})}function Fn(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function vl(n){return new Error(`Could not parse ttml timestamp ${n}`)}function Mn(n,e){if(!n)return null;let t=ul(n);return t===null&&(fl.test(n)?t=Uf(n,e):gl.test(n)&&(t=Bf(n,e))),t}function Uf(n,e){const t=fl.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function Bf(n,e){const t=gl.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class El{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ll(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this),e.on(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(p.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this),e.off(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(p.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new Vi(this,"textTrack1"),t=new Vi(this,"textTrack2"),i=new Vi(this,"textTrack3"),s=new Vi(this,"textTrack4");this.cea608Parser1=new ol(1,e,t),this.cea608Parser2=new ol(3,i,s)}}addCues(e,t,i,s,r){let a=!1;for(let o=r.length;o--;){const l=r[o],c=$f(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),a=!0,c/(i-t)>.5))return}if(a||r.push([t,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,i,s)}else{const o=this.Cues.newCue(null,t,i,s);this.hls.trigger(p.CUES_PARSED,{type:"captions",cues:o,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:a}=this;i==="main"&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(p.FRAG_LOADED,o)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(Sl(r,{name:e,lang:t,attrs:{}}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:a}=t[e],o=this.getExistingTrack(r,a);if(o)i[e]=o,kt(i[e]),to(i[e],s);else{const l=this.createTextTrack("captions",r,a);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach(t=>{kt(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ll(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)kt(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===Pn);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(zo(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const a=this.media,o=a?_i(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(o){let h=null;for(let d=0;d<o.length;d++)if(o[d]&&Sl(o[d],l)){h=o[d],o[d]=null;break}h&&(u=h)}if(u)kt(u);else{const h=Tl(l);u=this.createTextTrack(h,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&L.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,a=this.captionsProperties[r];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s,lastCc:r,lastSn:a,lastPartIndex:o}=this;if(!(!this.enabled||!i||!s)&&t.frag.type===B.MAIN){var l,c;const{cc:u,sn:h}=t.frag,d=(l=t==null||(c=t.part)==null?void 0:c.index)!=null?l:-1;h===a+1||h===a&&d===o+1||u===r||(i.reset(),s.reset()),this.lastCc=u,this.lastSn=h,this.lastPartIndex=d}}onFragLoaded(e,t){const{frag:i,payload:s}=t;if(i.type===B.SUBTITLE)if(s.byteLength){const r=i.decryptdata,a="stats"in t;if(r==null||!r.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===Pn?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;ml(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{L.log(`Failed to parse IMSC1: ${s}`),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;const{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[i.cc]&&o===-1){a.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?Ae(i.initSegment.data,new Uint8Array(s)):s;Ff(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?a.push(e):this._fallbackToIMSC1(i,s),L.log(`Failed to parse VTT cue: ${u}`),!(h&&o>i.cc)&&l.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||ml(t,this.initPTS[e.cc],()=>{i.textCodec=Pn,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>io(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(p.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===B.SUBTITLE&&this.onFragLoaded(p.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s}=this;if(!this.enabled||!i||!s)return;const{frag:r,samples:a}=t;if(!(r.type===B.MAIN&&this.closedCaptionsForLevel(r)==="NONE"))for(let o=0;o<a.length;o++){const l=a[o].bytes;if(l){const c=this.extractCea608Data(l);i.addData(a[o].pts,c[0]),s.addData(a[o].pts,c[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>an(o[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>an(o[l],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const a=e[s++],o=127&e[s++],l=127&e[s++];if(o===0&&l===0)continue;if((4&a)!==0){const u=3&a;(u===0||u===1)&&(t[u].push(o),t[u].push(l))}}return t}}function Tl(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function Sl(n,e){return!!n&&n.kind===Tl(e)&&Cn(e,n)}function $f(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function Ll(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class Ki{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.BUFFER_CODECS,this.onBufferCodecs,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&N(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&L.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,Ki.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return e}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let r=e.length-1;const a=Math.max(t,i);for(let o=0;o<e.length;o+=1){const l=e[o];if((l.width>=a||l.height>=a)&&s(l,e[o+1])){r=o;break}}return r}}class xl{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,a=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*a/r,c=this.hls;if(c.trigger(p.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let u=c.currentLevel;L.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(p.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const Wi="[eme]";class xt{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=xt.CDMCleanupPromise?[xt.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=L.debug.bind(L,Wi),this.log=L.log.bind(L,Wi),this.warn=L.warn.bind(L,Wi),this.error=L.error.bind(L,Wi),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(p.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(p.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t[e];if(s)return s.licenseUrl;if(e===ae.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,s=t.map(a=>a.audioCodec).filter(i),r=t.map(a=>a.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,s,r).then(h=>a({keySystem:u,mediaKeys:h})).catch(h=>{c.length?l(c):h instanceof Pe?o(h):o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return wa===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){const s=rh(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let a=r==null?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(s)}`),a=this.requestMediaKeySystemAccess(e,s);const o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),o.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),c.then(h=>h?this.setMediaKeysServerCertificate(u,e,h):u))),o.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),o.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${$e.hexDump(e.keyId||[])}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return $e.hexDump(e.keyId)}updateKeySession(e,t){var i;const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${$e.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),s.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const s=js(this.config),r=e.map(_a).filter(a=>!!a&&s.indexOf(a)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:a})=>{const o=ba(a);o?t(o):i(new Error(`Unable to find format for key-system "${a}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then(({keySystem:a,mediaKeys:o})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(a,o).then(()=>{this.throwIfDestroyed();const l=this.createMediaKeySessionContext({keySystem:a,mediaKeys:o,decryptdata:t});return this.generateRequestWithPreferredKeySession(l,"cenc",t.pssh,"playlist-key")}))),r.catch(a=>this.handleError(a))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Pe?this.hls.trigger(p.ERROR,e.data):this.hls.trigger(p.ERROR,{type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=_a(e.keyFormat),r=s?[s]:js(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=js(this.config)),e.length===0)throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),i===null)return;let s,r;if(t==="sinf"&&this.config.drmSystems[ae.FAIRPLAY]){const u=de(new Uint8Array(i));try{const h=zs(JSON.parse(u).sinf),d=Ma(new Uint8Array(h));if(!d)return;s=d.subarray(8,24),r=ae.FAIRPLAY}catch{this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{const u=Ih(i);if(u===null)return;u.version===0&&u.systemId===Ca.WIDEVINE&&u.data&&(s=u.data.subarray(8,24)),r=nh(u.systemId)}if(!r||!s)return;const a=$e.hexDump(s),{keyIdToKeySessionPromise:o,mediaKeySessions:l}=this;let c=o[a];for(let u=0;u<l.length;u++){const h=l[u],d=h.decryptdata;if(d.pssh||!d.keyId)continue;const g=$e.hexDump(d.keyId);if(a===g||d.uri.replace(/-/g,"").indexOf(a)!==-1){c=o[g],delete o[g],d.pssh=new Uint8Array(i),d.keyId=s,c=o[a]=c.then(()=>this.generateRequestWithPreferredKeySession(h,t,i,"encrypted-event-key-match"));break}}c||(c=o[a]=this.getKeySystemSelectionPromise([r]).then(({keySystem:u,mediaKeys:h})=>{var d;this.throwIfDestroyed();const g=new Pt("ISO-23001-7",a,(d=ba(u))!=null?d:"");return g.pssh=new Uint8Array(i),g.keyId=s,this.attemptSetMediaKeys(u,h).then(()=>{this.throwIfDestroyed();const f=this.createMediaKeySessionContext({decryptdata:g,keySystem:u,mediaKeys:h});return this.generateRequestWithPreferredKeySession(f,t,i,"encrypted-event-no-match")})})),c.catch(u=>this.handleError(u))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r,a;const o=(r=this.config.drmSystems)==null||(a=r[e.keySystem])==null?void 0:a.generateRequest;if(o)try{const f=o.call(this.hls,t,i,e);if(!f)throw new Error("Invalid response from configured generateRequest filter");t=f.initDataType,i=e.decryptdata.pssh=f.initData?new Uint8Array(f.initData):null}catch(f){var l;if(this.warn(f.message),(l=this.hls)!=null&&l.config.debug)throw f}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${s}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const u=new _n,h=e._onmessage=f=>{const m=e.mediaKeysSession;if(!m){u.emit("error",new Error("invalid state"));return}const{messageType:y,message:v}=f;this.log(`"${y}" message event for session "${m.sessionId}" message size: ${v.byteLength}`),y==="license-request"||y==="license-renewal"?this.renewLicense(e,v).catch(E=>{this.handleError(E),u.emit("error",E)}):y==="license-release"?e.keySystem===ae.FAIRPLAY&&(this.updateKeySession(e,qs("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${y}"`)},d=e._onkeystatuseschange=f=>{if(!e.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const y=e.keyStatus;u.emit("keyStatus",y),y==="expired"&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",h),e.mediaKeysSession.addEventListener("keystatuseschange",d);const g=new Promise((f,m)=>{u.on("error",m),u.on("keyStatus",y=>{y.startsWith("usable")?f():y==="output-restricted"?m(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):y==="internal-error"?m(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${y}"`)):y==="expired"?m(new Error("key expired while generating request")):this.warn(`unhandled key status change "${y}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var f;this.log(`Request generated for key-session "${(f=e.mediaKeysSession)==null?void 0:f.sessionId}" keyId: ${c}`)}).catch(f=>{throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_NO_SESSION,error:f,fatal:!1},`Error generating key-session request: ${f}`)}).then(()=>g).catch(f=>{throw u.removeAllListeners(),this.removeSession(e),f}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${$e.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${$e.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:r},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(d,g,f,m)=>{a(d.data)},onError:(d,g,f,m)=>{o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:ge({url:l.url,data:void 0},d)},`"${e}" certificate request failed (${r}). Status: ${d.code} (${d.text})`))},onTimeout:(d,g,f)=>{o(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(d,g,f)=>{o(new Error("aborted"))}};s.load(l,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),s(e)}).catch(a=>{r(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let u;for(let h=0,d=r.length;h<d;h++){var a,o;u=r[h];const g=(a=u.querySelector("name"))==null?void 0:a.textContent,f=(o=u.querySelector("value"))==null?void 0:o.textContent;g&&f&&e.setRequestHeader(g,f)}}const l=s.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return qs(atob(c))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(a=>{if(!i.decryptdata)throw a;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(a=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:a||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const a=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,e)}catch(u){this.error(u)}s(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)r(new Pe({type:$.KEY_SYSTEM_ERROR,details:C.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==ae.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Pt.clearKeyUriToKeyIdMap();const i=t.length;xt.CDMCleanupPromise=Promise.all(t.map(s=>this.removeSession(s)).concat(e==null?void 0:e.setMediaKeys(null).catch(s=>{this.log(`Could not clear media keys: ${s}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)}).catch(s=>{this.log(`Could not close sessions and clear media keys: ${s}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);return s>-1&&this.mediaKeySessions.splice(s,1),t.remove().catch(r=>{this.log(`Could not remove session: ${r}`)}).then(()=>t.close()).catch(r=>{this.log(`Could not close session: ${r}`)})}}}xt.CDMCleanupPromise=void 0;class Pe extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var Se;(function(n){n.MANIFEST="m",n.AUDIO="a",n.VIDEO="v",n.MUXED="av",n.INIT="i",n.CAPTION="c",n.TIMED_TEXT="tt",n.KEY="k",n.OTHER="o"})(Se||(Se={}));var On;(function(n){n.DASH="d",n.HLS="h",n.SMOOTH="s",n.OTHER="o"})(On||(On={}));var _t;(function(n){n.OBJECT="CMCD-Object",n.REQUEST="CMCD-Request",n.SESSION="CMCD-Session",n.STATUS="CMCD-Status"})(_t||(_t={}));const Gf={[_t.OBJECT]:["br","d","ot","tb"],[_t.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[_t.SESSION]:["cid","pr","sf","sid","st","v"],[_t.STATUS]:["bs","rtp"]};class Ht{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map(i=>i instanceof Ht?i:new Ht(i))),this.value=e,this.params=t}}class _l{constructor(e){this.description=void 0,this.description=e}}const Vf="Dict";function Hf(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function Kf(n,e,t,i){return new Error(`failed to ${n} "${Hf(e)}" as ${t}`,{cause:i})}const Cl="Bare Item",Wf="Boolean",Yf="Byte Sequence",zf="Decimal",qf="Integer";function jf(n){return n<-999999999999999||999999999999999<n}const Xf=/[\x00-\x1f\x7f]+/,Qf="Token",Zf="Key";function We(n,e,t){return Kf("serialize",n,e,t)}function Jf(n){if(typeof n!="boolean")throw We(n,Wf);return n?"?1":"?0"}function eg(n){return btoa(String.fromCharCode(...n))}function tg(n){if(ArrayBuffer.isView(n)===!1)throw We(n,Yf);return`:${eg(n)}:`}function bl(n){if(jf(n))throw We(n,qf);return n.toString()}function ig(n){return`@${bl(n.getTime()/1e3)}`}function wl(n,e){if(n<0)return-wl(-n,e);const t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){const s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}function sg(n){const e=wl(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw We(n,zf);const t=e.toString();return t.includes(".")?t:`${t}.0`}const ng="String";function rg(n){if(Xf.test(n))throw We(n,ng);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function ag(n){return n.description||n.toString().slice(7,-1)}function Al(n){const e=ag(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw We(e,Qf);return e}function Nn(n){switch(typeof n){case"number":if(!N(n))throw We(n,Cl);return Number.isInteger(n)?bl(n):sg(n);case"string":return rg(n);case"symbol":return Al(n);case"boolean":return Jf(n);case"object":if(n instanceof Date)return ig(n);if(n instanceof Uint8Array)return tg(n);if(n instanceof _l)return Al(n);default:throw We(n,Cl)}}function Un(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw We(n,Zf);return n}function Bn(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${Un(e)}`:`;${Un(e)}=${Nn(t)}`).join("")}function Rl(n){return n instanceof Ht?`${Nn(n.value)}${Bn(n.params)}`:Nn(n)}function og(n){return`(${n.value.map(Rl).join(" ")})${Bn(n.params)}`}function lg(n,e={whitespace:!0}){if(typeof n!="object")throw We(n,Vf);const t=n instanceof Map?n.entries():Object.entries(n),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof Ht||(r=new Ht(r));let a=Un(s);return r.value===!0?a+=Bn(r.params):(a+="=",Array.isArray(r.value)?a+=og(r):a+=Rl(r)),a}).join(`,${i}`)}function cg(n,e){return lg(n,e)}const ug=n=>n==="ot"||n==="sf"||n==="st",hg=n=>typeof n=="number"?N(n):n!=null&&n!==""&&n!==!1;function dg(n,e){const t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;const s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}function fg(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}const Yi=n=>Math.round(n),gg=(n,e)=>(e!=null&&e.baseUrl&&(n=dg(n,e.baseUrl)),encodeURIComponent(n)),zi=n=>Yi(n/100)*100,mg={br:Yi,d:Yi,bl:zi,dl:zi,mtp:zi,nor:gg,rtp:zi,tb:Yi};function pg(n,e){const t={};if(n==null||typeof n!="object")return t;const i=Object.keys(n).sort(),s=he({},mg,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(a=>{if(r!=null&&r(a))return;let o=n[a];const l=s[a];l&&(o=l(o,e)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||hg(o)&&(ug(a)&&typeof o=="string"&&(o=new _l(o)),t[a]=o))}),t}function Il(n,e={}){return n?cg(pg(n,e),he({whitespace:!1},e)):""}function yg(n,e={}){if(!n)return{};const t=Object.entries(n),i=Object.entries(Gf).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),s=t.reduce((r,a)=>{var o,l;const[c,u]=a,h=((o=i.find(d=>d[1].includes(c)))==null?void 0:o[0])||_t.REQUEST;return(l=r[h])!=null||(r[h]={}),r[h][c]=u,r},{});return Object.entries(s).reduce((r,[a,o])=>(r[a]=Il(o,e),r),{})}function vg(n,e,t){return he(n,yg(e,t))}const Eg="CMCD";function Tg(n,e={}){if(!n)return"";const t=Il(n,e);return`${Eg}=${encodeURIComponent(t)}`}const Dl=/CMCD=[^&#]+/;function Sg(n,e,t){const i=Tg(e,t);if(!i)return n;if(Dl.test(n))return n.replace(Dl,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class Pl{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:Se.MANIFEST,su:!this.initialized})}catch(r){L.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const r=s.frag,a=this.hls.levels[r.level],o=this.getObjectType(r),l={d:r.duration*1e3,ot:o};(o===Se.VIDEO||o===Se.AUDIO||o==Se.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(o)/1e3,l.bl=this.getBufferLength(o)),this.apply(s,l)}catch(r){L.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||fg(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHED,this.onMediaDetached,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHED,this.onMediaDetached,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:On.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){he(t,this.createData());const i=t.ot===Se.INIT||t.ot===Se.VIDEO||t.ot===Se.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((r,a)=>(s.includes(a)&&(r[a]=t[a]),r),{})),this.useHeaders?(e.headers||(e.headers={}),vg(e.headers,t)):e.url=Sg(e.url,t)}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Se.TIMED_TEXT;if(e.sn==="initSegment")return Se.INIT;if(t==="audio")return Se.AUDIO;if(t==="main")return this.hls.audioTracks.length?Se.VIDEO:Se.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===Se.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,a=r>-1?r+1:s.levels.length;i=s.levels.slice(0,a)}for(const r of i)r.bitrate>t&&(t=r.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.hls.media,i=e===Se.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:ne.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}}const Lg=3e5;class kl{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=L.log.bind(L,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===fe.SendAlternateToPenaltyBox&&i.flags===Ie.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this.pathwayPriority,a=this.pathwayId;if(t.context){const{groupId:o,pathwayId:l,type:c}=t.context;o&&s?a=this.getPathwayForGroupId(o,c,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!r&&s&&(r=s.reduce((o,l)=>(o.indexOf(l.pathwayId)===-1&&o.push(l.pathwayId),o),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==a),i.resolved||L.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${a} levels: ${s&&s.length} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this.pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>Lg&&delete i[r]});for(let r=0;r<e.length;r++){const a=e[r];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(a),t.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,co(t),this.hls.trigger(p.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(e,t,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===Q.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===Q.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(t.some(u=>u.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(u=>{const h=new oe(u.attrs);h["PATHWAY-ID"]=a;const d=h.AUDIO&&`${h.AUDIO}_clone_${a}`,g=h.SUBTITLES&&`${h.SUBTITLES}_clone_${a}`;d&&(i[h.AUDIO]=d,h.AUDIO=d),g&&(s[h.SUBTITLES]=g,h.SUBTITLES=g);const f=Ml(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),m=new St({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:f,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let y=1;y<u.audioGroups.length;y++)m.addGroupId("audio",`${u.audioGroups[y]}_clone_${a}`);if(u.subtitleGroups)for(let y=1;y<u.subtitleGroups.length;y++)m.addGroupId("text",`${u.subtitleGroups[y]}_clone_${a}`);return m});t.push(...c),Fl(this.audioTracks,i,l,a),Fl(this.subtitleTracks,s,l,a)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+u)}const r={responseType:"json",url:s.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(u,h,d,g)=>{this.log(`Loaded steering manifest: "${s}"`);const f=u.data;if(f.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":y,"PATHWAY-PRIORITY":v}=f;if(m)try{this.uri=new self.URL(m,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||d.url),y&&this.clonePathways(y);const E={steeringManifest:f,url:s.toString()};this.hls.trigger(p.STEERING_MANIFEST_LOADED,E),v&&this.updatePathwayPriority(v)},onError:(u,h,d,g)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let f=this.timeToLoad*1e3;if(u.code===429){const m=this.loader;if(typeof(m==null?void 0:m.getResponseHeader)=="function"){const y=m.getResponseHeader("Retry-After");y&&(f=parseFloat(y)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,f)},onTimeout:(u,h,d)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function Fl(n,e,t,i){n&&Object.keys(e).forEach(s=>{const r=n.filter(a=>a.groupId===s).map(a=>{const o=he({},a);return o.details=void 0,o.attrs=new oe(o.attrs),o.url=o.attrs.URI=Ml(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[s],o.attrs["PATHWAY-ID"]=i,o});n.push(...r)})}function Ml(n,e,t,i){const{HOST:s,PARAMS:r,[t]:a}=i;let o;e&&(o=a==null?void 0:a[e],o&&(n=o));const l=new self.URL(n);return s&&!o&&(l.host=s),r&&Object.keys(r).sort().forEach(c=>{c&&l.searchParams.set(c,r[c])}),l.href}const xg=/^age:\s*[\d.]+\s*$/im;class Ol{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Zt,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!this.stats.aborted)return r(i,t.url)}).catch(a=>(i.open("GET",t.url,!0),r(i,t.url))).then(()=>{this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(a=>{this.callbacks.onError({code:i.status,text:a.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=i.loadPolicy;if(s)for(const o in s)e.setRequestHeader(o,s[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&N(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const a=t.status,o=t.responseType!=="text";if(a>=200&&a<300&&(o&&t.response||t.responseText!==null)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const l=o?t.response:t.responseText,c=t.responseType==="arraybuffer"?l.byteLength:l.length;if(i.loaded=i.total=c,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const u=this.callbacks.onProgress;if(u&&u(i,e,l,t),!this.callbacks)return;const h={url:t.responseURL,data:l,code:a};this.callbacks.onSuccess(h,i,e,t)}else{const l=r.loadPolicy.errorRetry,c=i.retry,u={url:e.url,data:void 0,code:a};Ai(l,c,!1,u)?this.retry(l):(L.error(`${a} while loading ${e.url}`),this.callbacks.onError({code:a,text:t.statusText},e,t,i))}}}loadtimeout(){var e;const t=(e=this.config)==null?void 0:e.loadPolicy.timeoutRetry,i=this.stats.retry;if(Ai(t,i,!0))this.retry(t);else{var s;L.warn(`timeout while loading ${(s=this.context)==null?void 0:s.url}`);const r=this.callbacks;r&&(this.abortInternal(),r.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=fn(e,i.retry),i.retry++,L.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&xg.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}function _g(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const Cg=/(\d+)-(\d+)\/(\d+)/;class Nl{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Rg,this.controller=new self.AbortController,this.stats=new Zt}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=bg(e,this.controller.signal),a=i.onProgress,o=e.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:u}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=c&&N(c)?c:u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},t.timeout),self.fetch(this.request).then(h=>{this.response=this.loader=h;const d=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},u-(d-s.loading.start)),!h.ok){const{status:g,statusText:f}=h;throw new Ig(f||"fetch, bad network response",g,h)}return s.loading.first=d,s.total=Ag(h.headers)||s.total,a&&N(t.highWaterMark)?this.loadProgressively(h,s,e,t.highWaterMark,a):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{const d=this.response;if(!d)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const g=h[l];g&&(s.loaded=s.total=g);const f={url:d.url,data:h,code:d.status};a&&!N(t.highWaterMark)&&a(s,e,h,d),i.onSuccess(f,s,e,d)}).catch(h=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const d=h&&h.code||0,g=h?h.message:null;i.onError({code:d,text:g},e,h?h.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const a=new _o,o=e.body.getReader(),l=()=>o.read().then(c=>{if(c.done)return a.dataLength&&r(t,i,a.flush(),e),Promise.resolve(new ArrayBuffer(0));const u=c.value,h=u.length;return t.loaded+=h,h<s||a.dataLength?(a.push(u),a.dataLength>=s&&r(t,i,a.flush(),e)):r(t,i,u,e),l()}).catch(()=>Promise.reject());return l()}}function bg(n,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(he({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function wg(n){const e=Cg.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function Ag(n){const e=n.get("Content-Range");if(e){const i=wg(e);if(N(i))return i}const t=n.get("Content-Length");if(t)return parseInt(t)}function Rg(n,e){return new self.Request(n.url,e)}class Ig extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const Dg=/\s/,Pg={newCue(n,e,t,i){const s=[];let r,a,o,l,c;const u=self.VTTCue||self.TextTrackCue;for(let d=0;d<i.rows.length;d++)if(r=i.rows[d],o=!0,l=0,c="",!r.isEmpty()){var h;for(let m=0;m<r.chars.length;m++)Dg.test(r.chars[m].uchar)&&o?l++:(c+=r.chars[m].uchar,o=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const g=dl(c.trim()),f=Dn(e,t,g);n!=null&&(h=n.cues)!=null&&h.getCueById(f)||(a=new u(e,t,g),a.id=f,a.line=d+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),s.push(a))}return n&&s.length&&(s.sort((d,g)=>d.line==="auto"||g.line==="auto"?0:d.line>8&&g.line>8?g.line-d.line:d.line-g.line),s.forEach(d=>io(n,d))),s}},kg={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Ul=ge(ge({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Ol,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:vo,bufferController:tl,capLevelController:Ki,errorController:go,fpsController:xl,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:wa,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:kg},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Fg()),{},{subtitleStreamController:Zo,subtitleTrackController:Jo,timelineController:El,audioStreamController:jo,audioTrackController:Xo,emeController:xt,cmcdController:Pl,contentSteeringController:kl});function Fg(){return{cueHandler:Pg,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Mg(n,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const t=$n(n),i=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const a=`${r==="level"?"playlist":r}LoadPolicy`,o=e[a]===void 0,l=[];s.forEach(c=>{const u=`${r}Loading${c}`,h=e[u];if(h!==void 0&&o){l.push(u);const d=t[a].default;switch(e[a]={default:d},c){case"TimeOut":d.maxLoadTimeMs=h,d.maxTimeToFirstByteMs=h;break;case"MaxRetry":d.errorRetry.maxNumRetry=h,d.timeoutRetry.maxNumRetry=h;break;case"RetryDelay":d.errorRetry.retryDelayMs=h,d.timeoutRetry.retryDelayMs=h;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=h,d.timeoutRetry.maxRetryDelayMs=h;break}}}),l.length&&L.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${JSON.stringify(e[a])}`)}),ge(ge({},t),e)}function $n(n){return n&&typeof n=="object"?Array.isArray(n)?n.map($n):Object.keys(n).reduce((e,t)=>(e[t]=$n(n[t]),e),{}):n}function Og(n){const e=n.loader;e!==Nl&&e!==Ol?(L.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):_g()&&(n.loader=Nl,n.progressive=!0,n.enableSoftwareAES=!0,L.log("[config]: Progressive streaming enabled, using FetchLoader"))}let Gn;class Ng extends Ii{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,s=[],r={},a={};let o=!1,l=!1,c=!1;t.levels.forEach(u=>{var h,d;const g=u.attrs;let{audioCodec:f,videoCodec:m}=u;((h=f)==null?void 0:h.indexOf("mp4a.40.34"))!==-1&&(Gn||(Gn=/chrome|firefox/i.test(navigator.userAgent)),Gn&&(u.audioCodec=f=void 0)),f&&(u.audioCodec=f=xi(f,i)),((d=m)==null?void 0:d.indexOf("avc1"))===0&&(m=u.videoCodec=Oh(m));const{width:y,height:v,unknownCodecs:E}=u;if(o||(o=!!(y&&v)),l||(l=!!m),c||(c=!!f),E!=null&&E.length||f&&!sn(f,"audio",i)||m&&!sn(m,"video",i))return;const{CODECS:T,"FRAME-RATE":_,"HDCP-LEVEL":S,"PATHWAY-ID":w,RESOLUTION:b,"VIDEO-RANGE":D}=g,R=`${`${w||"."}-`}${u.bitrate}-${b}-${_}-${T}-${D}-${S}`;if(r[R])if(r[R].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const P=a[R]+=1;u.attrs["PATHWAY-ID"]=new Array(P+1).join(".");const W=new St(u);r[R]=W,s.push(W)}else r[R].addGroupId("audio",g.AUDIO),r[R].addGroupId("text",g.SUBTITLES);else{const P=new St(u);r[R]=P,a[R]=1,s.push(P)}}),this.filterAndSortMediaOptions(s,t,o,l,c)}filterAndSortMediaOptions(e,t,i,s,r){let a=[],o=[],l=e;if((i||s)&&r&&(l=l.filter(({videoCodec:f,videoRange:m,width:y,height:v})=>(!!f||!!(y&&v))&&jh(m))),l.length===0){Promise.resolve().then(()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const f=new Error("no level with compatible codecs found in manifest");this.hls.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:f,reason:f.message})}});return}if(t.audioTracks){const{preferManagedMediaSource:f}=this.hls.config;a=t.audioTracks.filter(m=>!m.audioCodec||sn(m.audioCodec,"audio",f)),Bl(a)}t.subtitles&&(o=t.subtitles,Bl(o));const c=l.slice(0);l.sort((f,m)=>{if(f.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"])return(f.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&f.height!==m.height)return f.height-m.height;if(f.frameRate!==m.frameRate)return f.frameRate-m.frameRate;if(f.videoRange!==m.videoRange)return bi.indexOf(f.videoRange)-bi.indexOf(m.videoRange);if(f.videoCodec!==m.videoCodec){const y=Ha(f.videoCodec),v=Ha(m.videoCodec);if(y!==v)return v-y}if(f.uri===m.uri&&f.codecSet!==m.codecSet){const y=Li(f.codecSet),v=Li(m.codecSet);if(y!==v)return v-y}return f.bitrate!==m.bitrate?f.bitrate-m.bitrate:0});let u=c[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==c.length)){for(let f=0;f<c.length;f++)if(c[f].pathwayId===l[0].pathwayId){u=c[f];break}}this._levels=l;for(let f=0;f<l.length;f++)if(l[f]===u){var h;this._firstLevel=f;const m=u.bitrate,y=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${m}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){const v=Math.min(m,this.hls.config.abrEwmaDefaultEstimateMax);v>y&&y===Ul.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=v)}break}const d=r&&!s,g={levels:l,audioTracks:a,subtitleTracks:o,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:!d&&a.some(f=>!!f.url)};this.hls.trigger(p.MANIFEST_PARSED,g),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(p.ERROR,{type:$.OTHER_ERROR,details:C.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,a=t[e],o=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=a,i===e&&a.details&&s&&r===o)return;this.log(`Switching to level ${e} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${o?" with Pathway "+o:""} from level ${i}${r?" with Pathway "+r:""}`);const l={level:e,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(p.LEVEL_SWITCHING,l);const c=a.details;if(!c||c.live){const u=this.switchParams(a.uri,s==null?void 0:s.details);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){t.fatal||!t.context||t.context.type===Q.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===B.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,a=this._levels[s];if(!a){var o;this.warn(`Invalid level index ${s}`),(o=t.deliveryDirectives)!=null&&o.skip&&(r.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0),this.playlistLoaded(s,t,a.details)):(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let s=i.uri;if(e)try{s=e.addDirectives(s)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}const r=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${(e==null?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""} with${r?" Pathway "+r:""} ${s}`),this.clearTimer(),this.hls.trigger(p.LEVEL_LOADING,{url:s,level:t,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const i=this._levels.filter((s,r)=>r!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));co(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(p.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(p.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function Bl(n){const e={};n.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}class Ug{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=C.KEY_LOAD_ERROR,i,s,r){return new je({type:$.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){const a=t[r];if(s<=a.cc&&(i==="initSegment"||a.sn==="initSegment"||i<a.sn)){this.emeController.selectKeySystemFormat(a).then(o=>{a.setKeyFormat(o)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const c=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,c))}const a=r.uri;if(!a)return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${a}"`)));let o=this.keyUriToKeyInfo[a];if((i=o)!=null&&i.decryptdata.key)return r.key=o.decryptdata.key,Promise.resolve({frag:e,keyInfo:o});if((s=o)!=null&&s.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(c=>(r.key=c.keyInfo.decryptdata.key,{frag:e,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[a]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(o,e):this.loadKeyEME(o,e);case"AES-128":return this.loadKeyHTTP(o,e);default:return Promise.reject(this.createKeyLoadError(e,C.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((a,o)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},c=i.keyLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(d,g,f,m)=>{const{frag:y,keyInfo:v,url:E}=f;if(!y.decryptdata||v!==this.keyUriToKeyInfo[E])return o(this.createKeyLoadError(y,C.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));v.decryptdata.key=y.decryptdata.key=new Uint8Array(d.data),y.keyLoader=null,v.loader=null,a({frag:y,keyInfo:v})},onError:(d,g,f,m)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.KEY_LOAD_ERROR,new Error(`HTTP Error ${d.code} loading key ${d.text}`),f,ge({url:l.url,data:void 0},d)))},onTimeout:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),f))},onAbort:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(t,C.INTERNAL_ABORTED,new Error("key loading aborted"),f))}};r.load(l,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function $l(){return self.SourceBuffer||self.WebKitSourceBuffer}function Vn(){if(!Tt())return!1;const e=$l();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function Gl(){if(!Vn())return!1;const n=Tt();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(ei(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(ei(e,"audio"))))}function Bg(){var n;const e=$l();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}const $g=250,qi=2,Gg=.1,Vg=.05;class Hg{constructor(e,t,i,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:s,stalled:r}=this;if(s===null)return;const{currentTime:a,seeking:o}=s,l=this.seeking&&!o,c=!this.seeking&&o;if(this.seeking=o,a!==e){if(this.moved=!0,o||(this.nudgeRetry=0),r!==null){if(this.stallReported){const y=self.performance.now()-r;L.warn(`playback not stuck anymore @${a}, after ${Math.round(y)}ms`),this.stallReported=!1}this.stalled=null}return}if(c||l){this.stalled=null;return}if(s.paused&&!o||s.ended||s.playbackRate===0||!ne.getBuffered(s).length){this.nudgeRetry=0;return}const u=ne.bufferInfo(s,a,0),h=u.nextStart||0;if(o){const y=u.len>qi,v=!h||t&&t.start<=a||h-a>qi&&!this.fragmentTracker.getPartialFragment(a);if(y||v)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var d;if(!(u.len>0)&&!h)return;const v=Math.max(h,u.start||0)-a,E=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,_=(E==null||(d=E.details)==null?void 0:d.live)?E.details.targetduration*2:qi,S=this.fragmentTracker.getPartialFragment(a);if(v>0&&(v<=_||S)){s.paused||this._trySkipBufferHole(S);return}}const g=self.performance.now();if(r===null){this.stalled=g;return}const f=g-r;if(!o&&f>=$g&&(this._reportStall(u),!this.media))return;const m=ne.bufferInfo(s,a,i.maxBufferHole);this._tryFixBufferStall(m,f)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:s,media:r}=this;if(r===null)return;const a=r.currentTime,o=s.getPartialFragment(a);o&&(this._trySkipBufferHole(o)||!this.media)||(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-a<i.maxBufferHole)&&t>i.highBufferWatchdogPeriod*1e3&&(L.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:s}=this;if(!s&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);L.warn(r.message),t.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:s}=this;if(s===null)return 0;const r=s.currentTime,a=ne.bufferInfo(s,r,0),o=r<a.start?a.start:a.nextStart;if(o){const l=a.len<=t.maxBufferHole,c=a.len>0&&a.len<1&&s.readyState<3,u=o-r;if(u>0&&(l||c)){if(u>t.maxBufferHole){const{fragmentTracker:d}=this;let g=!1;if(r===0){const f=d.getAppendedFrag(0,B.MAIN);f&&o<f.end&&(g=!0)}if(!g){const f=e||d.getAppendedFrag(r,B.MAIN);if(f){let m=!1,y=f.end;for(;y<o;){const v=d.getPartialFragment(y);if(v)y+=v.duration;else{m=!0;break}}if(m)return 0}}}const h=Math.max(o+Vg,r+Gg);if(L.warn(`skipping hole, adjusting currentTime from ${r} to ${h}`),this.moved=!0,this.stalled=null,s.currentTime=h,e&&!e.gap){const d=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${h}`);i.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:d,reason:d.message,frag:e})}return h}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:s}=this;if(i===null)return;const r=i.currentTime;if(this.nudgeRetry++,s<e.nudgeMaxRetry){const a=r+(s+1)*e.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${r} to ${a}`);L.warn(o.message),i.currentTime=a,t.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const a=new Error(`Playhead still not moving while enough data buffered @${r} after ${e.nudgeMaxRetry} nudges`);L.error(a.message),t.trigger(p.ERROR,{type:$.MEDIA_ERROR,details:C.BUFFER_STALLED_ERROR,error:a,fatal:!0})}}}const Kg=100;class Wg extends Oi{constructor(e,t,i){super(e,t,i,"[stream-controller]",B.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(p.ERROR,this.onError,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(p.ERROR,this.onError,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(Kg),this.level=-1,!this.startFragRequested){let s=i.startLevel;s===-1&&(i.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=i.firstAutoLevel),this.level=i.nextLoadLevel=s,this.loadedmetadata=!1}t>0&&e===-1&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=I.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=I.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case I.WAITING_LEVEL:{const{levels:t,level:i}=this,s=t==null?void 0:t[i],r=s==null?void 0:s.details;if(r&&(!r.live||this.levelLastLoaded===s)){if(this.waitForCdnTuneIn(r))break;this.state=I.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=I.IDLE;break}break}case I.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:s,level:r}=this,a=s==null?void 0:s[r];this.resetStartWhenNotLoaded(a||null),this.state=I.IDLE}}break}this.state===I.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this,{config:r,nextLoadLevel:a}=e;if(t===null||!s&&(this.startFragRequested||!r.startFragPrefetch)||this.altAudio&&this.audioOnly||!(i!=null&&i[a]))return;const o=i[a],l=this.getMainFwdBufferInfo();if(l===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(l,c)){const y={};this.altAudio&&(y.type="video"),this.hls.trigger(p.BUFFER_EOS,y),this.state=I.ENDED;return}e.loadLevel!==a&&e.manualLevel===-1&&this.log(`Adapting to level ${a} from level ${this.level}`),this.level=e.nextLoadLevel=a;const u=o.details;if(!u||this.state===I.WAITING_LEVEL||u.live&&this.levelLastLoaded!==o){this.level=a,this.state=I.WAITING_LEVEL;return}const h=l.len,d=this.getMaxBufferLength(o.maxBitrate);if(h>=d)return;this.backtrackFragment&&this.backtrackFragment.start>l.end&&(this.backtrackFragment=null);const g=this.backtrackFragment?this.backtrackFragment.start:l.end;let f=this.getNextFragment(g,u);if(this.couldBacktrack&&!this.fragPrevious&&f&&f.sn!=="initSegment"&&this.fragmentTracker.getState(f)!==me.OK){var m;const v=((m=this.backtrackFragment)!=null?m:f).sn-u.startSN,E=u.fragments[v-1];E&&f.cc===E.cc&&(f=E,this.fragmentTracker.removeFragment(E))}else this.backtrackFragment&&l.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,g)){if(!f.gap){const v=this.audioOnly&&!this.altAudio?ie.AUDIO:ie.VIDEO,E=(v===ie.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;E&&this.afterBufferFlushed(E,v,B.MAIN)}f=this.getNextFragmentLoopLoading(f,u,l,B.MAIN,d)}f&&(f.initSegment&&!f.initSegment.data&&!this.bitrateTest&&(f=f.initSegment),this.loadFragment(f,o,g))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);this.fragCurrent=e,s===me.NOT_LOADED||s===me.PARTIAL?e.sn==="initSegment"?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,B.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<r.targetduration*2)return}if(!t.paused&&e){const o=this.hls.nextLoadLevel,l=e[o],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const a=this.getBufferedFrag(t.currentTime+i);if(a){const o=this.followingBufferedFrag(a);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,c=o.duration,u=Math.max(a.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case I.KEY_LOADING:case I.FRAG_LOADING:case I.FRAG_LOADING_WAITING_RETRY:case I.PARSING:case I.PARSED:this.state=I.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new Hg(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;N(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(p.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let i=!1,s=!1;t.levels.forEach(r=>{const a=r.audioCodec;a&&(i=i||a.indexOf("mp4a.40.2")!==-1,s=s||a.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!Bg(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==I.IDLE)return;const s=i[t.level];(!s.details||s.details.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(s.details))&&(this.state=I.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s}=this,r=t.level,a=t.details,o=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=s[r],c=this.fragCurrent;c&&(this.state===I.FRAG_LOADING||this.state===I.FRAG_LOADING_WAITING_RETRY)&&c.level!==t.level&&c.loader&&this.abortCurrentFrag();let u=0;if(a.live||(i=l.details)!=null&&i.live){var h;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;u=this.alignPlaylists(a,l.details,(h=this.levelLastLoaded)==null?void 0:h.details)}if(l.details=a,this.levelLastLoaded=l,this.hls.trigger(p.LEVEL_UPDATED,{details:a,level:r}),this.state===I.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=I.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,u),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{levels:a}=this;if(!a){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const o=a[i.level],l=o.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=o.videoCodec,u=l.PTSKnown||!l.live,h=(t=i.initSegment)==null?void 0:t.data,d=this._getAudioCodec(o),g=this.transmuxer=this.transmuxer||new Yo(this.hls,B.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=s?s.index:-1,m=f!==-1,y=new Pi(i.level,i.sn,i.stats.chunkCount,r.byteLength,f,m),v=this.initPTS[i.cc];g.push(r,h,d,c,i,s,l.totalduration,u,y,v)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const a=this.fragCurrent;a&&(this.log("Switching to main audio track, cancel main fragment load"),a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const r=this.hls;i&&(r.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),r.trigger(p.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,s=!!this.hls.audioTracks[i].url;if(s){const r=this.videoBuffer;r&&this.mediaBuffer!==r&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=r)}this.altAudio=s,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,a=!1;for(const o in i){const l=i[o];if(l.id==="main"){if(r=o,s=l,o==="video"){const c=i[o];c&&(this.videoBuffer=c.buffer)}}else a=!0}a&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i&&i.type!==B.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===I.PARSED&&(this.state=I.IDLE);return}const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=I.ERROR;return}switch(t.details){case C.FRAG_GAP:case C.FRAG_PARSING_ERROR:case C.FRAG_DECRYPT_ERROR:case C.FRAG_LOAD_ERROR:case C.FRAG_LOAD_TIMEOUT:case C.KEY_LOAD_ERROR:case C.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(B.MAIN,t);break;case C.LEVEL_LOAD_ERROR:case C.LEVEL_LOAD_TIMEOUT:case C.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===I.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Q.LEVEL&&(this.state=I.IDLE);break;case C.BUFFER_APPEND_ERROR:case C.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="main")return;if(t.details===C.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case C.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}checkBuffer(){const{media:e,gapController:t}=this;if(!(!e||!t||!e.readyState)){if(this.loadedmetadata||!ne.getBuffered(e).length){const i=this.state!==I.IDLE?this.fragCurrent:null;t.poll(this.lastCurrentTime,i)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=I.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==ie.AUDIO||this.audioOnly&&!this.altAudio){const i=(t===ie.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,t,B.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=ne.getBuffered(e),a=(s.length?s.start(0):0)-i;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${a} to match buffer start`),i+=a,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=I.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=e.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),s.trigger(p.FRAG_LOADED,i),e.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{video:h,text:d,id3:g,initSegment:f}=r,{details:m}=u,y=this.altAudio?void 0:r.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=I.PARSING,f){if(f!=null&&f.tracks){const T=l.initSegment||l;this._bufferInitSegment(u,f.tracks,T,a),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:i,tracks:f.tracks})}const v=f.initPTS,E=f.timescale;N(v)&&(this.initPTS[l.cc]={baseTime:v,timescale:E},s.trigger(p.INIT_PTS_FOUND,{frag:l,id:i,initPTS:v,timescale:E}))}if(h&&m&&l.sn!=="initSegment"){const v=m.fragments[l.sn-1-m.startSN],E=l.sn===m.startSN,T=!v||l.cc>v.cc;if(r.independent!==!1){const{startPTS:_,endPTS:S,startDTS:w,endDTS:b}=h;if(c)c.elementaryStreams[h.type]={startPTS:_,endPTS:S,startDTS:w,endDTS:b};else if(h.firstKeyFrame&&h.independent&&a.id===1&&!T&&(this.couldBacktrack=!0),h.dropped&&h.independent){const D=this.getMainFwdBufferInfo(),k=(D?D.end:this.getLoadPosition())+this.config.maxBufferHole,R=h.firstKeyFramePTS?h.firstKeyFramePTS:_;if(!E&&k<R-this.config.maxBufferHole&&!T){this.backtrack(l);return}else T&&(l.gap=!0);l.setElementaryStreamInfo(h.type,l.start,S,l.start,b,!0)}else E&&_>qi&&(l.gap=!0);l.setElementaryStreamInfo(h.type,_,S,w,b),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(h,l,c,a,E||T)}else if(E||T)l.gap=!0;else{this.backtrack(l);return}}if(y){const{startPTS:v,endPTS:E,startDTS:T,endDTS:_}=y;c&&(c.elementaryStreams[ie.AUDIO]={startPTS:v,endPTS:E,startDTS:T,endDTS:_}),l.setElementaryStreamInfo(ie.AUDIO,v,E,T,_),this.bufferFragmentData(y,l,c,a)}if(m&&g!=null&&(t=g.samples)!=null&&t.length){const v={id:i,frag:l,details:m,samples:g.samples};s.trigger(p.FRAG_PARSING_METADATA,v)}if(m&&d){const v={id:i,frag:l,details:m,samples:d.samples};s.trigger(p.FRAG_PARSING_USERDATA,v)}}_bufferInitSegment(e,t,i,s){if(this.state!==I.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:a,audiovideo:o}=t;if(r){let l=e.audioCodec;const c=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5"),r.metadata.channelCount!==1&&c.indexOf("firefox")===-1&&(l="mp4a.40.5")),l&&l.indexOf("mp4a.40.5")!==-1&&c.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),e.audioCodec&&e.audioCodec!==l&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${l}"`),r.levelCodec=l,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${l||""}/${e.audioCodec||""}/${r.codec}]`)}a&&(a.levelCodec=e.videoCodec,a.id="main",this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${e.videoCodec||""}/${a.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${e.codecs}/${o.codec}]`),this.hls.trigger(p.BUFFER_CODECS,t),Object.keys(t).forEach(l=>{const u=t[l].initSegment;u!=null&&u.byteLength&&this.hls.trigger(p.BUFFER_APPENDING,{type:l,data:u,frag:i,part:null,chunkMeta:s,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,B.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=I.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(ne.isBuffered(e,i)?t=this.getAppendedFrag(i):ne.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(p.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(p.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&N(t)&&N(i.programDateTime)){const s=i.programDateTime+(t-i.start)*1e3;return new Date(s)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class ot{static get version(){return"1.5.1"}static isMSESupported(){return Vn()}static isSupported(){return Gl()}static getMediaSource(){return Tt()}static get Events(){return p}static get ErrorTypes(){return $}static get ErrorDetails(){return C}static get DefaultConfig(){return ot.defaultConfig?ot.defaultConfig:Ul}static set DefaultConfig(e){ot.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new _n,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,Xu(e.debug||!1,"Hls instance");const t=this.config=Mg(ot.DefaultConfig,e);this.userConfig=e,t.progressive&&Og(t);const{abrController:i,bufferController:s,capLevelController:r,errorController:a,fpsController:o}=t,l=new a(this),c=this.abrController=new i(this),u=this.bufferController=new s(this),h=this.capLevelController=new r(this),d=new o(this),g=new Gh(this),f=new Yh(this),m=t.contentSteeringController,y=m?new m(this):null,v=this.levelController=new Ng(this,y),E=new Ed(this),T=new Ug(this.config),_=this.streamController=new Wg(this,E,T);h.setStreamController(_),d.setStreamController(_);const S=[g,v,_];y&&S.splice(1,0,y),this.networkControllers=S;const w=[c,u,h,d,f,E];this.audioTrackController=this.createController(t.audioTrackController,S);const b=t.audioStreamController;b&&S.push(new b(this,E,T)),this.subtitleTrackController=this.createController(t.subtitleTrackController,S);const D=t.subtitleStreamController;D&&S.push(new D(this,E,T)),this.createController(t.timelineController,w),T.emeController=this.emeController=this.createController(t.emeController,w),this.cmcdController=this.createController(t.cmcdController,w),this.latencyController=this.createController(zh,w),this.coreComponents=w,S.push(l);const k=l.onErrorOut;typeof k=="function"&&this.on(p.ERROR,k,l)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(L.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=e===p.ERROR;this.trigger(p.ERROR,{type:$.OTHER_ERROR,details:C.INTERNAL_EXCEPTION,fatal:s,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){L.log("destroy"),this.trigger(p.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){L.log("attachMedia"),this._media=e,this.trigger(p.MEDIA_ATTACHING,{media:e})}detachMedia(){L.log("detachMedia"),this.trigger(p.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,s=this.url=Hs.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,L.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(p.MANIFEST_LOADING,{url:e})}startLoad(e=-1){L.log(`startLoad(${e})`),this.started=!0,this.networkControllers.forEach(t=>{t.startLoad(e)})}stopLoad(){L.log("stopLoad"),this.started=!1,this.networkControllers.forEach(e=>{e.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.stopLoad()})}swapAudioCodec(){L.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){L.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){L.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){L.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){L.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){L.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){L.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(L.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){qh(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e!=null&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const a=e[r].attrs["HDCP-LEVEL"];if(a&&a<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return(t=this.audioTrackController)==null?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return(t=this.subtitleTrackController)==null||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}ot.defaultConfig=void 0;const Yg=Object.freeze(Object.defineProperty({__proto__:null,AbrController:vo,AttrList:oe,AudioStreamController:jo,AudioTrackController:Xo,BasePlaylistController:Ii,BaseSegment:Ys,BaseStreamController:Oi,BufferController:tl,CMCDController:Pl,CapLevelController:Ki,ChunkMetadata:Pi,ContentSteeringController:kl,DateRange:Ws,EMEController:xt,ErrorActionFlags:Ie,ErrorController:go,ErrorDetails:C,ErrorTypes:$,Events:p,FPSController:xl,Fragment:pi,Hls:ot,HlsSkip:Ft,HlsUrlParameters:un,KeySystemFormats:xe,KeySystems:ae,Level:St,LevelDetails:xa,LevelKey:Pt,LoadStats:Zt,MetadataSchema:Re,NetworkErrorAction:fe,Part:La,PlaylistLevelType:B,SubtitleStreamController:Zo,SubtitleTrackController:Jo,TimelineController:El,default:ot,getMediaSource:Tt,isMSESupported:Vn,isSupported:Gl},Symbol.toStringTag,{value:"Module"}));A.AudioOnlyVideo=ur,A.AudioTrackData=ns,A.AudioVideoPlugin=hr,A.ButtonGroupPlugin=ta,A.ButtonPlugin=di,A.Canvas=ws,A.CanvasButtonPlugin=Nc,A.CanvasButtonPosition=re,A.CanvasPlugin=As,A.Captions=hs,A.CaptionsPlugin=us,A.CurrentTimeLabelPlugin=Ur,A.DFXPParser=Lr,A.Data=jr,A.DataPlugin=Fs,A.DefaultKeyShortcutsPlugin=Sr,A.DfxpManifestCaptionsPlugin=xr,A.DomClass=Ne,A.DualVideoDynamicLayoutPlugin=Ds,A.DualVideoLayoutPlugin=Hr,A.EventLogPlugin=Du,A.Events=F,A.HlsSupport=Te,A.HlsVideo=ls,A.HlsVideoFormatPlugin=fr,A.ImageVideo=mr,A.ImageVideoFormatPlugin=pr,A.KeyCodes=Le,A.KeyShortcutPlugin=Tr,A.LOG_LEVEL=ue,A.Loader=or,A.Log=ha,A.ManifestParser=ma,A.MenuButtonPlugin=ea,A.Mp4Video=yr,A.Mp4VideoFormatPlugin=vr,A.Paella=Gu,A.PlayPauseButtonPlugin=Fr,A.PlayerResource=ft,A.PlayerState=z,A.PlayerStateNames=Fe,A.Plugin=tt,A.PluginModule=Wt,A.PopUpButtonPlugin=Xr,A.SingleVideoLayoutPlugin=Wr,A.TripleVideoLayoutPlugin=Yr,A.UserInterfacePlugin=ui,A.Video=li,A.VideoCanvas=zr,A.VideoCanvasPlugin=qr,A.VideoContainerMessagePosition=Ee,A.VideoLayout=yt,A.VideoPlugin=gt,A.VideoQualityItem=mt,A.VttManifestCaptionsPlugin=Nr,A.WebVTTParser=Or,A.addDictionary=It,A.bindEvent=se,A.checkManifestIntegrity=sa,A.createElement=es,A.createElementWithHtmlText=X,A.defaultAddDictionaryFunction=ys,A.defaultGetCookieConsentCallback=$s,A.defaultGetCookieDescriptionCallback=Gs,A.defaultGetDefaultLanguageFunction=Es,A.defaultGetDictionariesFunction=vs,A.defaultGetLanguageFunction=ps,A.defaultGetManifestFileUrlFunction=rr,A.defaultGetManifestUrlFunction=nr,A.defaultGetVideoIdFunction=sr,A.defaultHlsConfig=rs,A.defaultLoadConfigFunction=ir,A.defaultLoadVideoManifestFunction=ar,A.defaultSetLanguageFunction=ms,A.defaultTranslateFunction=gs,A.getCurrentTabIndex=Cc,A.getDefaultLanguage=Ss,A.getDictionaries=Pr,A.getHlsSupport=ke,A.getLanguage=Dr,A.getNextTabIndex=Ls,A.getPluginsOfType=Us,A.getShortcuts=Er,A.importPlugins=ou,A.isVolumeApiAvailable=cr,A.loadPluginsOfType=we,A.log=nt,A.parseDFXP=ds,A.parseWebVTT=xs,A.setLanguage=Ts,A.translate=Rt,A.triggerEvent=J,A.triggerIfReady=ht,A.utils=Yl,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
